# Техническое задание: Агрегатор недвижимости (первичный рынок)

## 1. Описание проекта

Разработка веб-сервиса агрегатора для поиска и фильтрации объектов недвижимости на первичном рынке Санкт-Петербурга на основе XML-фидов в формате Yandex Realty Feed.

## 2. Анализ структуры данных XML-фида

### 2.1 Общая информация о фиде
- **Формат**: Yandex Realty Feed (xmlns: http://webmaster.yandex.ru/schemas/feed/realty/2010-06)
- **Объем данных**: ~12,020 объектов
- **Размер файла**: ~68 МБ
- **Дата генерации**: динамическая (`<generation-date>`)

### 2.2 Структура элемента `<offer>`

Каждое объявление содержит уникальный `internal-id` и следующую структуру данных:

#### 2.2.1 Базовая информация
```xml
<offer internal-id="уникальный_id">
  <type>продажа</type>                    <!-- Всегда "продажа" -->
  <property-type>жилая</property-type>     <!-- Всегда "жилая" -->
  <category>квартира</category>            <!-- Всегда "квартира" -->
  <creation-date>ISO 8601</creation-date>
  <last-update-date>ISO 8601</last-update-date>
  <manually-added>0/1</manually-added>
```

#### 2.2.2 Характеристики квартиры
```xml
<rooms>0-7</rooms>                        <!-- 0=студия, 1-7=количество комнат -->
<studio>1</studio>                        <!-- Флаг студии (опционально) -->
<new-flat>1</new-flat>                    <!-- Всегда 1 (первичка) -->
<floor>1-40</floor>                       <!-- Этаж -->
<floors-total>1-40</floors-total>         <!-- Всего этажей в доме -->
<balcony>есть/нет</balcony>
<bathroom-unit>совмещенный/2/раздельный</bathroom-unit>
<ceiling-height>число</ceiling-height>
<renovation>тип отделки</renovation>
```

**Типы отделки** (4 варианта):
- "Подготовка под чистовую отделку" (3,637 объектов - 30%)
- "Отделка под ключ" (3,307 объектов - 27%)
- "Чистовая отделка" (2,540 объектов - 21%)
- "Черновая отделка" (2,519 объектов - 21%)

**Распределение по комнатам**:
- Студии/0 комнат: 1,332 (11%)
- 1 комната: 6,512 (54%)
- 2 комнаты: 3,040 (25%)
- 3 комнаты: 1,036 (9%)
- 4+ комнаты: 100 (1%)

#### 2.2.3 Информация о здании
```xml
<building-name>Название ЖК</building-name>
<building-type>тип здания</building-type>
<building-state>состояние</building-state>
<building-phase>Очередь N</building-phase>
<building-section>Корпус N</building-section>
<built-year>YYYY</built-year>
<ready-quarter>1-4</ready-quarter>
<lift>0/1</lift>                          <!-- Наличие лифта -->
<parking>0/1</parking>                    <!-- Наличие парковки -->
```

**Типы зданий** (11 вариантов):
- кирпично-монолитный (7,051 - 59%)
- монолитный (2,040 - 17%)
- панельный (1,201 - 10%)
- монолитно-каркасный (1,174 - 10%)
- блочно-монолитный (245)
- блочный (113)
- кирпичный (93)
- панельно-блочный (73)
- каркасно-блочный (17)
- панельно-монолитный (7)
- каркасный (6)

**Состояния строительства** (2 варианта):
- `unfinished` - в процессе строительства (9,291 - 77%)
- `hand-over` - сдан (2,729 - 23%)

#### 2.2.4 Идентификаторы комплекса
```xml
<nmarket-complex-id>число</nmarket-complex-id>
<nmarket-building-id>число</nmarket-building-id>
```

#### 2.2.5 Местоположение
```xml
<location>
  <country>Россия</country>
  <region>Санкт-Петербург</region>
  <locality-name>Санкт-Петербург</locality-name>
  <sub-locality-name>Район</sub-locality-name>
  <non-admin-sub-locality>Район</non-admin-sub-locality>
  <address>Полный адрес</address>
  <apartment>номер квартиры</apartment>
  <latitude>координата</latitude>
  <longitude>координата</longitude>
  <metro>
    <name>Название станции</name>
    <time-on-foot>минуты</time-on-foot>
  </metro>
</location>
```

**Районы Санкт-Петербурга** (13 районов):
- Невский (940 объектов - 8%)
- Приморский (710 - 6%)
- Калининский (586 - 5%)
- Василеостровский (489 - 4%)
- Московский (486 - 4%)
- Фрунзенский (367 - 3%)
- Выборгский (221 - 2%)
- Центральный (194 - 2%)
- Красногвардейский (162 - 1%)
- Петроградский (134 - 1%)
- Кировский (122 - 1%)
- Адмиралтейский (112 - 1%)
- Красносельский (27)

**ТОП-15 ЖК по количеству объектов**:
1. Новатория (669)
2. Про.Молодость (660)
3. OKLA (450)
4. ЯСНО.Янино (449)
5. Энфилд (445)
6. RESPECT (416)
7. SERTOLOVO PARK (403)
8. Ассамблея (380)
9. Загляденье (376)
10. А101 Лаголово (321)
11. Рождественский квартал (284)
12. Pixel (276)
13. PLUS Пулковский (275)
14. Дубровский (262)
15. Дом на Курской (258)

#### 2.2.6 Площади
```xml
<area>
  <value>число</value>
  <unit>кв. м</unit>
</area>
<living-space>
  <value>число</value>
  <unit>кв. м</unit>
</living-space>
<kitchen-space>
  <value>число</value>
  <unit>кв. м</unit>
</kitchen-space>
```

#### 2.2.7 Цена
```xml
<price>
  <value>число</value>
  <currency>RUR</currency>
</price>
<mortgage>true/false</mortgage>
<haggle>true/false</haggle>
```

#### 2.2.8 Изображения
```xml
<image tag="plan">URL</image>           <!-- План квартиры (12,007 объектов) -->
<image tag="housemain">URL</image>      <!-- Главное фото дома (12,020 объектов) -->
<image tag="floorplan">URL</image>      <!-- План этажа (11,761 объектов) -->
<image tag="complexscheme">URL</image>  <!-- Схема комплекса (1,902 объекта) -->
<image>URL</image>                      <!-- Дополнительные фото без тега -->
```

#### 2.2.9 Агент по продажам
```xml
<sales-agent>
  <phone>+7XXXXXXXXXX</phone>
  <organization>название</organization>
  <email>email@example.com</email>
  <category>agency</category>
</sales-agent>
```

#### 2.2.10 Описание
```xml
<description>Подробное текстовое описание объекта</description>
```

---

## 3. Функциональные требования к агрегатору

### 3.1 Импорт и обработка данных

#### 3.1.1 Парсинг XML-фидов
- Регулярная загрузка и парсинг XML-фидов
- Обработка больших файлов (до 100 МБ)
- Валидация данных по схеме Yandex Realty Feed
- Обработка ошибок и некорректных данных
- Инкрементальные обновления (по `last-update-date`)

#### 3.1.2 Нормализация данных
- Приведение цен к единому формату
- Нормализация адресов
- Обработка координат (latitude/longitude)
- Валидация и очистка телефонных номеров
- Обработка изображений (проверка доступности URL)

#### 3.1.3 Расчет дополнительных метрик
- Цена за квадратный метр (общая площадь)
- Цена за квадратный метр (жилая площадь)
- Процент жилой площади от общей
- Процент кухни от общей площади
- Классификация квартир по сегментам (эконом, комфорт, бизнес, элит)

### 3.2 База данных

#### 3.2.1 Основные сущности
- **Offers** - объявления о продаже
- **Buildings** - корпуса домов
- **Complexes** - жилые комплексы
- **Developers** - застройщики
- **Metro_Stations** - станции метро
- **Districts** - районы города
- **Images** - изображения объектов
- **Sales_Agents** - агенты по продажам

#### 3.2.2 Индексация
- Полнотекстовый поиск по описанию
- Географические индексы (latitude, longitude)
- Составные индексы для фильтрации
- Индексы по датам обновления

### 3.3 API

#### 3.3.1 Поиск и фильтрация объектов
**GET /api/offers**

Параметры фильтрации:
- `rooms[]` - количество комнат (0,1,2,3,4+)
- `studio` - только студии (boolean)
- `price_min`, `price_max` - диапазон цены
- `price_per_sqm_min`, `price_per_sqm_max` - цена за м²
- `area_min`, `area_max` - общая площадь
- `living_area_min`, `living_area_max` - жилая площадь
- `kitchen_area_min`, `kitchen_area_max` - площадь кухни
- `floor_min`, `floor_max` - этаж
- `floors_total_min`, `floors_total_max` - этажность дома
- `not_first_floor` - не первый этаж (boolean)
- `not_last_floor` - не последний этаж (boolean)
- `districts[]` - районы города
- `metro_stations[]` - станции метро
- `metro_time_max` - максимальное время до метро (минуты)
- `building_types[]` - типы зданий
- `building_states[]` - состояние строительства (unfinished/hand-over)
- `ready_year_min`, `ready_year_max` - год сдачи
- `ready_quarter` - квартал сдачи (1-4)
- `renovation[]` - тип отделки
- `has_lift` - наличие лифта (boolean)
- `has_parking` - наличие парковки (boolean)
- `has_balcony` - наличие балкона (boolean)
- `mortgage` - возможность ипотеки (boolean)
- `complex_ids[]` - ID жилых комплексов
- `building_name` - название ЖК (полнотекстовый поиск)
- `sort` - сортировка (price_asc, price_desc, area_asc, area_desc, price_per_sqm, created_date)
- `page`, `per_page` - пагинация

Ответ:
```json
{
  "data": [...],
  "meta": {
    "total": 12020,
    "page": 1,
    "per_page": 20,
    "total_pages": 601
  },
  "filters": {
    "price_range": {"min": 3000000, "max": 150000000},
    "area_range": {"min": 20, "max": 150},
    "available_districts": [...],
    "available_metro": [...],
    "available_complexes": [...]
  }
}
```

#### 3.3.2 Детальная информация об объекте
**GET /api/offers/:id**

Ответ:
```json
{
  "id": "1458634",
  "type": "продажа",
  "category": "квартира",
  "rooms": 2,
  "floor": 10,
  "floors_total": 11,
  "area": 66.30,
  "living_area": 38.58,
  "kitchen_area": 12.33,
  "price": 20336957,
  "price_per_sqm": 306823,
  "renovation": "Отделка под ключ",
  "building": {
    "name": "NEXT",
    "type": "монолитный",
    "state": "hand-over",
    "phase": "Очередь 1",
    "section": "Корпус 1",
    "built_year": 2020,
    "ready_quarter": 3,
    "has_lift": true,
    "has_parking": true
  },
  "location": {
    "address": "Средний В.О. пр., д. 87/3/1",
    "apartment": "413",
    "district": "Василеостровский",
    "coordinates": {
      "lat": 59.9382061026,
      "lng": 30.2486448592
    },
    "metro": {
      "name": "Горный Институт",
      "time_on_foot": 13
    }
  },
  "images": {
    "plan": "URL",
    "housemain": "URL",
    "floorplan": "URL",
    "additional": ["URL1", "URL2"]
  },
  "sales_agent": {
    "phone": "+79817196494",
    "organization": "spb-invest-xml77.allrealty.pro",
    "email": "titworking@mail.ru"
  },
  "description": "...",
  "features": {
    "balcony": "нет",
    "bathroom_unit": "совмещенный",
    "mortgage": true,
    "haggle": false
  },
  "dates": {
    "created": "2017-09-15T10:31:37+00:00",
    "updated": "2025-02-28T13:53:00+00:00"
  }
}
```

#### 3.3.3 Список жилых комплексов
**GET /api/complexes**

Параметры:
- `district` - район
- `building_state` - состояние
- `search` - поиск по названию
- `sort` - сортировка (name, offers_count, min_price)

Ответ:
```json
{
  "data": [
    {
      "id": 47106,
      "name": "NEXT",
      "district": "Василеостровский",
      "address": "Средний В.О. пр., д. 87/3/1",
      "coordinates": {"lat": 59.9382061026, "lng": 30.2486448592},
      "metro": {
        "name": "Горный Институт",
        "time_on_foot": 13
      },
      "statistics": {
        "total_offers": 432,
        "min_price": 12195652,
        "max_price": 23586957,
        "avg_price_per_sqm": 324500,
        "available_rooms": [0, 1, 2],
        "buildings_count": 3
      },
      "image": "URL"
    }
  ]
}
```

#### 3.3.4 Аналитика и статистика
**GET /api/analytics/price-trends**

Параметры:
- `district` - район
- `complex_id` - ID комплекса
- `rooms` - количество комнат
- `period` - период (month, quarter, year)

**GET /api/analytics/market-overview**

Ответ:
```json
{
  "total_offers": 12020,
  "avg_price": 15500000,
  "avg_price_per_sqm": 185000,
  "by_rooms": {
    "0": {"count": 1332, "avg_price": 8500000},
    "1": {"count": 6512, "avg_price": 12000000},
    "2": {"count": 3040, "avg_price": 18000000},
    "3": {"count": 1036, "avg_price": 25000000}
  },
  "by_district": {...},
  "by_building_state": {
    "unfinished": {"count": 9291, "avg_price": 14000000},
    "hand-over": {"count": 2729, "avg_price": 19000000}
  }
}
```

### 3.4 Пользовательский интерфейс

#### 3.4.1 Главная страница поиска
- Форма с основными фильтрами:
  - Количество комнат (чипы: Студия, 1, 2, 3, 4+)
  - Диапазон цены (слайдер + инпуты)
  - Район (мультиселект с поиском)
  - Метро (мультиселект с поиском + время до метро)
  - Площадь (слайдер)
  - Этаж (слайдер + чекбоксы "не первый", "не последний")

- Расширенные фильтры (скрываемая панель):
  - Тип здания
  - Состояние строительства
  - Год и квартал сдачи
  - Тип отделки
  - Наличие лифта/парковки/балкона
  - Возможность ипотеки
  - Санузел
  - Высота потолков

- Результаты поиска:
  - Список карточек объектов (плитка/список)
  - Карта с объектами
  - Сортировка
  - Пагинация/бесконечная прокрутка
  - Счетчик найденных объектов
  - Сохранение поиска
  - Сравнение объектов

#### 3.4.2 Карточка объекта
- Галерея изображений:
  - План квартиры
  - Фото дома
  - План этажа
  - Схема комплекса
  - Дополнительные фото

- Основная информация:
  - Цена и цена за м²
  - Характеристики квартиры
  - Адрес и метро
  - Информация о доме и ЖК
  - Срок сдачи
  - Тип отделки

- Блок с описанием
- Карта с местоположением
- Контакты застройщика/агента
- Кнопки действий:
  - Позвонить
  - Записаться на просмотр
  - Избранное
  - Поделиться
  - Добавить к сравнению

#### 3.4.3 Страница ЖК
- Описание комплекса
- Галерея изображений
- Характеристики комплекса
- Список доступных квартир
- Фильтрация по корпусам/очередям
- Расположение на карте
- Инфраструктура района
- Контакты застройщика

#### 3.4.4 Карта объектов
- Интерактивная карта (Yandex Maps / 2GIS)
- Кластеризация объектов
- Фильтры на карте
- Попапы с кратким описанием
- Рисование областей поиска
- Отображение метро, школ, парков

#### 3.4.5 Сравнение объектов
- Добавление до 5 объектов
- Таблица сравнения характеристик
- Выделение отличий
- Расчет разницы в цене
- Сравнение на карте

#### 3.4.6 Избранное
- Список сохраненных объектов
- Заметки к объектам
- Теги/группировка
- Отслеживание изменений цены
- Email-уведомления

### 3.5 Дополнительные функции

#### 3.5.1 Рекомендации
- Похожие объекты
- Альтернативы (дешевле/дороже)
- "Популярное в вашем районе"

#### 3.5.2 Калькуляторы
- Ипотечный калькулятор
- Калькулятор коммунальных платежей
- Расчет стоимости отделки

#### 3.5.3 Подписки и уведомления
- Подписка на новые объекты по фильтрам
- Уведомления об изменении цены
- Уведомления о новых объектах в ЖК
- Email/Telegram уведомления

#### 3.5.4 Аналитика для пользователей
- Динамика цен в районе
- Средняя цена по параметрам
- Рекомендации "лучшая цена"
- Тренды рынка

---

## 4. Технический стек (рекомендации)

### 4.1 Backend
- **Язык**: Node.js / Python / Go
- **Framework**: Express/NestJS / FastAPI/Django / Gin
- **База данных**: PostgreSQL (с PostGIS для геоданных)
- **Кэширование**: Redis
- **Поисковый движок**: Elasticsearch (для полнотекстового поиска)
- **Парсинг XML**: libxml2 / xml2js / xml.etree

### 4.2 Frontend
- **Framework**: React / Vue.js / Next.js
- **UI библиотека**: Material-UI / Ant Design / Chakra UI
- **Карты**: Yandex Maps API / 2GIS API
- **State management**: Redux / Zustand / Pinia
- **Графики**: Recharts / Chart.js

### 4.3 DevOps
- **Контейнеризация**: Docker
- **Оркестрация**: Kubernetes / Docker Compose
- **CI/CD**: GitHub Actions / GitLab CI
- **Мониторинг**: Prometheus + Grafana
- **Логирование**: ELK Stack

### 4.4 Интеграции
- **Карты**: Yandex Maps API, 2GIS API
- **SMS/Email**: Twilio, SendGrid, SMTP
- **Telegram Bot API**: для уведомлений
- **Облачное хранилище**: S3/MinIO для изображений (кэширование)

---

## 5. Нефункциональные требования

### 5.1 Производительность
- Время ответа API: < 200ms (p95)
- Время загрузки главной страницы: < 2s
- Обработка фида: < 5 минут для 100 МБ
- Поддержка до 1000 одновременных пользователей

### 5.2 Масштабируемость
- Возможность обработки до 100,000 объектов
- Горизонтальное масштабирование API
- Кэширование часто запрашиваемых данных

### 5.3 Безопасность
- HTTPS для всех запросов
- Rate limiting API
- Защита от SQL-инъекций
- Валидация всех входных данных
- Защита контактных данных

### 5.4 Доступность
- Uptime 99.5%
- Резервное копирование БД (ежедневно)
- Graceful degradation при недоступности внешних сервисов

### 5.5 SEO
- Server-side rendering (SSR)
- Семантическая разметка
- Open Graph теги
- Sitemap.xml
- Robots.txt

---

## 6. Этапы разработки

### Этап 1: MVP (Минимально жизнеспособный продукт)
1. Парсер XML-фидов
2. База данных с основными сущностями
3. API для поиска и фильтрации
4. Простой UI с основными фильтрами
5. Карточка объекта
6. Карта объектов

### Этап 2: Базовая функциональность
7. Расширенные фильтры
8. Страницы ЖК
9. Сравнение объектов
10. Избранное
11. Адаптивная версия

### Этап 3: Дополнительные функции
12. Калькуляторы
13. Рекомендации
14. Подписки и уведомления
15. Аналитика

### Этап 4: Оптимизация и масштабирование
16. Кэширование
17. Оптимизация запросов
18. SEO-оптимизация
19. Мониторинг и метрики

---

## 7. Метрики успеха

### 7.1 Технические метрики
- Время обработки фида
- Скорость поиска (< 200ms)
- Процент успешных парсингов (> 99%)
- Покрытие тестами (> 80%)

### 7.2 Пользовательские метрики
- Конверсия в звонок/заявку
- Время на сайте
- Количество просмотренных объектов
- Процент возвратов
- Количество сохраненных поисков

---

## 8. Риски и ограничения

### 8.1 Технические риски
- Изменение формата XML-фида
- Недоступность изображений по URL
- Некорректные/неполные данные в фиде
- Производительность при больших объемах данных

### 8.2 Бизнес-риски
- Зависимость от поставщика фидов
- Актуальность данных
- Конкуренция с крупными порталами

### 8.3 Митигация
- Версионирование парсера
- Локальное кэширование изображений
- Валидация и очистка данных
- Мониторинг и алерты
- Регулярное обновление фидов

---

## 9. Документация

### 9.1 Техническая документация
- API спецификация (OpenAPI/Swagger)
- Схема базы данных
- Архитектура системы
- Руководство по развертыванию

### 9.2 Пользовательская документация
- Справка по использованию
- FAQ
- Видео-инструкции

---

## 10. Контакты и поддержка

- Техническая поддержка
- Обратная связь от пользователей
- Система тикетов
- Email поддержка

---

**Дата создания ТЗ**: 2025-11-29
**Версия**: 1.0
