# QA Testing Guide — Housler Новостройки

**Версия:** 1.2
**Дата:** 03.12.2025
**Окружение:** https://agent.housler.ru
**Последнее тестирование:** 03.12.2025

---

## 0. Статус исправлений (QA Report 02.12.2025)

| ID | Проблема | Статус | Дата исправления |
|----|----------|--------|------------------|
| BUG-001 | Публичная подборка `/s/test-demo-2024` → 500 | ✅ **Исправлено** | 02.12.2025 |
| BUG-002 | Пустые карточки на странице агента `/selections/:id` | ✅ **Исправлено** | 02.12.2025 |
| BUG-003 | Ссылка в хедере ведёт на неправильный URL | ✅ **Код корректен** | — |
| BUG-004 | Страница /favorites падает | ✅ **Не воспроизводится** | 03.12.2025 |
| UX-001 | Подсказка в форме бронирования | ✅ **Работает** | — |
| UX-002 | Плейсхолдер на странице логина | ✅ **Исправлено** | 02.12.2025 |
| FIX-001 | Унификация полей API /favorites | ✅ **Исправлено** | 03.12.2025 |

### Результаты API-тестирования (02.12.2025):
```
GET /api/selections/shared/test-demo-2024 → 200 OK (5 items)
GET /api/offers?limit=2 → 200 OK
POST /api/auth/verify-code (client) → 200 OK + JWT token
GET / → 200 OK
```

---

## 1. Тестовые аккаунты

### 1.1 Клиент (client)
| Поле | Значение |
|------|----------|
| Email | `client@test.housler.ru` |
| Код | `111111` |
| Роль | `client` |
| Назначение | Тестирование клиентского функционала: избранное, просмотр подборок, профиль |

### 1.2 Агент (agent)
| Поле | Значение |
|------|----------|
| Email | `agent@test.housler.ru` |
| Код | `333333` |
| Роль | `agent` |
| Назначение | Тестирование функционала агента: создание подборок, CRM клиентов, аналитика |

### 1.3 Администратор (admin)
| Поле | Значение |
|------|----------|
| Email | `admin@test.housler.ru` |
| Код | `555555` |
| Роль | `admin` |
| Назначение | Полный доступ ко всем функциям |

> **Примечание:** Для тестовых аккаунтов `@test.housler.ru` используются постоянные коды. На странице логина появляется кнопка "У меня есть постоянный код" при вводе такого email.

> **ВАЖНО:** Все тестовые аккаунты (client, agent, admin) используют **форму `/login/client`** для входа через email. Форма `/login/realtor` предназначена для входа по номеру телефона и НЕ подходит для тестовых аккаунтов.

---

## 2. Критические сценарии (Smoke Test)

### 2.1 Авторизация

#### TC-AUTH-001: Вход клиента
| Параметр | Значение |
|----------|----------|
| Приоритет | Critical |
| Предусловие | Неавторизованный пользователь |

**Шаги:**
1. Открыть https://agent.housler.ru/login
2. Ввести email: `client@test.housler.ru`
3. Нажать "Получить код"
4. Нажать "У меня есть постоянный код"
5. Ввести код: `111111`
6. Нажать "Войти"

**Ожидаемый результат:**
- Редирект на главную страницу
- В header появляется аватар с именем/email
- Появляется пункт "Избранное"
- Профиль `/profile` показывает данные пользователя

**Проверка:**
- Network: POST `/api/auth/verify-code` → 200
- localStorage содержит `token`

---

#### TC-AUTH-002: Вход агента
| Параметр | Значение |
|----------|----------|
| Приоритет | Critical |
| Предусловие | Неавторизованный пользователь |

**Шаги:**
1. Открыть https://agent.housler.ru/login
2. Выбрать роль **"Клиент"** (используем форму `/login/client` для тестовых аккаунтов)
3. Ввести email: `agent@test.housler.ru`
4. Нажать "У меня есть постоянный код"
5. Ввести код: `333333`
6. Нажать "Войти"

**Ожидаемый результат:**
- В header появляются пункты: "Подборки", "Клиенты"
- Доступ к `/selections` и `/clients`

> **Примечание:** Несмотря на то, что это агентский аккаунт, для входа используется форма клиента, т.к. форма риелтора требует телефон, а не email.

---

#### TC-AUTH-003: Выход из аккаунта
| Параметр | Значение |
|----------|----------|
| Приоритет | High |
| Предусловие | Авторизованный пользователь |

**Шаги:**
1. Перейти в профиль `/profile`
2. Нажать "Выйти"

**Ожидаемый результат:**
- Редирект на главную
- Header возвращается к гостевому виду
- localStorage очищен от token

---

### 2.2 Публичная подборка (BUG-001 regression)

#### TC-SEL-001: Просмотр публичной подборки гостем
| Параметр | Значение |
|----------|----------|
| Приоритет | Critical |
| Предусловие | Неавторизованный пользователь |
| Тестовые данные | share_code: `test-demo-2024` |

**Шаги:**
1. Открыть https://agent.housler.ru/s/test-demo-2024

**Ожидаемый результат:**
- Страница загружается без ошибки (НЕ "Что-то пошло не так")
- Отображается название подборки
- Отображаются карточки квартир с:
  - Фото (или placeholder "Нет фото")
  - Цена (формат: "10.9 млн ₽")
  - Площадь, комнаты, этаж
  - Название ЖК
  - Район и метро

**Проверка в DevTools:**
- Network: GET `/api/selections/shared/test-demo-2024` → 200
- Response содержит `items[]` с полями: `price`, `area_total`, `rooms`, `complex_name`
- Console: нет ошибок

---

#### TC-SEL-002: Просмотр публичной подборки клиентом
| Параметр | Значение |
|----------|----------|
| Приоритет | Critical |
| Предусловие | Авторизован как `client@test.housler.ru` |

**Шаги:**
1. Перейти в профиль `/profile`
2. В разделе "Подборки от агентов" кликнуть на подборку
3. Или напрямую открыть `/s/test-demo-2024`

**Ожидаемый результат:**
- Страница загружается
- Карточки содержат кнопку добавления в подборку
- Можно кликнуть на карточку и перейти к детальной странице оффера

---

#### TC-SEL-003: Публичная подборка — недоступный объект
| Параметр | Значение |
|----------|----------|
| Приоритет | High |
| Предусловие | В подборке есть оффер, который был удалён/деактивирован |

**Ожидаемый результат:**
- Страница НЕ падает с ошибкой
- Недоступный объект показывает placeholder:
  - Иконка "перечёркнутый круг"
  - Текст "Объект недоступен" или "Этот объект был снят с продажи"
- Остальные объекты отображаются корректно

---

### 2.3 Подборка агента (BUG-002 regression)

#### TC-SEL-004: Просмотр подборки агентом
| Параметр | Значение |
|----------|----------|
| Приоритет | Critical |
| Предусловие | Авторизован как `agent@test.housler.ru` |

**Шаги:**
1. Перейти в "Подборки" (`/selections`)
2. Найти "Тестовая подборка" (или любую существующую)
3. Нажать "Открыть"

**Ожидаемый результат:**
- Страница `/selections/{id}` загружается
- Карточки квартир содержат:
  - Фото (или "Нет фото")
  - Цена
  - Площадь, комнаты, этаж
  - Название ЖК
  - Район и метро
  - Статус ("Ожидает", "Показан", и т.д.)
  - Кнопка "Удалить"
- Счётчик просмотров отображается
- Кнопка "Поделиться" работает

**Проверка в DevTools:**
- Network: GET `/api/selections/{id}` → 200
- Response: `items[].offer` содержит `price`, `area_total`, `complex_name`
- Или `items[]` содержит плоские поля напрямую

---

#### TC-SEL-005: Удаление объекта из подборки
| Параметр | Значение |
|----------|----------|
| Приоритет | High |
| Предусловие | Авторизован как агент, открыта подборка с объектами |

**Шаги:**
1. На странице подборки найти карточку объекта
2. Нажать "Удалить"

**Ожидаемый результат:**
- Карточка исчезает из списка
- Счётчик объектов уменьшается
- При обновлении страницы объект не появляется

**Проверка:**
- Network: DELETE `/api/selections/{id}/items/{offerId}` → 200

---

#### TC-SEL-006: Создание новой подборки
| Параметр | Значение |
|----------|----------|
| Приоритет | High |
| Предусловие | Авторизован как агент |

**Шаги:**
1. Перейти в "Подборки" (`/selections`)
2. Нажать "Создать подборку"
3. Ввести название, опционально — имя и email клиента
4. Сохранить

**Ожидаемый результат:**
- Подборка появляется в списке
- Генерируется уникальный share_code
- Можно добавлять объекты из каталога

---

### 2.4 Каталог и фильтры

#### TC-CAT-001: Открытие каталога
| Параметр | Значение |
|----------|----------|
| Приоритет | Critical |
| Предусловие | — |

**Шаги:**
1. Открыть https://agent.housler.ru/offers

**Ожидаемый результат:**
- Загружается список квартир (ожидается 12000+ объектов)
- Отображается пагинация
- Карточки содержат: фото, цену, площадь, ЖК, район

---

#### TC-CAT-002: Фильтрация по комнатности
| Параметр | Значение |
|----------|----------|
| Приоритет | High |

**Шаги:**
1. На странице каталога выбрать фильтр "2 комнаты"
2. Применить

**Ожидаемый результат:**
- В выдаче только 2-комнатные квартиры
- Счётчик результатов обновился
- URL содержит параметр `rooms=2`

---

#### TC-CAT-003: Фильтрация по цене
| Параметр | Значение |
|----------|----------|
| Приоритет | High |

**Шаги:**
1. Установить диапазон цен: от 5 млн до 10 млн
2. Применить фильтры

**Ожидаемый результат:**
- Все квартиры в выдаче в указанном диапазоне
- URL содержит `price_min=5000000&price_max=10000000`

---

### 2.5 Избранное

#### TC-FAV-001: Добавление в избранное
| Параметр | Значение |
|----------|----------|
| Приоритет | High |
| Предусловие | Авторизован как клиент |

**Шаги:**
1. Открыть каталог `/offers`
2. Навести на карточку квартиры
3. Кликнуть на иконку сердечка

**Ожидаемый результат:**
- Иконка меняет состояние (заполняется)
- Счётчик в header "Избранное" увеличивается
- На странице `/favorites` появляется объект

---

#### TC-FAV-002: Удаление из избранного
| Параметр | Значение |
|----------|----------|
| Приоритет | High |
| Предусловие | Есть объект в избранном |

**Шаги:**
1. Открыть `/favorites`
2. Кликнуть на иконку сердечка у объекта

**Ожидаемый результат:**
- Объект исчезает из списка
- Счётчик в header уменьшается

---

### 2.6 CRM Клиенты (для агента)

#### TC-CRM-001: Просмотр воронки клиентов
| Параметр | Значение |
|----------|----------|
| Приоритет | High |
| Предусловие | Авторизован как агент |

**Шаги:**
1. Перейти в "Клиенты" (`/clients`)

**Ожидаемый результат:**
- Отображается воронка продаж с этапами
- Показываются счётчики по каждому этапу
- Список клиентов (если есть) или пустое состояние

---

#### TC-CRM-002: Создание клиента
| Параметр | Значение |
|----------|----------|
| Приоритет | High |
| Предусловие | Авторизован как агент |

**Шаги:**
1. На странице `/clients` нажать "+ Добавить клиента"
2. Заполнить имя, телефон, email
3. Сохранить

**Ожидаемый результат:**
- Клиент появляется в списке
- Этап по умолчанию: "Новый"

---

## 3. Навигация и UI

#### TC-NAV-001: Переход по ссылкам header
| Параметр | Значение |
|----------|----------|
| Приоритет | Medium |

**Проверить все ссылки в header:**
| Ссылка | Ожидаемый URL |
|--------|---------------|
| HOUSLER (лого) | `/` |
| Квартиры | `/offers` |
| Жилые комплексы | `/complexes` |
| Карта | `/map` |
| Избранное (auth) | `/favorites` |
| Подборки (agent) | `/selections` |
| Клиенты (agent) | `/clients` |
| Аватар (auth) | `/profile` |
| Войти (guest) | `/login` |

**Ожидаемый результат:**
- Все ссылки ведут на правильные страницы
- Нет ошибок ERR_NAME_NOT_RESOLVED
- Нет редиректов на внешние домены

---

#### TC-NAV-002: Мобильное меню
| Параметр | Значение |
|----------|----------|
| Приоритет | Medium |
| Предусловие | Ширина экрана < 768px |

**Шаги:**
1. Открыть сайт на мобильном или в DevTools (responsive mode)
2. Нажать на бургер-меню

**Ожидаемый результат:**
- Меню раскрывается
- Все пункты навигации доступны
- Меню закрывается при клике на пункт

---

## 4. Форма бронирования

#### TC-BOOK-001: Форма для неавторизованного
| Параметр | Значение |
|----------|----------|
| Приоритет | Medium |
| Предусловие | Неавторизованный пользователь |

**Шаги:**
1. Открыть детальную страницу квартиры `/offers/{id}`
2. Найти форму бронирования

**Ожидаемый результат:**
- Форма заблюрена
- Отображается overlay с текстом "Войдите, чтобы оставить заявку на просмотр"
- Кнопка "Войти" ведёт на `/login`

---

#### TC-BOOK-002: Отправка заявки
| Параметр | Значение |
|----------|----------|
| Приоритет | High |
| Предусловие | Авторизован как клиент |

**Шаги:**
1. Открыть детальную страницу квартиры
2. Раскрыть форму "Оставить заявку на просмотр"
3. Заполнить имя, телефон
4. Нажать "Отправить заявку"

**Ожидаемый результат:**
- Появляется сообщение "Заявка отправлена!"
- Network: POST `/api/bookings` → 201

---

## 5. Детальные страницы

#### TC-DET-001: Карточка квартиры
| Параметр | Значение |
|----------|----------|
| Приоритет | High |

**Шаги:**
1. Из каталога кликнуть на любую квартиру

**Ожидаемый результат:**
- Загружается страница `/offers/{id}`
- Отображаются:
  - Галерея фото
  - Цена
  - Характеристики (площадь, комнаты, этаж, и т.д.)
  - Описание
  - ЖК и застройщик
  - Карта (если есть координаты)
  - Форма бронирования

---

#### TC-DET-002: Карточка ЖК
| Параметр | Значение |
|----------|----------|
| Приоритет | Medium |

**Шаги:**
1. Перейти в "Жилые комплексы" `/complexes`
2. Кликнуть на любой ЖК

**Ожидаемый результат:**
- Загружается страница `/complexes/{id}`
- Отображаются: название, адрес, застройщик, описание
- Список квартир в этом ЖК

---

## 6. API проверки (для технического QA)

### 6.1 Проверка API подборок

```bash
# Публичная подборка
curl -s "https://agent.housler.ru/api/selections/shared/test-demo-2024" | jq '.success, .data.items | length'
# Ожидается: true, число > 0

# Проверка структуры item
curl -s "https://agent.housler.ru/api/selections/shared/test-demo-2024" | jq '.data.items[0] | keys'
# Должны быть: price, area_total, rooms, complex_name, main_image, offer
```

### 6.2 Проверка авторизации

```bash
# Запрос кода
curl -X POST "https://agent.housler.ru/api/auth/request-code" \
  -H "Content-Type: application/json" \
  -d '{"email":"client@test.housler.ru"}'

# Верификация (тестовый аккаунт)
curl -X POST "https://agent.housler.ru/api/auth/verify-code" \
  -H "Content-Type: application/json" \
  -d '{"email":"client@test.housler.ru","code":"111111"}'
# Ожидается: {"success":true,"data":{"token":"...","user":{...}}}
```

### 6.3 Проверка избранного

```bash
TOKEN="<token_from_auth>"

# Список избранного
curl -s "https://agent.housler.ru/api/favorites" \
  -H "Authorization: Bearer $TOKEN" | jq '.success'

# Добавить в избранное
curl -X POST "https://agent.housler.ru/api/favorites/12020" \
  -H "Authorization: Bearer $TOKEN"
```

---

## 7. Известные ограничения

1. **Тестовые аккаунты** — только для `@test.housler.ru`, постоянные коды
2. **Карта** — требует Яндекс API ключ, может не работать локально
3. **PDF генерация** — требует puppeteer/chrome, может быть медленной
4. **Миграции** — на новой БД требуется прогнать все миграции из `database/migrations/`

---

## 8. Чеклист перед релизом

- [ ] Smoke test всех критических сценариев (TC-AUTH, TC-SEL, TC-CAT)
- [ ] Проверка под всеми ролями (guest, client, agent)
- [ ] Проверка на мобильном разрешении
- [ ] Network tab: нет 5xx ошибок
- [ ] Console: нет критических ошибок JS
- [ ] Regression: ранее исправленные баги не воспроизводятся

---

## 9. Контакты

| Роль | Контакт |
|------|---------|
| QA | @housler_spb |
| Dev | — |
| Email | hello@housler.ru |
