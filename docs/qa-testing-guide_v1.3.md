# QA Testing Guide — Housler Новостройки

**Версия:** 1.3
**Дата:** 03.12.2025
**Окружение:** https://agent.housler.ru
**Последнее тестирование:** 03.12.2025

---

## Changelog

### v1.3 (03.12.2025)
- Добавлен FIX-002: IPv6 rate limiter warning исправлен
- Обновлён статус всех исправлений
- Добавлена секция "Проверка логов на ошибки"

### v1.2 (03.12.2025)
- Добавлен FIX-001: Унификация полей API /favorites
- Обновлена документация по тестовым аккаунтам

### v1.1 (02.12.2025)
- Исправлены BUG-001, BUG-002

---

## 0. Статус исправлений

| ID | Проблема | Статус | Дата |
|----|----------|--------|------|
| BUG-001 | Публичная подборка `/s/test-demo-2024` → 500 | ✅ Исправлено | 02.12.2025 |
| BUG-002 | Пустые карточки на странице агента `/selections/:id` | ✅ Исправлено | 02.12.2025 |
| BUG-003 | Ссылка в хедере ведёт на неправильный URL | ✅ Код корректен | — |
| BUG-004 | Страница /favorites падает | ✅ Исправлено | 03.12.2025 |
| FIX-001 | Унификация полей API /favorites | ✅ Исправлено | 03.12.2025 |
| FIX-002 | IPv6 rate limiter warning | ✅ Исправлено | 03.12.2025 |
| UX-001 | Подсказка в форме бронирования | ✅ Работает | — |
| UX-002 | Плейсхолдер на странице логина | ✅ Исправлено | 02.12.2025 |

### Проверка логов на ошибки:
```bash
# Должно быть чисто (без ERR_ERL_KEY_GEN_IPV6 и других ошибок):
ssh housler-server "docker logs agent-backend --tail 20 2>&1"

# Ожидаемый вывод:
# {"level":"info","message":"Database connection successful",...}
# {"level":"info","message":"Server running on http://localhost:3001",...}
```

---

## 1. Тестовые аккаунты

### 1.1 Клиент (client)
| Поле | Значение |
|------|----------|
| Email | `client@test.housler.ru` |
| Код | `111111` |
| Роль | `client` |
| Назначение | Тестирование клиентского функционала: избранное, просмотр подборок, профиль |

### 1.2 Агент (agent)
| Поле | Значение |
|------|----------|
| Email | `agent@test.housler.ru` |
| Код | `333333` |
| Роль | `agent` |
| Назначение | Тестирование функционала агента: создание подборок, CRM клиентов, аналитика |

### 1.3 Администратор (admin)
| Поле | Значение |
|------|----------|
| Email | `admin@test.housler.ru` |
| Код | `555555` |
| Роль | `admin` |
| Назначение | Полный доступ ко всем функциям |

> **Примечание:** Для тестовых аккаунтов `@test.housler.ru` используются постоянные коды. На странице логина появляется кнопка "У меня есть постоянный код" при вводе такого email.

> **ВАЖНО:** Все тестовые аккаунты (client, agent, admin) используют **форму `/login/client`** для входа через email. Форма `/login/realtor` предназначена для входа по номеру телефона и НЕ подходит для тестовых аккаунтов.

---

## 2. Критические сценарии (Smoke Test)

### 2.1 Авторизация

#### TC-AUTH-001: Вход клиента
| Параметр | Значение |
|----------|----------|
| Приоритет | Critical |
| Предусловие | Неавторизованный пользователь |

**Шаги:**
1. Открыть https://agent.housler.ru/login
2. Ввести email: `client@test.housler.ru`
3. Нажать "Получить код"
4. Нажать "У меня есть постоянный код"
5. Ввести код: `111111`
6. Нажать "Войти"

**Ожидаемый результат:**
- Редирект на главную страницу
- В header появляется аватар с именем/email
- Появляется пункт "Избранное"
- Профиль `/profile` показывает данные пользователя

**Проверка:**
- Network: POST `/api/auth/verify-code` → 200
- localStorage содержит `token`

---

#### TC-AUTH-002: Вход агента
| Параметр | Значение |
|----------|----------|
| Приоритет | Critical |
| Предусловие | Неавторизованный пользователь |

**Шаги:**
1. Открыть https://agent.housler.ru/login
2. Выбрать роль **"Клиент"** (используем форму `/login/client` для тестовых аккаунтов)
3. Ввести email: `agent@test.housler.ru`
4. Нажать "У меня есть постоянный код"
5. Ввести код: `333333`
6. Нажать "Войти"

**Ожидаемый результат:**
- В header появляются пункты: "Подборки", "Клиенты"
- Доступ к `/selections` и `/clients`

> **Примечание:** Несмотря на то, что это агентский аккаунт, для входа используется форма клиента, т.к. форма риелтора требует телефон, а не email.

---

### 2.2 Избранное (FIX-001 regression)

#### TC-FAV-001: Просмотр избранного
| Параметр | Значение |
|----------|----------|
| Приоритет | Critical |
| Предусловие | Авторизован как клиент, есть объекты в избранном |

**Шаги:**
1. Открыть https://agent.housler.ru/favorites

**Ожидаемый результат:**
- Страница загружается без ошибок
- Отображаются карточки с:
  - Фото (или placeholder)
  - Цена (формат: "10.9 млн ₽")
  - Площадь, комнаты, этаж
  - Название ЖК (`complex_name`)
  - Район (`district_name`)
  - Метро (`metro_station`)

**Проверка API:**
```bash
TOKEN="<your_token>"
curl -s "https://agent.housler.ru/api/favorites" -H "Authorization: Bearer $TOKEN" | jq '.success, .data[0] | keys'
# Ожидается: true, ["id", "rooms", "is_studio", "floor", "floors_total", "area_total", "price", "price_per_sqm", "complex_name", "district_name", "metro_station", "image_url", "added_at"]
```

---

#### TC-FAV-002: Добавление в избранное
| Параметр | Значение |
|----------|----------|
| Приоритет | High |
| Предусловие | Авторизован как клиент |

**Шаги:**
1. Открыть каталог `/offers`
2. Навести на карточку квартиры
3. Кликнуть на иконку сердечка

**Ожидаемый результат:**
- Иконка меняет состояние (заполняется)
- На странице `/favorites` появляется объект

---

### 2.3 Публичная подборка (BUG-001 regression)

#### TC-SEL-001: Просмотр публичной подборки гостем
| Параметр | Значение |
|----------|----------|
| Приоритет | Critical |
| Предусловие | Неавторизованный пользователь |
| Тестовые данные | share_code: `test-demo-2024` |

**Шаги:**
1. Открыть https://agent.housler.ru/s/test-demo-2024

**Ожидаемый результат:**
- Страница загружается без ошибки (НЕ "Что-то пошло не так")
- Отображается название подборки
- Отображаются карточки квартир с:
  - Фото (или placeholder "Нет фото")
  - Цена (формат: "10.9 млн ₽")
  - Площадь, комнаты, этаж
  - Название ЖК
  - Район и метро

**Проверка в DevTools:**
- Network: GET `/api/selections/shared/test-demo-2024` → 200
- Response содержит `items[]` с полями: `price`, `area_total`, `rooms`, `complex_name`
- Console: нет ошибок

---

### 2.4 Rate Limiting (FIX-002 regression)

#### TC-RATE-001: Проверка отсутствия warning в логах
| Параметр | Значение |
|----------|----------|
| Приоритет | Medium |

**Шаги:**
1. Проверить логи backend

**Команда:**
```bash
ssh housler-server "docker logs agent-backend --tail 30 2>&1 | grep -i 'error\|warning\|ERR_'"
```

**Ожидаемый результат:**
- Нет строк с `ERR_ERL_KEY_GEN_IPV6`
- Нет ValidationError про IPv6

---

## 3. API проверки

### 3.1 Проверка API избранного (FIX-001)

```bash
# Получить токен
curl -X POST "https://agent.housler.ru/api/auth/request-code" \
  -H "Content-Type: application/json" \
  -d '{"email":"client@test.housler.ru"}'

# Верифицировать (посмотреть код в логах или использовать 111111)
curl -X POST "https://agent.housler.ru/api/auth/verify-code" \
  -H "Content-Type: application/json" \
  -d '{"email":"client@test.housler.ru","code":"111111"}'

# Сохранить токен и проверить избранное
TOKEN="<token>"
curl -s "https://agent.housler.ru/api/favorites" \
  -H "Authorization: Bearer $TOKEN" | jq '.'
```

**Ожидаемая структура ответа:**
```json
{
  "success": true,
  "data": [
    {
      "id": 12020,
      "rooms": 2,
      "is_studio": false,
      "floor": 12,
      "floors_total": 12,
      "area_total": "64.98",
      "price": "10936134.00",
      "price_per_sqm": "168300.00",
      "complex_name": "Энфилд",
      "district_name": "Всеволожский район",
      "metro_station": "Девяткино",
      "image_url": "http://img.nmarket.pro/...",
      "added_at": "2025-12-02T09:37:01.520Z"
    }
  ]
}
```

### 3.2 Проверка rate limiter

```bash
# Должно работать (не превышен лимит)
curl -X POST "https://agent.housler.ru/api/auth/request-code" \
  -H "Content-Type: application/json" \
  -d '{"email":"client@test.housler.ru"}'
# Ожидается: {"success":true,"message":"Код отправлен на email"}

# При превышении лимита (10+ запросов за 15 минут):
# Ожидается: {"success":false,"error":"Слишком много попыток. Попробуйте через 15 минут."}
```

---

## 4. Известные ограничения

1. **Тестовые аккаунты** — только для `@test.housler.ru`, постоянные коды
2. **Карта** — требует Яндекс API ключ
3. **PDF генерация** — требует puppeteer/chrome
4. **Миграции** — на новой БД требуется прогнать все миграции из `database/migrations/`

---

## 5. Чеклист перед релизом

- [ ] Smoke test всех критических сценариев (TC-AUTH, TC-SEL, TC-FAV)
- [ ] Проверка под всеми ролями (guest, client, agent)
- [ ] Проверка на мобильном разрешении
- [ ] Network tab: нет 5xx ошибок
- [ ] Console: нет критических ошибок JS
- [ ] Логи backend: нет warnings/errors
- [ ] Regression: ранее исправленные баги не воспроизводятся

---

## 6. Контакты

| Роль | Контакт |
|------|---------|
| QA | @housler_spb |
| Dev | — |
| Email | hello@housler.ru |
