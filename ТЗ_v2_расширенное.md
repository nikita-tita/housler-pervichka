# Техническое задание: Housler Pervichka

## Агрегатор первичной недвижимости Санкт-Петербурга

**Версия:** 2.0
**Дата:** 2025-11-29
**Статус:** Draft

---

## Содержание

1. [Введение и бизнес-контекст](#1-введение-и-бизнес-контекст)
2. [Целевая аудитория и персоны](#2-целевая-аудитория-и-персоны)
3. [Пользовательские сценарии (User Stories)](#3-пользовательские-сценарии-user-stories)
4. [Функциональные требования](#4-функциональные-требования)
5. [Нефункциональные требования](#5-нефункциональные-требования)
6. [Архитектура системы](#6-архитектура-системы)
7. [Модель данных](#7-модель-данных)
8. [API спецификация](#8-api-спецификация)
9. [Пользовательский интерфейс](#9-пользовательский-интерфейс)
10. [Безопасность](#10-безопасность)
11. [Интеграции](#11-интеграции)
12. [Мониторинг и аналитика](#12-мониторинг-и-аналитика)
13. [Стратегия обновления данных](#13-стратегия-обновления-данных)
14. [Критерии приёмки](#14-критерии-приёмки)
15. [Риски и митигация](#15-риски-и-митигация)
16. [Глоссарий](#16-глоссарий)

---

## 1. Введение и бизнес-контекст

### 1.1 Описание проекта

**Housler Pervichka** — B2B-платформа для профессиональных участников рынка недвижимости (риелторов, агентств), агрегирующая данные о первичном рынке жилья Санкт-Петербурга.

### 1.2 Бизнес-цели

| #   | Цель                                                      | Метрика успеха                             | Срок      |
| --- | --------------------------------------------------------- | ------------------------------------------ | --------- |
| 1   | Стать основным инструментом для риелторов СПб по первичке | 500+ активных B2B пользователей            | 6 месяцев |
| 2   | Обеспечить актуальность данных                            | Обновление < 4 часов, покрытие > 95% рынка | MVP       |
| 3   | Создать канал лидогенерации для застройщиков              | 100+ лидов/месяц                           | 3 месяца  |
| 4   | Масштабировать на другие регионы                          | Готовность архитектуры к multi-region      | MVP       |

### 1.3 Бизнес-модель

```
┌─────────────────────────────────────────────────────────────────┐
│                    МОДЕЛЬ РАБОТЫ                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                    HOUSLER PERVICHKA                      │  │
│  │            (оператор платформы — ВЫ)                      │  │
│  └──────────────────────────────────────────────────────────┘  │
│         ▲                    │                    │             │
│         │ Заявки на          │ XML фиды          │ Комиссия    │
│         │ бронирование       │ (объекты)         │ за сделку   │
│         │                    ▼                    ▼             │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐      │
│  │   АГЕНТЫ     │    │ ЗАСТРОЙЩИКИ  │    │  МОНЕТИЗАЦИЯ │      │
│  │   ────────   │    │ ────────────│    │  ──────────── │      │
│  │ • Регистрация│    │ • Выгружают  │    │ • Комиссия   │      │
│  │ • Поиск      │    │   объекты    │    │   с брони    │      │
│  │ • Подборки   │◄───│ • Получают   │    │ • Premium    │      │
│  │ • Бронь      │    │   брони      │    │   подписка   │      │
│  │   ↓          │    │              │    │ • Реклама    │      │
│  │ КЛИЕНТЫ      │    │              │    │   (позже)    │      │
│  │ (по ссылке)  │    │              │    │              │      │
│  └──────────────┘    └──────────────┘    └──────────────┘      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

FLOW:
1. Застройщики → выгружают XML фиды с объектами
2. Housler → парсит фиды, формирует базу
3. Агент → ищет объекты, создаёт подборку
4. Агент → отправляет клиенту ссылку на подборку
5. Клиент → смотрит подборку, ищет по базе, добавляет варианты
6. Агент + Клиент → обсуждают, выбирают объект
7. Агент → бронирует квартиру (форма с данными клиента)
8. Housler → получает заявку, обрабатывает с застройщиком
```

### 1.4 Конкурентные преимущества

| Преимущество          | Описание                            | vs ЦИАН/Авито                  |
| --------------------- | ----------------------------------- | ------------------------------ |
| **Фокус на первичке** | Только новостройки СПб              | Они — универсальные            |
| **B2B-ориентация**    | Инструменты для риелторов           | Они — для конечных покупателей |
| **Полнота данных**    | 100% объектов из официальных фидов  | Неполное покрытие              |
| **API-first**         | Открытый API для интеграций         | Закрытые системы               |
| **Аналитика рынка**   | Глубокая статистика по ЖК и районам | Базовая статистика             |

### 1.5 Ключевые ограничения

- **Бюджет:** Минимизация затрат на MVP (один разработчик)
- **Сроки:** MVP за 6-8 недель
- **Данные:** Зависимость от XML-фидов Яндекс Недвижимость
- **География:** Только Санкт-Петербург на старте

### 1.6 Конкурентный анализ: Nmarket.PRO

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    АНАЛИЗ КОНКУРЕНТА: NMARKET.PRO                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  О КОНКУРЕНТЕ:                                                         │
│  • 12 лет на рынке, 25 регионов (РФ, ОАЭ, Таиланд, Турция)            │
│  • 855 застройщиков, 58 000 агентов-партнёров                          │
│  • 5 млрд ₽ выплачено агентам комиссий                                 │
│  • Закрытая B2B-платформа (только для агентов)                         │
│                                                                         │
│  ИХ СИЛЬНЫЕ СТОРОНЫ:                                                   │
│  ✓ Умный поиск 50+ параметров                                          │
│  ✓ Планировки, поэтажные планы, рендеры, 3D-туры                       │
│  ✓ Тарифная карта (% комиссии по застройщикам)                         │
│  ✓ CRM: база клиентов, история подборок                                │
│  ✓ Мобильное приложение (iOS, Android, Huawei)                         │
│  ✓ Авансирование и быстрые выплаты                                     │
│  ✓ Полное сопровождение сделок                                         │
│                                                                         │
│  ИХ СЛАБЫЕ СТОРОНЫ (наши возможности):                                 │
│  ✗ Закрытая система — клиент видит ТОЛЬКО подборку агента             │
│  ✗ Клиент пассивен — не может сам искать и добавлять                   │
│  ✗ Нет AI-функций                                                       │
│  ✗ Нет интерактивного выбора на поэтажном плане                        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.7 Конкурентный анализ: TrendAgent

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    АНАЛИЗ КОНКУРЕНТА: TRENDAGENT                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  О КОНКУРЕНТЕ:                                                         │
│  • B2B-платформа для риелторов и агентств                              │
│  • Санкт-Петербург + другие регионы                                    │
│  • Полный цикл: поиск → бронь → ипотека → сделка                       │
│  • Рейтинги агентств, вебинары, обучение                               │
│                                                                         │
│  ИХ СИЛЬНЫЕ СТОРОНЫ:                                                   │
│  ✓ CRM-воронка: Просмотры → Фиксации → Брони → Сделки → Срывы         │
│  ✓ Фиксация цены у застройщика (до подтверждения клиентом)            │
│  ✓ Ипотечный калькулятор + заявка на ипотеку                          │
│  ✓ Файлы застройщиков (регламенты, договоры, презентации)             │
│  ✓ Файлы банков (формы, требования к документам)                       │
│  ✓ Страхование (калькулятор + заявка)                                  │
│  ✓ Рейтинги агентств (ежемесячные, с наградами)                       │
│  ✓ Вебинары и обучение для агентов                                     │
│  ✓ Разные типы: квартиры, паркинги, коммерция, дома, участки          │
│  ✓ Статистика просмотров клиентом (когда открыл, что смотрел)         │
│                                                                         │
│  ИХ СЛАБЫЕ СТОРОНЫ (наши возможности):                                 │
│  ✗ Закрытая система — клиент видит ТОЛЬКО подборку агента             │
│  ✗ Клиент пассивен — не может сам искать                               │
│  ✗ Нет AI-функций                                                       │
│  ✗ Баги в интерфейсе (сравнение не работает)                           │
│  ✗ Сложный интерфейс (много разделов)                                  │
│                                                                         │
│  ЧТО ОБЯЗАТЕЛЬНО БЕРЁМ:                                                │
│  ─────────────────────────────────────────────────────────────────────  │
│  ★ CRM-воронка для агентов (видеть этапы сделок)                       │
│  ★ Фиксация цены (важный B2B-инструмент)                               │
│  ★ Ипотечный калькулятор (конверсия!)                                  │
│  ★ Файлы застройщиков (регламенты, договоры)                           │
│  ★ Статистика просмотров клиентом                                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.8 Сводное сравнение конкурентов

```
┌─────────────────────────────────────────────────────────────────────────┐
│              NMARKET vs TRENDAGENT vs HOUSLER                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Функция                    │ Nmarket │ Trend  │ Housler │ Приоритет   │
│  ───────────────────────────────────────────────────────────────────── │
│                                                                         │
│  ПОИСК И КАТАЛОГ                                                       │
│  Фильтры 50+                │    ✓    │   ✓    │    ✓    │ MVP         │
│  Умная строка поиска        │    ✓    │   △    │    ✓    │ MVP         │
│  Счётчик в реальном времени │    ?    │   ✓    │    ✓    │ MVP         │
│  Разные типы недвижимости   │    ✓    │   ✓    │    △    │ v1.2        │
│                                                                         │
│  ВИЗУАЛИЗАЦИЯ                                                          │
│  Планировки                 │    ✓    │   ✓    │    ✓    │ MVP         │
│  Поэтажные планы            │    ✓    │   ✓    │    ✓    │ v1.1        │
│  Интерактивный выбор        │    ✗    │   ✗    │    ✓    │ v1.2 ★     │
│  3D-визуализация (AI)       │    △    │   ✗    │    ✓    │ v2.0 ★     │
│                                                                         │
│  РАБОТА С КЛИЕНТОМ                                                     │
│  Клиент видит всю базу      │    ✗    │   ✗    │    ✓    │ MVP ★★★    │
│  Клиент добавляет в подборку│    ✗    │   ✗    │    ✓    │ MVP ★★★    │
│  Статистика просмотров      │    ?    │   ✓    │    ✓    │ MVP/v1.1   │
│                                                                         │
│  CRM ДЛЯ АГЕНТОВ                                                       │
│  Подборки/презентации       │    ✓    │   ✓    │    ✓    │ MVP         │
│  Сравнение объектов         │    ✓    │   ✓    │    ✓    │ MVP         │
│  CRM-воронка (этапы сделки) │    △    │   ✓    │    ✓    │ v1.1 ★     │
│  Фиксация цены              │    ?    │   ✓    │    ✓    │ v1.1       │
│  База клиентов              │    ✓    │   ✓    │    ✓    │ v1.1       │
│                                                                         │
│  ИПОТЕКА                                                               │
│  Калькулятор                │    ?    │   ✓    │    ✓    │ MVP ★      │
│  Программы банков           │    ?    │   ✓    │    ✓    │ v1.1       │
│  Заявка на ипотеку          │    ?    │   ✓    │    △    │ v1.2       │
│                                                                         │
│  ДОКУМЕНТЫ                                                             │
│  Файлы застройщиков         │    ✓    │   ✓    │    ✓    │ v1.1 ★     │
│  Файлы банков               │    ✗    │   ✓    │    ✓    │ v1.1       │
│  Тарифная карта             │    ✓    │   ?    │    ✓    │ v1.1       │
│                                                                         │
│  ГЕЙМИФИКАЦИЯ                                                          │
│  Рейтинг агентств           │    ✗    │   ✓    │    ✓    │ v1.2       │
│  Рейтинг агентов            │    ✗    │   ✓    │    ✓    │ v2.0       │
│  Вебинары/обучение          │    ✓    │   ✓    │    △    │ v1.2       │
│                                                                         │
│  ТЕХНОЛОГИИ                                                            │
│  AI-ассистент поиска        │    ✗    │   ✗    │    ✓    │ v1.1 ★★    │
│  AI-рекомендации            │    ✗    │   ✗    │    ✓    │ v1.2 ★★    │
│  Мобильное приложение       │    ✓    │   ✓    │    △    │ v2.0       │
│                                                                         │
│  ─────────────────────────────────────────────────────────────────────  │
│  ✓ = есть   △ = частично/планируется   ✗ = нет   ★ = наше преимущество │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.9 Наши конкурентные преимущества

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    HOUSLER vs NMARKET.PRO                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  КЛЮЧЕВОЕ ОТЛИЧИЕ:                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  NMARKET: Агент → подборка → клиент (пассивный)                 │   │
│  │  HOUSLER: Агент ↔ клиент ↔ ВСЯ БАЗА (активное взаимодействие)   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ЧТО БЕРЁМ У КОНКУРЕНТА:                                               │
│  ─────────────────────────────────────────────────────────────────────  │
│  ✓ Расширенный поиск (50+ параметров фильтрации)                       │
│  ✓ Умная строка поиска (автодополнение ЖК, адресов, метро)            │
│  ✓ Визуализация: планировки, поэтажные планы, рендеры                  │
│  ✓ Тарифная карта по застройщикам (% комиссии, условия)               │
│  ✓ CRM для агентов (база клиентов, история)                           │
│  ✓ Мобильное приложение (фаза 2)                                       │
│                                                                         │
│  ЧТО ДЕЛАЕМ ЛУЧШЕ:                                                     │
│  ─────────────────────────────────────────────────────────────────────  │
│  ★ Открытый доступ к базе для клиентов                                 │
│  ★ Совместная работа агент-клиент над подборкой                        │
│  ★ Интерактивный выбор на поэтажном плане                              │
│  ★ AI-ассистент поиска ("найди 2-комн рядом с Парнасом до 10 млн")    │
│  ★ AI-генерация 3D из 2D планировки                                    │
│  ★ Умные рекомендации и аналитика предпочтений                         │
│  ★ Прозрачность для клиента (видит все варианты рынка)                 │
│                                                                         │
│  СРАВНЕНИЕ ФУНКЦИОНАЛА:                                                │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  Функция                        │ Nmarket  │ Housler │ Преимущество    │
│  ─────────────────────────────────────────────────────────────────────  │
│  Поиск 50+ параметров           │    ✓     │    ✓    │ Паритет        │
│  Планировки и поэтажные планы   │    ✓     │    ✓    │ Паритет        │
│  Клиент видит всю базу          │    ✗     │    ✓    │ ★ HOUSLER      │
│  Клиент добавляет в подборку    │    ✗     │    ✓    │ ★ HOUSLER      │
│  Интерактивный выбор на плане   │    ✗     │    ✓    │ ★ HOUSLER      │
│  AI-ассистент поиска            │    ✗     │    ✓    │ ★ HOUSLER      │
│  3D-визуализация из 2D          │    △     │    ✓    │ ★ HOUSLER      │
│  Мобильное приложение           │    ✓     │  фаза 2 │ Nmarket        │
│  CRM для агентов                │    ✓     │    ✓    │ Паритет        │
│  Тарифная карта                 │    ✓     │    ✓    │ Паритет        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Целевая аудитория и роли

### 2.1 Роли в системе

```
┌─────────────────────────────────────────────────────────────────┐
│                     РОЛИ ПОЛЬЗОВАТЕЛЕЙ                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  АГЕНТ (Agent) — основной пользователь                  │   │
│  │  ─────────────────────────────────────────────────────  │   │
│  │  • Регистрируется в системе (email/пароль)              │   │
│  │  • Ищет объекты по всей базе                            │   │
│  │  • Создаёт ПОДБОРКИ для клиентов                        │   │
│  │  • Отправляет клиентам ссылки на подборки               │   │
│  │  • БРОНИРУЕТ квартиры (форма с данными клиента)         │   │
│  │  • Видит статусы своих бронирований                     │   │
│  │  • Получает уведомления                                 │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              │ создаёт подборку                 │
│                              │ отправляет ссылку                │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  КЛИЕНТ (Client) — приходит по ссылке от агента         │   │
│  │  ─────────────────────────────────────────────────────  │   │
│  │  • НЕ ОБЯЗАН регистрироваться (работает анонимно)       │   │
│  │  • МОЖЕТ зарегистрироваться (для синхронизации)         │   │
│  │  • Смотрит подборку агента                              │   │
│  │  • Ищет по ВСЕЙ базе объектов                           │   │
│  │  • ДОБАВЛЯЕТ объекты в подборку (совместная работа)     │   │
│  │  • НЕ МОЖЕТ бронировать — только через агента           │   │
│  │  • Может оставить комментарии к объектам                │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  ОПЕРАТОР (Admin) — владелец платформы (ВЫ)             │   │
│  │  ─────────────────────────────────────────────────────  │   │
│  │  • Получает все заявки на бронирование                  │   │
│  │  • Обрабатывает брони с застройщиками                   │   │
│  │  • Управляет агентами                                   │   │
│  │  • Настраивает импорт фидов                             │   │
│  │  • Видит аналитику по платформе                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 Персона: Агент "Алексей"

```
┌─────────────────────────────────────────────────────────────────┐
│  👤 АЛЕКСЕЙ, 35 лет, частный риелтор                            │
├─────────────────────────────────────────────────────────────────┤
│  Опыт: 5 лет в недвижимости                                     │
│  Сделок в месяц: 2-3                                            │
│  Специализация: Новостройки комфорт-класса                      │
│  Клиентов одновременно: 5-10                                    │
├─────────────────────────────────────────────────────────────────┤
│  БОЛИ:                                                          │
│  • Тратит 2-3 часа/день на мониторинг предложений               │
│  • Сложно показать клиенту варианты (скриншоты в WhatsApp)      │
│  • Клиент нашёл что-то на ЦИАН — непонятно есть ли это в базе   │
│  • Нет удобного способа совместно обсуждать варианты            │
│  • Бронирование через звонки/письма — долго и ненадёжно         │
├─────────────────────────────────────────────────────────────────┤
│  ПОТРЕБНОСТИ:                                                   │
│  • Единая база всех новостроек СПб                              │
│  • Создавать подборки и отправлять клиентам                     │
│  • Клиент сам ищет и добавляет варианты                         │
│  • Бронировать онлайн с отслеживанием статуса                   │
│  • Уведомления об изменении цен в подборке                      │
├─────────────────────────────────────────────────────────────────┤
│  ГОТОВ ПЛАТИТЬ: до 3 000 ₽/месяц за premium                     │
└─────────────────────────────────────────────────────────────────┘
```

### 2.3 Персона: Клиент "Мария"

```
┌─────────────────────────────────────────────────────────────────┐
│  👩 МАРИЯ, 32 года, ищет квартиру в новостройке                 │
├─────────────────────────────────────────────────────────────────┤
│  Бюджет: 10-15 млн ₽                                            │
│  Требования: 2-комн, Василеостровский/Приморский, сдача 2025    │
│  Работает с агентом Алексеем                                    │
├─────────────────────────────────────────────────────────────────┤
│  СЦЕНАРИЙ:                                                      │
│  1. Получает ссылку от Алексея с подборкой из 5 вариантов       │
│  2. Смотрит подборку, отмечает понравившиеся                    │
│  3. Сама ищет по базе, находит ещё 2 варианта                   │
│  4. Добавляет их в подборку — Алексей видит это                 │
│  5. Обсуждают с Алексеем, выбирают 1 вариант                    │
│  6. Алексей бронирует квартиру через платформу                  │
├─────────────────────────────────────────────────────────────────┤
│  ОЖИДАНИЯ:                                                      │
│  • Не хочет регистрироваться — просто посмотреть                │
│  • Удобный просмотр на телефоне                                 │
│  • Видеть все характеристики без "скрытых"                      │
│  • Сравнить варианты в одном месте                              │
└─────────────────────────────────────────────────────────────────┘
```

### 2.4 Матрица прав доступа

| Функция             | Гость | Клиент (аноним) | Клиент (зарег.) | Агент     | Оператор |
| ------------------- | ----- | --------------- | --------------- | --------- | -------- |
| Просмотр подборки   | ❌    | ✅ (по ссылке)  | ✅              | ✅        | ✅       |
| Поиск объектов      | ❌    | ✅              | ✅              | ✅        | ✅       |
| Добавить в подборку | ❌    | ✅              | ✅              | ✅        | ✅       |
| Комментарии         | ❌    | ✅              | ✅              | ✅        | ✅       |
| Создать подборку    | ❌    | ❌              | ❌              | ✅        | ✅       |
| Бронирование        | ❌    | ❌              | ❌              | ✅        | ✅       |
| Статусы броней      | ❌    | ❌              | ❌              | ✅ (свои) | ✅ (все) |
| Управление фидами   | ❌    | ❌              | ❌              | ❌        | ✅       |
| Аналитика           | ❌    | ❌              | ❌              | Базовая   | Полная   |

### 2.5 Мульти-агентный сценарий

Клиент может работать с несколькими агентами одновременно. Важно: **агенты не должны видеть друг друга**.

```
┌─────────────────────────────────────────────────────────────────┐
│         ОБЪЕДИНЁННЫЙ КАБИНЕТ КЛИЕНТА                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  КЛИЕНТ регистрируется (email или телефон)                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                     МОИ ПОДБОРКИ                        │   │
│  ├─────────────────────────────────────────────────────────┤   │
│  │                                                          │   │
│  │  📁 Подборка от Алексея    [5 объектов] [2 новых]       │   │
│  │  📁 Подборка от Ивана      [3 объекта]  [1 новый]       │   │
│  │  📁 Подборка от Ольги      [7 объектов]                  │   │
│  │                                                          │   │
│  │  ─────────────────────────────────────────────────────  │   │
│  │  📁 Мои находки            [4 объекта]  ← сам нашёл     │   │
│  │                                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ЧТО ВИДИТ КЛИЕНТ:                                             │
│  ✅ Все подборки от всех агентов                               │
│  ✅ Может переключаться между подборками                       │
│  ✅ Может искать по всей базе и добавлять в любую подборку     │
│  ✅ Видит имя агента (для понимания, откуда подборка)          │
│  ✅ "Мои находки" — объекты, которые добавил сам               │
│  ❌ НЕ видит контакты агентов (переписка через платформу)      │
│                                                                 │
│  ЧТО ВИДИТ АГЕНТ:                                              │
│  ✅ ТОЛЬКО свою подборку для этого клиента                     │
│  ✅ Видит, что клиент добавил в ЕГО подборку                   │
│  ✅ Видит комментарии клиента к объектам ЕГО подборки          │
│  ❌ НЕ видит, что клиент работает с другими агентами          │
│  ❌ НЕ видит объекты из других подборок                        │
│  ❌ НЕ видит "Мои находки" клиента (пока клиент не добавит)    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

FLOW привязки клиента:

1. Агент создаёт подборку → указывает email/телефон клиента
2. Система проверяет: есть ли уже такой клиент?
   • Да → привязывает подборку к существующему аккаунту
   • Нет → создаёт "pending" клиента, ждёт регистрации
3. Клиент получает ссылку на подборку
4. При первом визите:
   • Если не зарегистрирован → предлагает регистрацию
   • Если зарегистрирован → автоматически видит в кабинете
5. После регистрации — все подборки по его email/телефону объединяются
```

**Важные edge cases:**

| Ситуация                                    | Поведение                                             |
| ------------------------------------------- | ----------------------------------------------------- |
| Один объект в подборках разных агентов      | Клиент видит его в обеих подборках (дубликат)         |
| Клиент добавил объект в "Мои находки"       | Агенты не видят, пока клиент не добавит в их подборку |
| Агент удалил объект из подборки             | Клиент перестаёт видеть в этой подборке               |
| Клиент удалил объект из подборки            | Агент видит, что клиент удалил (лог действий)         |
| Два агента отправили ссылки на разные email | Разные аккаунты клиента (не объединяются)             |

---

## 3. Пользовательские сценарии (User Stories)

### 3.1 Эпик: Поиск объектов

#### US-1.1: Быстрый поиск по основным параметрам

```gherkin
Как риелтор
Я хочу быстро найти квартиры по основным параметрам (комнаты, цена, район)
Чтобы оперативно подобрать варианты для клиента

Критерии приёмки:
- Форма поиска доступна на главной странице
- Поддерживаются фильтры: комнаты, цена (от-до), район, метро
- Результаты отображаются за < 2 секунд
- Показывается общее количество найденных объектов
- Результаты можно сортировать по цене, площади, дате

Сценарий: Поиск 2-комнатной квартиры в Василеостровском районе
  Дано: Пользователь на главной странице
  Когда: Выбирает "2 комнаты", район "Василеостровский", цена до 20 млн
  Тогда: Отображается список из N квартир, соответствующих критериям
  И: Каждая карточка содержит фото, цену, площадь, адрес, ЖК
```

#### US-1.2: Расширенная фильтрация

```gherkin
Как опытный риелтор
Я хочу использовать расширенные фильтры
Чтобы точнее подобрать варианты под специфические требования клиента

Критерии приёмки:
- Доступна панель расширенных фильтров
- Фильтры: этаж (не первый/не последний), площадь, отделка,
  тип дома, статус строительства, год сдачи, балкон, лифт, парковка
- Фильтры комбинируются с помощью AND
- Можно сбросить все фильтры одной кнопкой
- Активные фильтры отображаются в виде чипов

Дополнительные фильтры для B2B:
- Цена за м² (от-до)
- Наличие ипотеки
- Конкретный ЖК (множественный выбор)
- Застройщик
```

#### US-1.3: Поиск по карте

```gherkin
Как риелтор
Я хочу искать объекты на карте
Чтобы видеть расположение относительно инфраструктуры

Критерии приёмки:
- Карта отображает маркеры всех объектов из результатов поиска
- Маркеры кластеризуются при уменьшении масштаба
- Клик на маркер показывает popup с краткой информацией
- Из popup можно перейти на карточку объекта
- Карта синхронизирована с фильтрами
- Можно рисовать область поиска на карте (Фаза 2)
```

#### US-1.4: Геопоиск

```gherkin
Как риелтор
Я хочу находить объекты рядом с определённой точкой
Чтобы подобрать варианты рядом с работой/школой клиента

Критерии приёмки:
- Можно указать адрес или точку на карте
- Указать радиус поиска (500м, 1км, 2км, 5км)
- Результаты сортируются по расстоянию
- Показывается время пешком до указанной точки
```

### 3.2 Эпик: Просмотр объектов

#### US-2.1: Карточка объекта

```gherkin
Как риелтор
Я хочу видеть полную информацию об объекте
Чтобы принять решение о показе клиенту

Критерии приёмки:
- Отображается галерея: план квартиры, фото дома, план этажа
- Все характеристики: комнаты, площади, этаж, отделка, балкон, санузел
- Информация о ЖК и корпусе: застройщик, тип дома, срок сдачи
- Расположение на карте с метро и инфраструктурой
- Контакты для связи (застройщик/агент)
- Кнопки: Добавить в избранное, Сравнить, Поделиться, Скачать PDF
- История изменения цены (если есть)
```

#### US-2.2: Страница ЖК

```gherkin
Как риелтор
Я хочу видеть информацию о жилом комплексе
Чтобы оценить все доступные варианты в одном ЖК

Критерии приёмки:
- Описание ЖК, фотографии, схема комплекса
- Информация о застройщике
- Список корпусов с датами сдачи
- Статистика: мин/макс/средняя цена, доступные типы квартир
- Список всех доступных квартир с фильтрацией
- Расположение на карте, инфраструктура района
- Контакты отдела продаж

Шахматка (Фаза 2):
- Визуализация доступности квартир по этажам и секциям
```

### 3.3 Эпик: Подборки для клиентов (ключевой функционал)

#### US-3.1: Создание подборки для клиента

```gherkin
Как агент
Я хочу создать подборку объектов для клиента
Чтобы отправить ему ссылку и совместно работать над выбором

Критерии приёмки:
- Кнопка "Создать подборку" в личном кабинете агента
- Указываю: название подборки, email и/или телефон клиента
- Могу добавлять объекты из результатов поиска или карточки
- Получаю уникальную ссылку для отправки клиенту
- Подборка появляется в списке "Мои подборки"

Сценарий: Создание подборки
  Дано: Агент авторизован, нашёл 5 подходящих квартир
  Когда: Нажимает "Создать подборку"
  И: Вводит "Мария Иванова", email "maria@mail.ru"
  И: Добавляет 5 объектов
  Тогда: Создаётся подборка с уникальной ссылкой /s/abc123
  И: Клиенту отправляется email с приглашением
```

#### US-3.2: Совместная работа с подборкой

```gherkin
Как агент
Я хочу видеть, что клиент добавил в подборку
Чтобы понимать его предпочтения

Критерии приёмки:
- Вижу все объекты в подборке (мои + добавленные клиентом)
- Объекты клиента помечены "Добавлено клиентом"
- Вижу комментарии клиента к объектам
- Получаю уведомление, когда клиент добавил/удалил объект
- Могу удалять объекты из подборки
- Вижу историю действий (лог)
```

#### US-3.3: Клиент работает с подборкой

```gherkin
Как клиент
Я хочу смотреть подборку от агента и добавлять свои варианты
Чтобы обсудить их с агентом

Критерии приёмки:
- Открываю подборку по ссылке от агента (без регистрации)
- Вижу все объекты, которые добавил агент
- Могу искать по ВСЕЙ базе объектов
- Могу добавить найденный объект в подборку агента
- Могу оставить комментарий к объекту
- Могу отметить объект как "Нравится" / "Не нравится"
- Вижу уведомление: "Зарегистрируйтесь, чтобы видеть все подборки"

При регистрации:
- Все подборки (от разных агентов) объединяются в кабинете
- Вижу список подборок: "От Алексея", "От Ивана", "Мои находки"
```

#### US-3.4: Кабинет клиента с несколькими агентами

```gherkin
Как зарегистрированный клиент
Я хочу видеть подборки от всех агентов в одном месте
Чтобы сравнивать предложения

Критерии приёмки:
- Вижу список всех подборок, привязанных к моему email/телефону
- Каждая подборка помечена именем агента
- Могу переключаться между подборками
- "Мои находки" — объекты, которые добавил сам (не в подборку агента)
- Могу добавить объект из "Мои находки" в любую подборку агента
- Агенты НЕ видят друг друга и чужие подборки
```

#### US-3.5: Сравнение объектов

```gherkin
Как агент или клиент
Я хочу сравнить несколько объектов из подборки
Чтобы выбрать лучший вариант

Критерии приёмки:
- Можно добавить до 5 объектов в сравнение
- Таблица сравнения всех характеристик
- Подсветка различий (цена, площадь, этаж)
- Сравнение на карте (расположение)
- Экспорт сравнения в PDF
```

### 3.4 Эпик: Бронирование

#### US-4.1: Бронирование квартиры агентом

```gherkin
Как агент
Я хочу забронировать квартиру для клиента
Чтобы зафиксировать выбор и получить комиссию

Критерии приёмки:
- Кнопка "Забронировать" на карточке объекта (только для агентов)
- Форма бронирования:
  • Выбор клиента (из существующих или новый)
  • ФИО клиента
  • Телефон клиента
  • Email клиента
  • Паспортные данные (опционально)
  • Комментарий
- Подтверждение: "Вы уверены? Заявка уйдёт оператору"
- После отправки: статус "Ожидает подтверждения"
- Уведомление оператору (email + в админку)

Сценарий: Бронирование
  Дано: Агент и клиент выбрали квартиру в ЖК "NEXT"
  Когда: Агент нажимает "Забронировать"
  И: Заполняет данные клиента (Мария Иванова, +79111234567)
  И: Нажимает "Отправить заявку"
  Тогда: Заявка создаётся со статусом "Ожидает"
  И: Оператор получает уведомление
  И: Агент видит заявку в разделе "Мои брони"
```

#### US-4.2: Статусы бронирования

```gherkin
Как агент
Я хочу видеть статус своих бронирований
Чтобы информировать клиента о прогрессе

Статусы:
- Ожидает подтверждения (pending)
- Принята в работу (processing)
- Подтверждена застройщиком (confirmed)
- Отклонена (rejected) + причина
- Отменена (cancelled)
- Завершена (completed) — сделка состоялась

Критерии приёмки:
- Раздел "Мои брони" в личном кабинете агента
- Список всех заявок с текущим статусом
- Фильтр по статусу
- Детали заявки: объект, клиент, даты, комментарии
- Уведомления при смене статуса (email)
```

#### US-4.3: Обработка бронирования оператором

```gherkin
Как оператор
Я хочу видеть и обрабатывать все заявки на бронирование
Чтобы связываться с застройщиками

Критерии приёмки:
- Раздел "Заявки" в админ-панели
- Список всех заявок с фильтрами (статус, агент, ЖК, дата)
- Детали заявки: объект, агент, клиент, история
- Возможность менять статус
- Поле для комментария (видно только оператору)
- При смене статуса → уведомление агенту
- Экспорт заявок в Excel
```

### 3.5 Эпик: Аналитика и статистика (Фаза 2)

#### US-5.1: Обзор рынка

```gherkin
Как руководитель агентства
Я хочу видеть аналитику по рынку
Чтобы принимать бизнес-решения

Критерии приёмки:
- Дашборд с ключевыми метриками
- Средняя цена по районам / типам квартир
- Динамика цен за период
- ТОП застройщиков по количеству предложений
- Распределение по статусу строительства
- Экспорт отчётов
```

---

## 4. Функциональные требования

### 4.1 Модули системы

```
┌─────────────────────────────────────────────────────────────────┐
│                      HOUSLER PERVICHKA                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐           │
│  │   ПОИСК     │   │   ОБЪЕКТЫ   │   │   ЖК        │           │
│  │   ───────   │   │   ───────   │   │   ──        │           │
│  │ • Фильтры   │   │ • Карточка  │   │ • Страница  │           │
│  │ • Карта     │   │ • Галерея   │   │ • Корпуса   │           │
│  │ • Геопоиск  │   │ • Контакты  │   │ • Шахматка  │           │
│  │ • Сортировка│   │ • История   │   │ • Статист.  │           │
│  └─────────────┘   └─────────────┘   └─────────────┘           │
│                                                                 │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐           │
│  │ ПОДБОРКИ    │   │   ЛИДЫ      │   │ АНАЛИТИКА   │           │
│  │ ────────    │   │   ────      │   │ ─────────   │           │
│  │ • Избранное │   │ • Заявки    │   │ • Дашборд   │           │
│  │ • Сравнение │   │ • Колбэки   │   │ • Отчёты    │           │
│  │ • Сохр.поиск│   │ • Webhook   │   │ • Экспорт   │           │
│  │ • Экспорт   │   │ • Аналитика │   │ • Тренды    │           │
│  └─────────────┘   └─────────────┘   └─────────────┘           │
│                                                                 │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐           │
│  │  ПОЛЬЗОВ.   │   │   АДМИН     │   │ DATA IMPORT │           │
│  │  ────────   │   │   ─────     │   │ ───────────│           │
│  │ • Регистр.  │   │ • Юзеры     │   │ • XML парсер│           │
│  │ • Аккаунт   │   │ • Контент   │   │ • Валидация │           │
│  │ • Подписка  │   │ • Настройки │   │ • Импорт    │           │
│  │ • Уведомл.  │   │ • Логи      │   │ • Cron      │           │
│  └─────────────┘   └─────────────┘   └─────────────┘           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 Функциональная матрица по фазам

| Функция                                | MVP | Фаза 2 | Фаза 3 |
| -------------------------------------- | --- | ------ | ------ |
| **Поиск**                              |     |        |        |
| Базовые фильтры (комнаты, цена, район) | ✅  | ✅     | ✅     |
| Расширенные фильтры                    | ✅  | ✅     | ✅     |
| Карта с маркерами                      | ✅  | ✅     | ✅     |
| Кластеризация маркеров                 | ✅  | ✅     | ✅     |
| Рисование области на карте             | ❌  | ✅     | ✅     |
| Полнотекстовый поиск                   | ❌  | ✅     | ✅     |
| **Объекты**                            |     |        |        |
| Карточка объекта                       | ✅  | ✅     | ✅     |
| Галерея изображений                    | ✅  | ✅     | ✅     |
| История цен                            | ❌  | ✅     | ✅     |
| Похожие объекты                        | ❌  | ✅     | ✅     |
| **ЖК**                                 |     |        |        |
| Страница ЖК                            | ✅  | ✅     | ✅     |
| Шахматка                               | ❌  | ✅     | ✅     |
| **Подборки**                           |     |        |        |
| Избранное                              | ✅  | ✅     | ✅     |
| Теги и заметки                         | ❌  | ✅     | ✅     |
| Сравнение                              | ✅  | ✅     | ✅     |
| Сохранённые поиски                     | ❌  | ✅     | ✅     |
| Экспорт PDF/Excel                      | ❌  | ✅     | ✅     |
| **Лиды**                               |     |        |        |
| Форма заявки                           | ✅  | ✅     | ✅     |
| Обратный звонок                        | ❌  | ✅     | ✅     |
| Webhook уведомления                    | ❌  | ✅     | ✅     |
| **Пользователи**                       |     |        |        |
| Регистрация/вход                       | ✅  | ✅     | ✅     |
| OAuth (Google, Яндекс)                 | ❌  | ✅     | ✅     |
| Личный кабинет                         | ✅  | ✅     | ✅     |
| Уведомления email                      | ❌  | ✅     | ✅     |
| Telegram уведомления                   | ❌  | ❌     | ✅     |
| **Аналитика**                          |     |        |        |
| Базовая статистика                     | ✅  | ✅     | ✅     |
| Дашборд рынка                          | ❌  | ✅     | ✅     |
| Тренды цен                             | ❌  | ✅     | ✅     |
| Экспорт отчётов                        | ❌  | ❌     | ✅     |
| **Админ**                              |     |        |        |
| Управление пользователями              | ✅  | ✅     | ✅     |
| Логи импорта                           | ✅  | ✅     | ✅     |
| Настройки системы                      | ❌  | ✅     | ✅     |

### 4.3 Требования к данным

#### 4.3.1 Источники данных

| Источник                 | Тип            | Частота обновления | Приоритет |
| ------------------------ | -------------- | ------------------ | --------- |
| Yandex Realty Feed (XML) | Основной       | Каждые 4 часа      | MVP       |
| Ручной ввод (админ)      | Дополнительный | По необходимости   | MVP       |
| ЦИАН API                 | Расширение     | Ежедневно          | Фаза 3    |
| Парсинг сайтов ЖК        | Расширение     | Еженедельно        | Фаза 3    |

#### 4.3.2 Объём данных

| Сущность             | Текущий объём | Прогноз (1 год) |
| -------------------- | ------------- | --------------- |
| Offers (объявления)  | ~12,000       | ~50,000         |
| Complexes (ЖК)       | ~500          | ~1,000          |
| Buildings (корпуса)  | ~1,500        | ~3,000          |
| Images (изображения) | ~60,000       | ~200,000        |
| Users (пользователи) | -             | ~5,000          |
| Leads (лиды)         | -             | ~50,000         |

### 4.4 Расширенная система поиска (50+ параметров)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    СИСТЕМА ПОИСКА HOUSLER                                │
│                    (конкурентное преимущество)                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  УМНАЯ СТРОКА ПОИСКА                                                   │
│  ─────────────────────────────────────────────────────────────────────  │
│  • Автодополнение: ЖК, адреса, застройщики, метро                      │
│  • Распознавание запросов: "2-комн на Парнасе до 10 млн"               │
│  • История поиска пользователя                                          │
│  • Популярные запросы                                                   │
│                                                                         │
│  РЕЖИМЫ ОТОБРАЖЕНИЯ                                                    │
│  ─────────────────────────────────────────────────────────────────────  │
│  • Список (карточки)                                                    │
│  • Карта с кластеризацией                                               │
│  • Каталог планировок (группировка по типам)                           │
│  • Таблица (для агентов, с доп. полями)                                │
│  • Шахматка ЖК (интерактивный выбор)                                   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 4.4.1 Полный список фильтров (65+)

**БАЗОВЫЕ ФИЛЬТРЫ (MVP)**

| #   | Фильтр         | Тип          | Значения                         | Приоритет |
| --- | -------------- | ------------ | -------------------------------- | --------- |
| 1   | Комнатность    | Multi-select | Студия, 1, 1Е, 2, 2Е, 3, 3Е, 4+  | MVP       |
| 2   | Цена от-до     | Range        | 0 - 100+ млн ₽                   | MVP       |
| 3   | Цена за м²     | Range        | 0 - 500K ₽/м²                    | MVP       |
| 4   | Общая площадь  | Range        | 0 - 300+ м²                      | MVP       |
| 5   | Район          | Multi-select | Список районов СПб + ЛО          | MVP       |
| 6   | Метро          | Multi-select | Список станций                   | MVP       |
| 7   | Время до метро | Range        | 0 - 30+ мин                      | MVP       |
| 8   | ЖК             | Autocomplete | Поиск по названию                | MVP       |
| 9   | Застройщик     | Multi-select | Список застройщиков              | MVP       |
| 10  | Срок сдачи     | Multi-select | Сдан, I-IV кв. 2025, 2026, 2027+ | MVP       |

> **Примечание по комнатности:** Евро-форматы (1Е, 2Е, 3Е) — это планировки с объединённой кухней-гостиной. 1Е — одна спальня + кухня-гостиная (по ощущению как 2-комн). Подробнее см. раздел 4.13.

> **Примечание по сроку сдачи:** В отличие от конкурентов, мы позволяем выбирать конкретный квартал (I-IV кв.), а не только год. Это критично для клиентов с ограниченными сроками.

**ЮРИДИЧЕСКИЕ ФИЛЬТРЫ (MVP) — КРИТИЧНО!**

| #   | Фильтр       | Тип          | Значения                                          | Приоритет |
| --- | ------------ | ------------ | ------------------------------------------------- | --------- |
| 11  | Тип сделки   | Multi-select | ДДУ, Уступка (юр.л), Уступка (физ.л), Переуступка | MVP       |
| 12  | Эскроу       | Toggle       | Да (обязательно)                                  | MVP       |
| 13  | Апартаменты  | Toggle       | Включать/Исключить                                | MVP       |
| 14  | Прописка     | Select       | Любая, СПб, Ленобласть                            | MVP       |
| 15  | Банк-партнёр | Autocomplete | Список аккредитованных банков                     | MVP       |

> **⚠️ Почему это критично:**
>
> - **Тип сделки** — клиенты часто говорят "только ДДУ" или "никаких уступок от физлиц" (риски)
> - **Эскроу** — с 2019 года обязательно для ДДУ, но старые объекты могут быть без эскроу
> - **Апартаменты** — юридически НЕ являются жилыми помещениями: нет прописки, другие тарифы ЖКХ, другой налог
> - **Прописка** — важно для школ, поликлиник, налогов. Объекты в ЛО не дают прописку в СПб
> - **Банк** — если у клиента одобрена ипотека в конкретном банке, он может купить только в аккредитованных ЖК

Подробное описание юридических аспектов см. в разделе 4.12.

**РАСШИРЕННЫЕ ФИЛЬТРЫ — КВАРТИРА (MVP/v1.1)**

| #   | Фильтр              | Тип          | Значения                                                 | Приоритет |
| --- | ------------------- | ------------ | -------------------------------------------------------- | --------- |
| 16  | Жилая площадь       | Range        | м²                                                       | MVP       |
| 17  | Площадь кухни       | Range        | м²                                                       | MVP       |
| 18  | Этаж                | Range        | 1 - 50                                                   | MVP       |
| 19  | Не первый этаж      | Toggle       | Да/Нет                                                   | MVP       |
| 20  | Не последний этаж   | Toggle       | Да/Нет                                                   | MVP       |
| 21  | Последний этаж      | Toggle       | Да/Нет                                                   | v1.1      |
| 22  | Высота потолков     | Range        | 2.5 - 4+ м                                               | v1.1      |
| 23  | Отделка             | Multi-select | Без отделки, Предчистовая, Чистовая, White box, Под ключ | MVP       |
| 24  | Балкон/лоджия       | Select       | Любой, Есть, Нет, Балкон, Лоджия, Французский            | MVP       |
| 25  | Санузел             | Select       | Любой, Совмещённый, Раздельный, 2+                       | v1.1      |
| 26  | Вид из окон         | Multi-select | Двор, Улица, Парк, Вода, Панорамный                      | v1.1      |
| 27  | Сторона света       | Multi-select | Север, Юг, Запад, Восток                                 | v1.1      |
| 28  | Количество санузлов | Range        | 1 - 3+                                                   | v1.1      |
| 29  | Тип окон            | Select       | Любой, Стандартные, Панорамные                           | v1.1      |
| 30  | Площадь балкона     | Range        | м²                                                       | v1.1      |

> **Примечание по отделке:** "White box" — это популярный тип отделки, когда стены и потолок подготовлены под финишную покраску, стяжка пола готова, разводка электрики и сантехники выполнена. Позволяет клиенту сделать ремонт "под себя" с минимальными затратами.

**РАСШИРЕННЫЕ ФИЛЬТРЫ — ДОМ (MVP/v1.1)**

| #   | Фильтр               | Тип          | Значения                                | Приоритет |
| --- | -------------------- | ------------ | --------------------------------------- | --------- |
| 31  | Тип дома             | Multi-select | Монолит, Кирпич, Панель, Кирпич-монолит | v1.1      |
| 32  | Этажность дома       | Range        | 1 - 50                                  | v1.1      |
| 33  | Класс жилья          | Multi-select | Эконом, Комфорт, Бизнес, Премиум, Элит  | v1.1      |
| 34  | Статус строительства | Multi-select | Строится, Сдан, Ключи выданы            | MVP       |
| 35  | Наличие ключей       | Toggle       | Ключи выданы (можно заселяться)         | MVP       |
| 36  | Старт продаж         | Date Range   | От-до                                   | v1.1      |
| 37  | Лифт                 | Toggle       | Есть                                    | v1.1      |
| 38  | Грузовой лифт        | Toggle       | Есть                                    | v1.1      |
| 39  | Мусоропровод         | Toggle       | Есть/Нет                                | v1.1      |
| 40  | Закрытый двор        | Toggle       | Есть                                    | v1.1      |
| 41  | Консьерж             | Toggle       | Есть                                    | v1.1      |
| 42  | Видеонаблюдение      | Toggle       | Есть                                    | v1.1      |
| 43  | Фасад                | Multi-select | Штукатурка, Вентилируемый, Клинкер      | v1.2      |

> **Примечание по статусу:** "Ключи выданы" — важный статус для клиентов, которым нужно заселиться в ближайшее время. Отличается от "Сдан" тем, что дом не только введён в эксплуатацию, но и идёт активная передача квартир собственникам.

**РАСШИРЕННЫЕ ФИЛЬТРЫ — ИНФРАСТРУКТУРА (v1.1)**

| #   | Фильтр           | Тип    | Значения                                        | Приоритет |
| --- | ---------------- | ------ | ----------------------------------------------- | --------- |
| 44  | Паркинг          | Select | Любой, Подземный, Наземный, Многоуровневый, Нет | v1.1      |
| 45  | Детский сад      | Toggle | В ЖК/рядом                                      | v1.1      |
| 46  | Школа            | Toggle | В ЖК/рядом                                      | v1.1      |
| 47  | Поликлиника      | Toggle | Рядом                                           | v1.1      |
| 48  | Супермаркет      | Toggle | В ЖК/рядом                                      | v1.1      |
| 49  | Фитнес           | Toggle | В ЖК                                            | v1.1      |
| 50  | Набережная/вода  | Toggle | Рядом (Нева, Залив, каналы)                     | v1.1      |
| 51  | Парк             | Toggle | Рядом                                           | v1.1      |
| 52  | Выезд на ЗСД/КАД | Toggle | Рядом (до 5 мин)                                | v1.1      |
| 53  | Аэропорт         | Toggle | Рядом (до 30 мин)                               | v1.2      |

**РАСШИРЕННЫЕ ФИЛЬТРЫ — ФИНАНСЫ (MVP/v1.1)**

| #   | Фильтр                      | Тип          | Значения                                                 | Приоритет |
| --- | --------------------------- | ------------ | -------------------------------------------------------- | --------- |
| 54  | Способ оплаты               | Multi-select | 100% оплата, Ипотека, Рассрочка                          | MVP       |
| 55  | Тип ипотеки                 | Multi-select | Господдержка, Семейная, IT-ипотека, Военная, Стандартная | v1.1      |
| 56  | Рассрочка                   | Toggle       | Доступна                                                 | v1.1      |
| 57  | Рассрочка 0%                | Toggle       | Беспроцентная                                            | v1.1      |
| 58  | Первый взнос от застройщика | Toggle       | ПВ можно внести частями                                  | v1.1      |
| 59  | Материнский капитал         | Toggle       | Принимают                                                | v1.1      |
| 60  | Скидки/акции                | Toggle       | Есть активные акции                                      | v1.1      |
| 61  | Trade-in                    | Toggle       | Принимают старую квартиру                                | v1.1      |

> **Примечание по ипотеке:**
>
> - **Господдержка** — ставка до 8% для всех (лимит 6 млн для СПб)
> - **Семейная** — от 6% для семей с детьми (лимит 12 млн)
> - **IT-ипотека** — от 5% для сотрудников IT-компаний (лимит 18 млн для СПб)
> - **Военная** — для военнослужащих по контракту
>   Ставки и лимиты актуальны на 2024-2025 год, могут меняться.

**ГЕОФИЛЬТРЫ (v1.1)**

| #   | Фильтр               | Тип          | Значения    | Приоритет |
| --- | -------------------- | ------------ | ----------- | --------- |
| 62  | Рисование области    | Draw polygon | На карте    | v1.1      |
| 63  | Радиус от точки      | Range + Map  | 0.5 - 10 км | v1.1      |
| 64  | Расстояние до центра | Range        | км          | v1.1      |

**СПЕЦИАЛЬНЫЕ ФИЛЬТРЫ ДЛЯ АГЕНТОВ (v1.1)**

| #   | Фильтр                 | Тип    | Значения                          | Приоритет |
| --- | ---------------------- | ------ | --------------------------------- | --------- |
| 65  | Комиссия агента        | Range  | 0 - 10%                           | v1.1      |
| 66  | Авансирование комиссии | Toggle | Есть (часть комиссии сразу)       | v1.1      |
| 67  | Горящие лоты           | Toggle | Скидка > 5%                       | v1.1      |
| 68  | Новые за N дней        | Select | 1, 3, 7, 14, 30 дней              | MVP       |
| 69  | Снижение цены          | Toggle | За последние 7/14/30 дней         | v1.1      |
| 70  | Повышение цены         | Toggle | За последние 7/14/30 дней         | v1.1      |
| 71  | Только мои брони       | Toggle | Квартиры, забронированные агентом | v1.1      |
| 72  | Показать брони всех    | Toggle | Показать забронированные квартиры | v1.1      |

> **Примечание для агентов:**
>
> - **Комиссия агента** — процент от сделки, который платит застройщик агенту. Обычно 1-5%, у некоторых застройщиков до 7-10%
> - **Авансирование** — застройщик выплачивает часть комиссии сразу после бронирования, не дожидаясь регистрации ДДУ
> - **Горящие лоты** — квартиры со значительной скидкой, обычно последние в корпусе или с особенностями (первый/последний этаж)

### 4.5 Система визуализации объектов

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ВИЗУАЛИЗАЦИЯ HOUSLER                                  │
│                    (ключевое конкурентное преимущество)                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  УРОВЕНЬ 1: БАЗОВАЯ ВИЗУАЛИЗАЦИЯ (MVP)                                 │
│  ─────────────────────────────────────────────────────────────────────  │
│  ✓ Планировка квартиры (2D из фида, tag="plan")                        │
│  ✓ Рендер/фото дома (tag="housemain")                                  │
│  ✓ Галерея изображений объекта                                         │
│  ✓ Карточка объекта с ключевыми характеристиками                       │
│                                                                         │
│  УРОВЕНЬ 2: РАСШИРЕННАЯ ВИЗУАЛИЗАЦИЯ (v1.1)                            │
│  ─────────────────────────────────────────────────────────────────────  │
│  ✓ Поэтажный план (tag="floorplan", 97.8% заполненность)               │
│  ✓ Схема расположения в ЖК (tag="complexscheme")                       │
│  ✓ Интерактивная шахматка ЖК                                           │
│  ✓ Сравнение планировок (наложение)                                    │
│                                                                         │
│  УРОВЕНЬ 3: ИНТЕРАКТИВНАЯ ВИЗУАЛИЗАЦИЯ (v1.2)                          │
│  ─────────────────────────────────────────────────────────────────────  │
│  ★ Интерактивный выбор на поэтажном плане                              │
│  ★ Клик по квартире → карточка с ценой и характеристиками              │
│  ★ Подсветка доступных/проданных квартир                               │
│  ★ Фильтрация прямо на плане этажа                                     │
│                                                                         │
│  УРОВЕНЬ 4: AI-ВИЗУАЛИЗАЦИЯ (v2.0)                                     │
│  ─────────────────────────────────────────────────────────────────────  │
│  ★ 3D-генерация из 2D планировки (AI)                                  │
│  ★ Виртуальная расстановка мебели                                      │
│  ★ Визуализация интерьера в разных стилях                              │
│  ★ AR-просмотр планировки                                              │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 4.5.1 Интерактивный выбор на поэтажном плане

```
┌─────────────────────────────────────────────────────────────────────────┐
│  ЖК "NEXT" — Корпус 1 — Этаж 10                    [← Этаж 9] [Этаж 11 →]│
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Фильтр: [Все] [1-комн] [2-комн] [3-комн]    Показать: [●Своб.] [○Прод.]│
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                  │   │
│  │     ┌──────┐   ┌──────┐   ┌──────────┐   ┌──────┐   ┌──────┐   │   │
│  │     │ 1001 │   │ 1002 │   │   1003   │   │ 1004 │   │ 1005 │   │   │
│  │     │ ──── │   │ ──── │   │   ────   │   │ ──── │   │ ──── │   │   │
│  │     │ СТ   │   │ 1К   │   │    2К    │   │ 1К   │   │ СТ   │   │   │
│  │     │28 м² │   │45 м² │   │  66 м²   │   │42 м² │   │26 м² │   │   │
│  │     │      │   │      │   │          │   │      │   │      │   │   │
│  │     │ 6.2М │   │ 9.5М │   │  15.2М   │   │ 8.9М │   │ПРОДАН│   │   │
│  │     │ [🟢] │   │ [🟢] │   │   [🟢]   │   │ [🟢] │   │ [⚫] │   │   │
│  │     └──────┘   └──────┘   └──────────┘   └──────┘   └──────┘   │   │
│  │                                                                  │   │
│  │              [ Л И Ф Т О В Ы Й   Х О Л Л ]                      │   │
│  │                                                                  │   │
│  │     ┌──────┐   ┌──────────┐   ┌──────┐   ┌──────────┐           │   │
│  │     │ 1006 │   │   1007   │   │ 1008 │   │   1009   │           │   │
│  │     │ ──── │   │   ────   │   │ ──── │   │   ────   │           │   │
│  │     │ 1К   │   │    3К    │   │ 2К   │   │    2К    │           │   │
│  │     │48 м² │   │  89 м²   │   │62 м² │   │  71 м²   │           │   │
│  │     │      │   │          │   │      │   │          │           │   │
│  │     │10.1М │   │  22.5М   │   │14.8М │   │  16.9М   │           │   │
│  │     │ [🟢] │   │   [🟡]   │   │ [🟢] │   │   [🟢]   │           │   │
│  │     └──────┘   └──────────┘   └──────┘   └──────────┘           │   │
│  │                                                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  🟢 Свободно (8)   🟡 Бронь (1)   ⚫ Продано (1)                       │
│                                                                         │
│  ───────────────────────────────────────────────────────────────────── │
│  Клик по квартире → всплывающая карточка с деталями и кнопкой         │
│  "Добавить в подборку"                                                 │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 4.5.2 Каталог планировок

```
┌─────────────────────────────────────────────────────────────────────────┐
│  КАТАЛОГ ПЛАНИРОВОК                                  [Список] [Каталог] │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ЖК "NEXT"  |  Все ЖК                                                  │
│                                                                         │
│  Фильтр: [Все] [Студии] [1-комн] [2-комн] [3-комн] [4+]               │
│                                                                         │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐        │
│  │  [ПЛАНИРОВКА]   │  │  [ПЛАНИРОВКА]   │  │  [ПЛАНИРОВКА]   │        │
│  │                 │  │                 │  │                 │        │
│  │  Студия А       │  │  Студия Б       │  │  1-комн A       │        │
│  │  26-28 м²       │  │  30-32 м²       │  │  42-45 м²       │        │
│  │  ──────────     │  │  ──────────     │  │  ──────────     │        │
│  │  от 5.8 млн ₽   │  │  от 6.9 млн ₽   │  │  от 9.2 млн ₽   │        │
│  │  223K ₽/м²      │  │  216K ₽/м²      │  │  219K ₽/м²      │        │
│  │                 │  │                 │  │                 │        │
│  │  Квартир: 45    │  │  Квартир: 32    │  │  Квартир: 78    │        │
│  │  Доступно: 12   │  │  Доступно: 8    │  │  Доступно: 23   │        │
│  │                 │  │                 │  │                 │        │
│  │  [Показать все] │  │  [Показать все] │  │  [Показать все] │        │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘        │
│                                                                         │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐        │
│  │  [ПЛАНИРОВКА]   │  │  [ПЛАНИРОВКА]   │  │  [ПЛАНИРОВКА]   │        │
│  │                 │  │                 │  │                 │        │
│  │  1-комн Б       │  │  2-комн A       │  │  2-комн Б       │        │
│  │  48-52 м²       │  │  58-62 м²       │  │  66-70 м²       │        │
│  │  ──────────     │  │  ──────────     │  │  ──────────     │        │
│  │  от 10.5 млн ₽  │  │  от 13.2 млн ₽  │  │  от 15.8 млн ₽  │        │
│  │  218K ₽/м²      │  │  228K ₽/м²      │  │  239K ₽/м²      │        │
│  │  ...            │  │  ...            │  │  ...            │        │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.6 AI-функции

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    AI-ФУНКЦИИ HOUSLER                                    │
│                    (уникальное конкурентное преимущество)                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ДЛЯ КЛИЕНТОВ:                                                         │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  1. AI-АССИСТЕНТ ПОИСКА (v1.1)                                         │
│     ┌───────────────────────────────────────────────────────────────┐  │
│     │  💬 "Найди 2-комнатную рядом с Парнасом до 10 млн с большой  │  │
│     │      кухней и балконом, желательно сдача в 2025"              │  │
│     │                                                                │  │
│     │  🤖 Нашёл 23 варианта. Показываю лучшие по соотношению       │  │
│     │     цена/качество. Средняя цена в этом районе 9.2 млн.       │  │
│     └───────────────────────────────────────────────────────────────┘  │
│     • Понимание естественного языка                                    │
│     • Преобразование в фильтры                                         │
│     • Подсказки и уточнения                                            │
│                                                                         │
│  2. УМНЫЕ РЕКОМЕНДАЦИИ (v1.2)                                          │
│     • "Похожие квартиры, которые смотрят люди с такими критериями"    │
│     • "Вам может понравиться" на основе истории просмотров            │
│     • "Цена снизилась" — уведомления об изменениях                    │
│                                                                         │
│  3. 3D-ВИЗУАЛИЗАЦИЯ ИЗ 2D (v2.0)                                       │
│     • Генерация 3D-модели квартиры из планировки                       │
│     • Виртуальная расстановка мебели                                   │
│     • "Покажи как будет выглядеть в скандинавском стиле"              │
│                                                                         │
│  ДЛЯ АГЕНТОВ:                                                          │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  4. AI-ПОДБОР ДЛЯ КЛИЕНТА (v1.1)                                       │
│     • "Собери подборку по этим критериям клиента"                      │
│     • Автоматическое ранжирование по релевантности                     │
│     • Учёт истории предпочтений клиента                                │
│                                                                         │
│  5. УМНЫЕ УВЕДОМЛЕНИЯ (v1.2)                                           │
│     • "Клиент 3 раза смотрел эту квартиру — предложи забронировать"   │
│     • "Появилась квартира под критерии клиента Иванова"               │
│     • "Цена снизилась на объект из подборки Петровой"                 │
│                                                                         │
│  6. АНАЛИЗ ПРЕДПОЧТЕНИЙ (v1.2)                                         │
│     • "Этот клиент смотрит квартиры с большой кухней — покажи такие"  │
│     • Автоматические теги: "важна кухня", "не первый этаж"            │
│     • Прогноз: какие объекты понравятся клиенту                        │
│                                                                         │
│  7. ГЕНЕРАЦИЯ ОПИСАНИЙ (v2.0)                                          │
│     • Автоматическое создание продающих описаний                       │
│     • Персонализация под целевую аудиторию                             │
│     • SEO-оптимизация                                                   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 4.6.1 Технологии AI

| Функция              | Технология                           | Сложность | Приоритет |
| -------------------- | ------------------------------------ | --------- | --------- |
| AI-ассистент поиска  | LLM (Claude/GPT) + NLP               | Средняя   | v1.1      |
| Умные рекомендации   | Collaborative filtering              | Средняя   | v1.2      |
| 3D из 2D             | Stable Diffusion / специализ. модели | Высокая   | v2.0      |
| AI-подбор для агента | LLM + векторный поиск                | Средняя   | v1.1      |
| Умные уведомления    | Rule engine + ML                     | Низкая    | v1.2      |
| Анализ предпочтений  | Кластеризация + ML                   | Средняя   | v1.2      |
| Генерация описаний   | LLM (Claude/GPT)                     | Низкая    | v2.0      |

### 4.7 CRM-воронка для агентов

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    CRM-ВОРОНКА АГЕНТА                                    │
│                    (по образцу TrendAgent)                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ЭТАПЫ ВОРОНКИ:                                                        │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐  │
│  │ПРОСМОТРЫ│ → │ФИКСАЦИИ │ → │  БРОНИ  │ → │ СДЕЛКИ  │   │ СРЫВЫ   │  │
│  │         │   │  ЦЕНЫ   │   │         │   │         │   │         │  │
│  └─────────┘   └─────────┘   └─────────┘   └─────────┘   └─────────┘  │
│       │             │             │             │             ↑        │
│       │             │             │             │             │        │
│       └─────────────┴─────────────┴─────────────┴─────────────┘        │
│                         (на любом этапе может сорваться)               │
│                                                                         │
│  1. ПРОСМОТРЫ (автоматически)                                          │
│     ─────────────────────────────────────────────────────────────────  │
│     • Клиент открыл ссылку на подборку                                 │
│     • Какие объекты просматривал                                       │
│     • Сколько времени провёл на каждом                                 │
│     • Что отметил (лайк/дизлайк)                                       │
│     • Что добавил сам                                                   │
│                                                                         │
│     Агент видит:                                                        │
│     ┌───────────────────────────────────────────────────────────────┐  │
│     │  Мария С. (maria@mail.ru)                         🟢 Онлайн   │  │
│     │  ─────────────────────────────────────────────────────────── │  │
│     │  Просмотров подборки: 7                                       │  │
│     │  Последний визит: сегодня, 14:30 (был 12 мин)                │  │
│     │  Смотрел: 2-комн ЖК NEXT (3 раза!), 1-комн Новатория         │  │
│     │  Добавил: Студия ЖК OKLA                                      │  │
│     │  Отметил ✓: 2 объекта  |  Отклонил ✗: 1 объект               │  │
│     └───────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  2. ФИКСАЦИЯ ЦЕНЫ (v1.1)                                               │
│     ─────────────────────────────────────────────────────────────────  │
│     Агент запрашивает у застройщика "придержать" квартиру             │
│     на N дней пока клиент принимает решение.                          │
│                                                                         │
│     Зачем это нужно:                                                   │
│     • Цена может измениться (застройщик повысит)                       │
│     • Квартиру могут забронировать другие                              │
│     • Клиенту нужно время на одобрение ипотеки                         │
│                                                                         │
│     Статусы фиксации:                                                  │
│     • pending — отправлена оператору                                   │
│     • approved — застройщик подтвердил (срок N дней)                   │
│     • expired — срок истёк                                             │
│     • converted — перешла в бронь                                      │
│     • cancelled — отменена агентом/клиентом                            │
│                                                                         │
│     ┌───────────────────────────────────────────────────────────────┐  │
│     │  ФОРМА ФИКСАЦИИ ЦЕНЫ                                          │  │
│     │  ─────────────────────────────────────────────────────────── │  │
│     │  Объект:    2-комн, 66 м², ЖК "NEXT" — 15.2 млн ₽            │  │
│     │  Клиент:    [Мария Смирнова_______] [+7 911 222-33-44]       │  │
│     │  Срок:      [7 дней ▼]                                        │  │
│     │  Причина:   [Ждём одобрения ипотеки_______________]          │  │
│     │                                                               │  │
│     │  [Отмена]                     [Запросить фиксацию]           │  │
│     └───────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  3. БРОНИ (уже реализовано в базовой модели)                           │
│     ─────────────────────────────────────────────────────────────────  │
│     Агент бронирует квартиру с данными клиента → заявка оператору     │
│                                                                         │
│  4. СДЕЛКИ (v1.1)                                                      │
│     ─────────────────────────────────────────────────────────────────  │
│     Успешная бронь переходит в сделку:                                 │
│     • Подписание ДДУ/ДКП                                               │
│     • Регистрация в Росреестре                                         │
│     • Расчёт и выплата комиссии агенту                                 │
│                                                                         │
│     Статусы сделки:                                                    │
│     • contract_signing — на подписании договора                        │
│     • registered — зарегистрирована                                    │
│     • completed — завершена, комиссия выплачена                        │
│                                                                         │
│  5. СРЫВЫ (v1.1)                                                       │
│     ─────────────────────────────────────────────────────────────────  │
│     Важно фиксировать причины срыва для аналитики:                     │
│     • Клиент передумал                                                 │
│     • Не одобрили ипотеку                                              │
│     • Выбрал другой объект                                             │
│     • Ушёл к другому агенту                                            │
│     • Застройщик отменил бронь                                         │
│     • Другое                                                            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 4.7.1 Дашборд воронки для агента

```
┌─────────────────────────────────────────────────────────────────────────┐
│  ДАШБОРД АГЕНТА                                          Ноябрь 2025   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ВОРОНКА ПРОДАЖ                                                        │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                                                                   │  │
│  │   ПОДБОРКИ    ПРОСМОТРЫ    ФИКСАЦИИ    БРОНИ    СДЕЛКИ          │  │
│  │      12    →     8     →     4     →    2    →    1              │  │
│  │   (100%)       (67%)       (33%)      (17%)     (8%)             │  │
│  │                                                                   │  │
│  │   ████████████████████████████████████████████████               │  │
│  │   ████████████████████████████████                               │  │
│  │   ████████████████                                               │  │
│  │   ████████                                                       │  │
│  │   ████                                                           │  │
│  │                                                                   │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  ТРЕБУЮТ ВНИМАНИЯ                                                      │
│  ─────────────────────────────────────────────────────────────────────  │
│  🔴 Фиксация истекает завтра: Мария С., 2-комн ЖК NEXT                │
│  🟡 Нет активности 3 дня: Алексей К., подборка #45                    │
│  🟢 Клиент сейчас онлайн: Елена В., смотрит подборку                  │
│                                                                         │
│  СТАТИСТИКА ЗА МЕСЯЦ                                                   │
│  ─────────────────────────────────────────────────────────────────────  │
│  Конверсия подборка→сделка: 8%                                         │
│  Средний чек: 12.5 млн ₽                                               │
│  Комиссия к получению: 245 000 ₽                                       │
│  Комиссия выплачена: 180 000 ₽                                         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.8 Ипотечный калькулятор

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ИПОТЕЧНЫЙ КАЛЬКУЛЯТОР                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ЗАЧЕМ НУЖЕН:                                                          │
│  • Клиент сразу видит ежемесячный платёж (психологически легче)        │
│  • Агент может "продать" через доступный платёж, а не общую сумму      │
│  • Повышает конверсию: "300K/мес" проще осмыслить чем "15 млн"         │
│                                                                         │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  УРОВЕНЬ 1: ПРОСТОЙ КАЛЬКУЛЯТОР (MVP)                                  │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │  ИПОТЕЧНЫЙ КАЛЬКУЛЯТОР                                            │ │
│  │  ─────────────────────────────────────────────────────────────── │ │
│  │                                                                    │ │
│  │  Стоимость квартиры         [15 200 000] ₽                        │ │
│  │                              ────────────────────────●────        │ │
│  │                              5 млн                      50 млн    │ │
│  │                                                                    │ │
│  │  Первоначальный взнос       [3 040 000] ₽  (20%)                  │ │
│  │                              ──────●─────────────────────────     │ │
│  │                              10%                           50%    │ │
│  │                                                                    │ │
│  │  Срок кредита               [20 лет]                              │ │
│  │                              ──────────────●──────────────────    │ │
│  │                              5 лет                       30 лет   │ │
│  │                                                                    │ │
│  │  Процентная ставка          [18.5] %                              │ │
│  │                              ──────────────────●──────────────    │ │
│  │                              8%                            25%    │ │
│  │                                                                    │ │
│  │  ═══════════════════════════════════════════════════════════════ │ │
│  │                                                                    │ │
│  │  Сумма кредита:             12 160 000 ₽                          │ │
│  │  Ежемесячный платёж:        192 847 ₽                             │ │
│  │  Переплата за весь срок:    34 123 280 ₽                          │ │
│  │                                                                    │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  Формула аннуитетного платежа:                                         │
│  P = S × (r × (1+r)^n) / ((1+r)^n - 1)                                 │
│  где S = сумма кредита, r = месячная ставка, n = срок в месяцах       │
│                                                                         │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  УРОВЕНЬ 2: С ПРОГРАММАМИ БАНКОВ (v1.1)                                │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │  ВЫБЕРИТЕ ПРОГРАММУ                                               │ │
│  │  ─────────────────────────────────────────────────────────────── │ │
│  │                                                                    │ │
│  │  ○ Стандартная ипотека          от 18.5%                         │ │
│  │  ○ Семейная ипотека             6% (при наличии детей)           │ │
│  │  ● IT-ипотека                   5% (для IT-специалистов)         │ │
│  │  ○ Военная ипотека              специальные условия              │ │
│  │  ○ Субсидия от застройщика      от 0.1% (первый год)             │ │
│  │                                                                    │ │
│  │  ─────────────────────────────────────────────────────────────── │ │
│  │                                                                    │ │
│  │  При IT-ипотеке (5%):                                             │ │
│  │  Ежемесячный платёж:        79 836 ₽  (экономия 112 911 ₽/мес)   │ │
│  │  Переплата:                  7 080 640 ₽  (экономия 27 млн!)     │ │
│  │                                                                    │ │
│  │  Банки с IT-ипотекой:                                             │ │
│  │  • Сбербанк — от 5%, до 18 млн                                    │ │
│  │  • ВТБ — от 4.7%, до 18 млн                                       │ │
│  │  • Альфа-Банк — от 5.5%, до 12 млн                                │ │
│  │                                                                    │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  ИНТЕГРАЦИЯ В КАРТОЧКУ ОБЪЕКТА:                                        │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │  15 200 000 ₽                                                     │ │
│  │  230 000 ₽/м²                                                     │ │
│  │  ─────────────────────────────────────────────────────────────── │ │
│  │  💳 от 79 836 ₽/мес при IT-ипотеке 5%                            │ │
│  │     [Рассчитать ипотеку]                                          │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 4.8.1 Источники данных по ипотечным ставкам

| Источник               | Способ обновления | Частота           | Приоритет |
| ---------------------- | ----------------- | ----------------- | --------- |
| Ручной ввод оператором | Админка           | По мере изменений | MVP       |
| Парсинг сайтов банков  | Автоматически     | Ежедневно         | v1.2      |
| API ипотечных брокеров | Интеграция        | Реалтайм          | v2.0      |

### 4.9 Файлы застройщиков и банков

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ФАЙЛЫ ЗАСТРОЙЩИКОВ                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ЗАЧЕМ НУЖНО:                                                          │
│  • Агент не ищет документы в почте/мессенджерах                        │
│  • Всё в одном месте: регламенты, договоры, презентации                │
│  • Профессиональный вид перед клиентом                                  │
│  • Актуальные версии документов (не устаревшие)                        │
│                                                                         │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  СТРУКТУРА ФАЙЛОВ:                                                     │
│                                                                         │
│  📁 Застройщики                                                        │
│  ├── 📁 ГК Еврострой                                                   │
│  │   ├── 📁 Общие документы                                            │
│  │   │   ├── 📄 Регламент взаимодействия.pdf                           │
│  │   │   ├── 📄 Комиссии и условия.pdf                                 │
│  │   │   └── 📄 Контакты менеджеров.pdf                                │
│  │   ├── 📁 ЖК NEXT                                                    │
│  │   │   ├── 📄 Презентация ЖК.pdf                                     │
│  │   │   ├── 📄 Разрешение на строительство.pdf                        │
│  │   │   ├── 📄 Проектная декларация.pdf                               │
│  │   │   ├── 📄 Шаблон ДДУ.docx                                        │
│  │   │   └── 📄 Планировки (выгрузка).xlsx                             │
│  │   └── 📁 ЖК Новатория                                               │
│  │       └── ...                                                        │
│  ├── 📁 Setl Group                                                     │
│  │   └── ...                                                            │
│  └── 📁 ЛСР                                                            │
│      └── ...                                                            │
│                                                                         │
│  📁 Банки                                                               │
│  ├── 📁 Сбербанк                                                       │
│  │   ├── 📄 Перечень документов.pdf                                    │
│  │   ├── 📄 Справка о доходах (образец).docx                           │
│  │   ├── 📄 Анкета заёмщика.pdf                                        │
│  │   └── 📄 IT-ипотека условия.pdf                                     │
│  ├── 📁 ВТБ                                                            │
│  │   └── ...                                                            │
│  └── 📁 Альфа-Банк                                                     │
│      └── ...                                                            │
│                                                                         │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  КТО ЗАГРУЖАЕТ ФАЙЛЫ:                                                  │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  v1.1: Оператор вручную через админку                                  │
│  v1.2: Застройщик сам через отдельный кабинет                          │
│  v2.0: Автоматическая синхронизация с FTP/API застройщика              │
│                                                                         │
│  КАТЕГОРИИ ДОКУМЕНТОВ:                                                 │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  • regulations — Регламенты взаимодействия                              │
│  • presentations — Презентации и маркетинговые материалы               │
│  • permits — Разрешительная документация                                │
│  • contracts — Шаблоны договоров (ДДУ, ДКП)                             │
│  • price_lists — Прайс-листы и шахматки                                 │
│  • other — Прочие документы                                             │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 4.9.1 Wireframe: Раздел "Файлы" в кабинете агента

```
┌─────────────────────────────────────────────────────────────────────────┐
│  ФАЙЛЫ                                               🔍 Поиск документа │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  [Застройщики]  [Банки]                                                │
│                                                                         │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  📁 ГК Еврострой                                              [▼]      │
│  ├── 📁 Общие документы (3 файла)                                      │
│  └── 📁 ЖК NEXT (5 файлов)                                    [▶]      │
│                                                                         │
│  📁 Setl Group                                                [▶]      │
│  📁 ЛСР                                                       [▶]      │
│  📁 ПИК                                                       [▶]      │
│  📁 Группа ЦДС                                                [▶]      │
│                                                                         │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  📁 ЖК NEXT развёрнуто:                                                │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  │ Название                        │ Тип  │ Размер │ Обновлён        │ │
│  ├─────────────────────────────────────────────────────────────────── │ │
│  │ 📄 Презентация ЖК NEXT          │ PDF  │ 12 МБ  │ 15.11.2025      │ │
│  │ 📄 Разрешение на строительство  │ PDF  │ 2 МБ   │ 01.09.2024      │ │
│  │ 📄 Проектная декларация         │ PDF  │ 5 МБ   │ 01.10.2025      │ │
│  │ 📄 Шаблон ДДУ                   │ DOCX │ 156 КБ │ 20.11.2025      │ │
│  │ 📄 Планировки (выгрузка)        │ XLSX │ 3 МБ   │ 28.11.2025      │ │
│                                                                         │
│  [📥 Скачать все]                                                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.10 Статистика просмотров клиентом

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    СТАТИСТИКА ПРОСМОТРОВ                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ЗАЧЕМ НУЖНО:                                                          │
│  • Агент понимает "горячесть" клиента                                  │
│  • Видит какие объекты интересны → предлагает похожие                  │
│  • Знает когда клиент активен → когда звонить                          │
│  • Видит сигналы к покупке ("смотрел 3 раза")                          │
│                                                                         │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  УРОВЕНЬ 1: БАЗОВАЯ СТАТИСТИКА (MVP)                                   │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  Что отслеживаем:                                                      │
│  • Дата/время последнего визита                                        │
│  • Количество просмотров подборки                                       │
│  • Какие объекты открывал (список ID)                                  │
│  • Что отметил: лайк ✓, дизлайк ✗                                      │
│  • Что добавил сам (added_by = 'client')                               │
│                                                                         │
│  Как храним:                                                           │
│  • selections.views_count — счётчик просмотров                          │
│  • selections.last_client_activity_at — последняя активность           │
│  • selection_items.client_reaction — реакции                            │
│  • selection_items.added_by — кто добавил                               │
│                                                                         │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  УРОВЕНЬ 2: ДЕТАЛЬНАЯ АНАЛИТИКА (v1.1)                                 │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  Дополнительно отслеживаем:                                            │
│  • Время на каждом объекте (секунды)                                   │
│  • Какие фото/планировки открывал                                      │
│  • Использовал ли калькулятор ипотеки                                  │
│  • С какого устройства смотрел                                          │
│  • История всех визитов (не только последний)                          │
│                                                                         │
│  Как храним:                                                           │
│  • Новая таблица selection_views с детальной информацией               │
│  • Агрегированная статистика для быстрого отображения                  │
│                                                                         │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  УРОВЕНЬ 3: УМНЫЕ УВЕДОМЛЕНИЯ (v1.2)                                   │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  Автоматические уведомления агенту:                                    │
│  • 🔔 "Клиент сейчас смотрит подборку" (realtime)                      │
│  • 🔔 "Клиент смотрел 2-комн ЖК NEXT уже 3 раза" (hot lead)           │
│  • 🔔 "Клиент добавил новый объект в подборку"                         │
│  • 🔔 "Клиент не заходил 5 дней" (остывает)                            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 4.10.1 Виджет активности клиента

```
┌─────────────────────────────────────────────────────────────────────────┐
│  Подборка для Марии С.                                    🟢 Онлайн     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  АКТИВНОСТЬ КЛИЕНТА                                                    │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  Просмотров: 7           Последний визит: сейчас (2 мин назад)         │
│  Провёл времени: 47 мин  Устройство: iPhone                            │
│                                                                         │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  ИНТЕРЕС ПО ОБЪЕКТАМ:                                                  │
│                                                                         │
│  │ Объект                        │ Просм. │ Время │ Реакция │ Сигнал │ │
│  ├────────────────────────────────────────────────────────────────── │ │
│  │ 🔥 2-комн ЖК NEXT, 66 м²      │   5    │ 18 мин │   ✓    │ HOT!  │ │
│  │    1-комн Новатория, 45 м²    │   2    │  8 мин │   ✓    │       │ │
│  │    Студия OKLA, 28 м²         │   1    │  3 мин │   —    │       │ │
│  │ ❌ 2-комн Дубровский, 58 м²   │   1    │  1 мин │   ✗    │       │ │
│  │ 🆕 1-комн Энфилд (добавил)    │   —    │  — мин │   —    │  NEW  │ │
│                                                                         │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  ИНСАЙТЫ:                                                              │
│  💡 Клиент интересуется 2-комнатными в Василеостровском районе         │
│  💡 Важна большая площадь (смотрит от 60 м²)                           │
│  💡 Активен вечером (18:00-22:00)                                      │
│                                                                         │
│  [📞 Позвонить клиенту]   [💬 Написать в Telegram]                     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.12 Юридические типы сделок

Один из ключевых аспектов, отличающих профессиональный B2B-инструмент от массовых площадок — понимание юридических нюансов сделок с первичной недвижимостью.

#### 4.12.1 Типы договоров и их особенности

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ТИПЫ СДЕЛОК НА ПЕРВИЧНОМ РЫНКЕ                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  1. ДДУ (Договор долевого участия)                                     │
│  ═══════════════════════════════════════════════════════════════════   │
│  Покупатель → Застройщик                                               │
│                                                                         │
│  Особенности:                                                          │
│  • Самый безопасный тип сделки                                         │
│  • С 01.07.2019 обязательно через эскроу-счёт                         │
│  • Деньги покупателя защищены до сдачи дома                           │
│  • Регистрация в Росреестре                                            │
│  • Застройщик — юридическое лицо                                       │
│                                                                         │
│  Риски: Минимальные при наличии эскроу                                 │
│                                                                         │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  2. УСТУПКА (Цессия) от юридического лица                              │
│  ═══════════════════════════════════════════════════════════════════   │
│  Покупатель → Юр.лицо (инвестор) → [ранее] Застройщик                 │
│                                                                         │
│  Особенности:                                                          │
│  • Юр.лицо ранее купило квартиру у застройщика по ДДУ                 │
│  • Теперь перепродаёт право требования                                 │
│  • Цена может быть выше/ниже, чем у застройщика                       │
│  • Эскроу НЕ распространяется (деньги идут продавцу)                  │
│  • Нужно проверить: оплатил ли продавец застройщику                   │
│                                                                         │
│  Риски: Средние — нужна проверка документов                           │
│                                                                         │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  3. УСТУПКА от физического лица                                        │
│  ═══════════════════════════════════════════════════════════════════   │
│  Покупатель → Физ.лицо (частный инвестор) → [ранее] Застройщик        │
│                                                                         │
│  Особенности:                                                          │
│  • Физлицо ранее купило квартиру (для себя или инвестиции)            │
│  • Перепродаёт право требования                                        │
│  • Часто — ниже рынка (срочная продажа)                               │
│  • Или выше (спекуляция на росте цен)                                 │
│  • Эскроу НЕ распространяется                                         │
│  • Налог 13% платит продавец (часть могут переложить на покупателя)   │
│                                                                         │
│  Риски: Повышенные — банкротство физлица, семейные споры              │
│                                                                         │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  4. ПЕРЕУСТУПКА (от застройщика юр.лицу, затем покупателю)            │
│  ═══════════════════════════════════════════════════════════════════   │
│  Покупатель → Юр.лицо (аффилированное с застройщиком) → Застройщик    │
│                                                                         │
│  Особенности:                                                          │
│  • Схема оптимизации у застройщика                                    │
│  • Формально — уступка, но продавец связан с застройщиком             │
│  • Цена обычно такая же, как по ДДУ                                   │
│  • Эскроу может НЕ действовать                                        │
│                                                                         │
│  Риски: Зависят от репутации застройщика                              │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 4.12.2 Эскроу-счёт

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          ЧТО ТАКОЕ ЭСКРОУ                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Эскроу-счёт — специальный банковский счёт, на котором хранятся        │
│  деньги покупателя до момента сдачи дома.                              │
│                                                                         │
│  ┌─────────────┐      ┌─────────────┐      ┌─────────────┐             │
│  │  ПОКУПАТЕЛЬ │ ───► │    БАНК     │ ───► │ ЗАСТРОЙЩИК │             │
│  │             │      │  (эскроу)   │      │             │             │
│  └─────────────┘      └─────────────┘      └─────────────┘             │
│         │                    │                    │                     │
│    Вносит деньги      Хранит до сдачи     Получает после              │
│                        дома в эксплуат.   ввода в эксплуат.           │
│                                                                         │
│  КОГДА ОБЯЗАТЕЛЬНО:                                                    │
│  • Все ДДУ с разрешением на строительство после 01.07.2019            │
│                                                                         │
│  КОГДА НЕТ ЭСКРОУ:                                                     │
│  • Старые проекты (разрешение до 01.07.2019)                          │
│  • Уступки (деньги идут продавцу напрямую)                            │
│  • Покупка готового жилья (КП вместо ДДУ)                             │
│                                                                         │
│  ВАЖНО ДЛЯ UI:                                                         │
│  • Обязательно показывать наличие/отсутствие эскроу                   │
│  • Для уступок — предупреждение "Средства не защищены эскроу"         │
│  • Цветовая индикация: 🟢 Эскроу  🟡 Нет эскроу                       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 4.12.3 Апартаменты vs Квартиры

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    АПАРТАМЕНТЫ VS КВАРТИРЫ                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Параметр              │ Квартира           │ Апартаменты              │
│  ──────────────────────┼────────────────────┼──────────────────────────│
│  Юридический статус    │ Жилое помещение    │ Нежилое помещение        │
│  Прописка              │ ✅ Постоянная      │ ❌ Только временная      │
│  Налог на имущество    │ 0.1-0.3%           │ 0.5-2.0% (в 5-7 раз ↑)   │
│  Тарифы ЖКХ            │ Жилые              │ Коммерческие (выше)      │
│  Ипотечные программы   │ Все                │ Не все (без господдержки)│
│  Материнский капитал   │ ✅ Можно           │ ❌ Нельзя                │
│  Военная ипотека       │ ✅ Можно           │ ❌ Нельзя                │
│  Нормы инсоляции       │ Обязательны        │ Не обязательны           │
│  Цена                  │ Выше               │ Обычно на 10-20% ниже    │
│                                                                         │
│  КОГДА АПАРТАМЕНТЫ ПОДХОДЯТ:                                           │
│  • Инвестиционная покупка (сдавать в аренду)                          │
│  • Уже есть прописка в другом месте                                   │
│  • Нет детей школьного возраста                                       │
│  • Важна локация (центр, набережная) при ограниченном бюджете         │
│                                                                         │
│  ВАЖНО ДЛЯ UI:                                                         │
│  • Чёткое визуальное разделение: [Квартира] vs [Апартаменты]          │
│  • При фильтрации по ипотеке — предупреждать о недоступности программ │
│  • В карточке — блок "Особенности апартаментов" с предупреждениями    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 4.12.4 Прописка (регистрация)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ПРОПИСКА: СПБ VS ЛЕНОБЛАСТЬ                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Многие новостройки, которые маркетируются как "СПб", находятся        │
│  в Ленинградской области (Мурино, Кудрово, Янино, Бугры и др.)        │
│                                                                         │
│  Что даёт прописка в СПб:                                              │
│  • Места в школах/детсадах СПб (приоритет)                            │
│  • Поликлиники СПб                                                     │
│  • Социальные льготы СПб (при наличии)                                │
│  • Налоговые вычеты по ставкам СПб                                    │
│                                                                         │
│  Прописка в ЛО:                                                        │
│  • Школы/детсады ЛО (часто переполнены в новых районах)               │
│  • Поликлиники ЛО                                                      │
│  • Другие ставки налогов                                               │
│                                                                         │
│  КАК ОПРЕДЕЛЯЕМ:                                                       │
│  • По адресу: "Ленинградская область" → registration_region = 'lo'    │
│  • По адресу: "Санкт-Петербург" → registration_region = 'spb'         │
│  • Апартаменты: прописка невозможна → отдельный флаг                  │
│                                                                         │
│  ПОГРАНИЧНЫЕ СЛУЧАИ:                                                   │
│  • Некоторые районы административно относятся к СПб, но далеко:       │
│    Пушкинский, Колпинский, Курортный районы — это СПб                 │
│  • Всеволожский, Ломоносовский районы — ЛО, даже если рядом с городом│
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 4.12.5 Влияние на бизнес-логику системы

```
┌─────────────────────────────────────────────────────────────────────────┐
│                ВЗАИМОСВЯЗИ ЮРИДИЧЕСКИХ ПАРАМЕТРОВ                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  1. ФИЛЬТРАЦИЯ:                                                        │
│  ─────────────────────────────────────────────────────────────────────  │
│  • Если выбран тип ипотеки "Семейная" или "Господдержка":             │
│    → Автоматически исключаем апартаменты (недоступны)                 │
│    → Показываем предупреждение если апартаменты были в выборке        │
│                                                                         │
│  • Если выбран банк для фильтрации:                                    │
│    → Показываем только аккредитованные ЖК                             │
│    → Если ЖК не аккредитован — показывать, но с предупреждением       │
│                                                                         │
│  2. БРОНИРОВАНИЕ:                                                      │
│  ─────────────────────────────────────────────────────────────────────  │
│  • Форма бронирования зависит от типа сделки:                         │
│    ДДУ → стандартная форма                                            │
│    Уступка → дополнительные поля (данные продавца)                    │
│                                                                         │
│  • Предупреждения в форме:                                             │
│    ⚠️ "Сделка без эскроу — средства не защищены"                      │
│    ⚠️ "Апартаменты — постоянная прописка невозможна"                  │
│    ⚠️ "Уступка от физ.лица — рекомендуем юридическую проверку"        │
│                                                                         │
│  3. ПОДБОРКИ:                                                          │
│  ─────────────────────────────────────────────────────────────────────  │
│  • Агент может фильтровать подборку по юр. параметрам:                │
│    "Показать клиенту только ДДУ с эскроу"                             │
│    "Исключить апартаменты (клиенту нужна прописка)"                   │
│                                                                         │
│  4. ОТОБРАЖЕНИЕ В КАРТОЧКЕ:                                           │
│  ─────────────────────────────────────────────────────────────────────  │
│  • Блок юридической информации (всегда видимый):                      │
│                                                                         │
│    ┌─────────────────────────────────────────────────────────────┐    │
│    │  ЮРИДИЧЕСКАЯ ИНФОРМАЦИЯ                                      │    │
│    ├─────────────────────────────────────────────────────────────┤    │
│    │  Тип сделки:    [ДДУ]                                       │    │
│    │  Эскроу:        ✅ Да (Сбербанк)                            │    │
│    │  Тип объекта:   Квартира                                    │    │
│    │  Прописка:      Санкт-Петербург                             │    │
│    │  Договор:       ДДУ с застройщиком "ГК ПИК"                 │    │
│    └─────────────────────────────────────────────────────────────┘    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 4.12.6 Источники данных

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ОТКУДА БЕРЁМ ЮРИДИЧЕСКИЕ ДАННЫЕ                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Параметр              │ Источник                    │ Надёжность      │
│  ──────────────────────┼─────────────────────────────┼─────────────────│
│  Тип сделки (ДДУ/...)  │ Вручную оператором или      │ Средняя         │
│                        │ парсинг description         │                 │
│  ──────────────────────┼─────────────────────────────┼─────────────────│
│  Эскроу                │ Автоматически по дате       │ Высокая         │
│                        │ разрешения на строительство │                 │
│  ──────────────────────┼─────────────────────────────┼─────────────────│
│  Апартаменты           │ XML: category="апартаменты" │ Высокая         │
│  ──────────────────────┼─────────────────────────────┼─────────────────│
│  Регион прописки       │ Парсинг адреса              │ Высокая         │
│                        │ (Санкт-Петербург / Лен.обл) │                 │
│  ──────────────────────┼─────────────────────────────┼─────────────────│
│  Аккредитация банка    │ Справочник (вручную)        │ Требует         │
│                        │                             │ актуализации    │
│                                                                         │
│  СТРАТЕГИЯ ЗАПОЛНЕНИЯ:                                                 │
│  1. MVP: Парсим что можем из XML + адреса                             │
│  2. v1.1: Оператор заполняет справочники по застройщикам              │
│  3. v1.2: Интеграция с ЕИСЖС для проверки эскроу                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.13 Евро-форматы комнатности

Евро-планировки — современный тренд в новостройках, когда кухня объединена с гостиной зоной, образуя единое пространство. Это позволяет эффективнее использовать площадь и создаёт ощущение большего пространства.

#### 4.13.1 Типы планировок

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    КЛАССИФИКАЦИЯ ПЛАНИРОВОК                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Код    │ Название              │ Структура                            │
│  ───────┼───────────────────────┼──────────────────────────────────────│
│  studio │ Студия                │ Единое пространство (кухня + жилая)  │
│  1      │ 1-комнатная           │ 1 комната + отдельная кухня          │
│  1e     │ Евро-двушка (1Е)      │ 1 спальня + кухня-гостиная           │
│  2      │ 2-комнатная           │ 2 комнаты + отдельная кухня          │
│  2e     │ Евро-трёшка (2Е)      │ 2 спальни + кухня-гостиная           │
│  3      │ 3-комнатная           │ 3 комнаты + отдельная кухня          │
│  3e     │ Евро-четырёшка (3Е)   │ 3 спальни + кухня-гостиная           │
│  4      │ 4-комнатная           │ 4 комнаты + отдельная кухня          │
│  4+     │ 5 и более комнат      │ Многокомнатные                       │
│                                                                         │
│  ВИЗУАЛЬНОЕ СРАВНЕНИЕ:                                                 │
│                                                                         │
│  КЛАССИЧЕСКАЯ 1-КОМНАТНАЯ:          ЕВРО-ДВУШКА (1Е):                  │
│  ┌─────────┬────────┐               ┌─────────┬────────────────┐       │
│  │         │        │               │         │                │       │
│  │ Комната │ Кухня  │               │ Спальня │ Кухня-гостиная │       │
│  │         │        │               │         │                │       │
│  └─────────┴────────┘               └─────────┴────────────────┘       │
│  ~35-45 м²                          ~40-55 м²                          │
│  1 комната для жизни                1 спальня + большая общая зона     │
│                                                                         │
│  КЛАССИЧЕСКАЯ 2-КОМНАТНАЯ:          ЕВРО-ТРЁШКА (2Е):                  │
│  ┌───────┬───────┬──────┐           ┌───────┬───────┬──────────┐       │
│  │       │       │      │           │       │       │          │       │
│  │Комн.1 │Комн.2 │Кухня │           │Спал.1 │Спал.2 │ Кухня-   │       │
│  │       │       │      │           │       │       │ гостиная │       │
│  └───────┴───────┴──────┘           └───────┴───────┴──────────┘       │
│  ~50-65 м²                          ~55-75 м²                          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 4.13.2 Преимущества и недостатки

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ЕВРО-ПЛАНИРОВКИ: ЗА И ПРОТИВ                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ПРЕИМУЩЕСТВА:                                                         │
│  ✅ Ощущение большего пространства                                     │
│  ✅ Больше естественного света (меньше стен)                           │
│  ✅ Удобно для семей с детьми (видно ребёнка из кухни)                 │
│  ✅ Современный дизайн                                                  │
│  ✅ Эффективное использование площади                                  │
│  ✅ Обычно дешевле классической на 1 комнату больше                    │
│                                                                         │
│  НЕДОСТАТКИ:                                                           │
│  ❌ Запахи из кухни распространяются по квартире                       │
│  ❌ Шум от готовки/телевизора мешает спящим                            │
│  ❌ Меньше приватности                                                  │
│  ❌ Нужна мощная вытяжка                                               │
│  ❌ Сложнее разместить гостей на ночь                                  │
│                                                                         │
│  КОМУ ПОДХОДИТ:                                                        │
│  • Молодые пары без детей или с маленьким ребёнком                    │
│  • Люди, которые редко готовят дома                                   │
│  • Любители открытых пространств и лофт-стиля                         │
│                                                                         │
│  КОМУ НЕ ПОДХОДИТ:                                                     │
│  • Семьи с разным режимом дня (кто-то работает из дома)              │
│  • Люди, кто много готовит                                            │
│  • Те, кому важна приватность каждой комнаты                          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 4.13.3 Определение типа планировки

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    КАК ОПРЕДЕЛЯЕМ ТИП ПЛАНИРОВКИ                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ПРОБЛЕМА: В XML-фиде нет явного поля "евро-планировка"                │
│                                                                         │
│  РЕШЕНИЕ — МНОГОУРОВНЕВОЕ ОПРЕДЕЛЕНИЕ:                                 │
│                                                                         │
│  Уровень 1: Парсинг description (точность ~70%)                        │
│  ─────────────────────────────────────────────────────────────────────  │
│  Ищем ключевые слова:                                                  │
│  • "евро", "европланировка", "евро-двушка", "евро-трёшка"             │
│  • "кухня-гостиная", "кухня гостиная", "совмещённая кухня"            │
│  • "open space", "открытая планировка"                                │
│                                                                         │
│  Уровень 2: Анализ площадей (точность ~60%)                           │
│  ─────────────────────────────────────────────────────────────────────  │
│  Если rooms = 1 И area_kitchen > 15 м² → вероятно евро                │
│  Если rooms = 2 И area_kitchen > 18 м² → вероятно евро                │
│  (Большая кухня = кухня-гостиная)                                     │
│                                                                         │
│  Уровень 3: Справочник планировок ЖК (точность ~95%)                  │
│  ─────────────────────────────────────────────────────────────────────  │
│  Создаём справочник: ЖК + корпус + тип планировки → room_type         │
│  Заполняется оператором или парсится с сайтов застройщиков            │
│                                                                         │
│  Уровень 4: ML-классификация по планировке (v2.0)                     │
│  ─────────────────────────────────────────────────────────────────────  │
│  Анализ изображения планировки → определение структуры                │
│                                                                         │
│  ПРИОРИТЕТ: Уровень 3 > Уровень 1 > Уровень 2                         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 4.13.4 UI для выбора комнатности

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ВАРИАНТЫ ИНТЕРФЕЙСА ФИЛЬТРА                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ВАРИАНТ 1: Полный список (как у TrendAgent)                           │
│  ─────────────────────────────────────────────────────────────────────  │
│  ┌────────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐         │
│  │ Студия │ │ 1  │ │ 1Е │ │ 2  │ │ 2Е │ │ 3  │ │ 3Е │ │ 4+ │         │
│  └────────┘ └────┘ └────┘ └────┘ └────┘ └────┘ └────┘ └────┘         │
│                                                                         │
│  + Точный выбор                                                        │
│  - Много кнопок, неочевидно для новичков                              │
│                                                                         │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  ВАРИАНТ 2: Группировка с раскрытием (РЕКОМЕНДУЕМ)                     │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  ┌────────────────────────────────────────────────────────────────┐   │
│  │  Комнатность                                                    │   │
│  ├────────────────────────────────────────────────────────────────┤   │
│  │  ○ Студия                                                       │   │
│  │  ○ 1-комнатная                                                  │   │
│  │    ├─ [ ] Только классическая (1 комната + кухня)              │   │
│  │    └─ [✓] Включая евро-двушки (1Е)                             │   │
│  │  ● 2-комнатная                              ← выбрано           │   │
│  │    ├─ [✓] Классическая (2 комнаты + кухня)                     │   │
│  │    └─ [✓] Евро-трёшка (2Е: 2 спальни + кухня-гостиная)        │   │
│  │  ○ 3-комнатная                                                  │   │
│  │    └─ ...                                                       │   │
│  │  ○ 4 и более                                                    │   │
│  └────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  + Понятная группировка                                                │
│  + Подсказки в интерфейсе                                             │
│  + Гибкий выбор                                                        │
│                                                                         │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  ВАРИАНТ 3: Быстрый + расширенный                                      │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  Быстрый фильтр (на главной):                                         │
│  ┌────────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐                               │
│  │ Студия │ │ 1  │ │ 2  │ │ 3  │ │ 4+ │    [✓] Включая евро          │
│  └────────┘ └────┘ └────┘ └────┘ └────┘                               │
│                                                                         │
│  В "Все фильтры" — детальный выбор по типам                           │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 4.13.5 Отображение в интерфейсе

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ОТОБРАЖЕНИЕ ТИПА ПЛАНИРОВКИ                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  В ТАБЛИЦЕ КВАРТИР:                                                    │
│  ─────────────────────────────────────────────────────────────────────  │
│  │ ID     │ Тип      │ S общ │ S кух │ Цена       │                   │
│  │ 12345  │ 2Е       │ 58 м² │ 18 м² │ 9 500 000  │                   │
│  │ 12346  │ 2-комн   │ 55 м² │ 10 м² │ 9 200 000  │                   │
│                      ↑                                                  │
│               Короткое обозначение                                      │
│                                                                         │
│  В КАРТОЧКЕ КВАРТИРЫ:                                                  │
│  ─────────────────────────────────────────────────────────────────────  │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │  Евро-трёшка (2Е)                                               │  │
│  │  ──────────────────────────────────────────────────────────────│  │
│  │  2 спальни + кухня-гостиная 18 м²                              │  │
│  │                                                                 │  │
│  │  💡 Кухня объединена с гостиной зоной, создавая                │  │
│  │     просторное общее пространство                              │  │
│  └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  В ПОДБОРКЕ / СРАВНЕНИИ:                                              │
│  ─────────────────────────────────────────────────────────────────────  │
│  Показываем полное название + пояснение при наведении                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.14 Динамика цен и история

История изменения цены — одна из ключевых метрик для принятия решения о покупке. Позволяет оценить инвестиционную привлекательность объекта и понять, насколько "горячий" рынок.

#### 4.14.1 Структура данных

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ХРАНЕНИЕ ИСТОРИИ ЦЕН                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ТАБЛИЦА price_history (уже существует):                               │
│  ─────────────────────────────────────────────────────────────────────  │
│  id, offer_id, price_old, price_new, change_percent, changed_at        │
│                                                                         │
│  ДОПОЛНИТЕЛЬНЫЕ ПОЛЯ В offers (кэширование):                          │
│  ─────────────────────────────────────────────────────────────────────  │
│  initial_price          -- цена при первом появлении в системе        │
│  initial_price_date     -- дата первого появления                      │
│  price_change_absolute  -- изменение в рублях (текущая - начальная)   │
│  price_change_percent   -- изменение в процентах                       │
│  price_trend            -- 'up', 'down', 'stable'                      │
│  last_price_change_at   -- дата последнего изменения                   │
│  price_changes_count    -- количество изменений                        │
│                                                                         │
│  ЛОГИКА ОБНОВЛЕНИЯ:                                                    │
│  ─────────────────────────────────────────────────────────────────────  │
│  1. При импорте нового объекта:                                        │
│     → initial_price = price                                            │
│     → initial_price_date = NOW()                                       │
│     → price_trend = 'stable'                                           │
│                                                                         │
│  2. При изменении цены (триггер):                                     │
│     → INSERT INTO price_history(...)                                   │
│     → UPDATE offers SET                                                │
│         price_change_absolute = price - initial_price                  │
│         price_change_percent = ((price - initial_price) / initial) * 100│
│         price_trend = CASE WHEN new > old THEN 'up' ELSE 'down' END    │
│         last_price_change_at = NOW()                                   │
│         price_changes_count = price_changes_count + 1                  │
│                                                                         │
│  3. Стабильность (cron ежедневно):                                     │
│     → Если цена не менялась 30 дней: price_trend = 'stable'           │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 4.14.2 Отображение на карточке квартиры

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    БЛОК "ДИНАМИКА ЦЕНЫ"                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │  ДИНАМИКА ЦЕНЫ                                      [?] Подсказка│  │
│  ├─────────────────────────────────────────────────────────────────┤  │
│  │                                                                  │  │
│  │  Стартовая цена:     8 500 000 ₽                                │  │
│  │  Дата старта:        15.03.2024 (8 месяцев назад)               │  │
│  │  ───────────────────────────────────────────────────────────── │  │
│  │  Текущая цена:       9 200 000 ₽                                │  │
│  │  Изменение:          +700 000 ₽ (+8.24%) ▲                      │  │
│  │  Изменений цены:     4 раза                                     │  │
│  │                                                                  │  │
│  │  [═══════════════════════════════════════════════════════════] │  │
│  │                                                                  │  │
│  │  9.2M ─────────────────────────────────────────────●            │  │
│  │  9.0M ───────────────────────────────●                          │  │
│  │  8.7M ─────────────────●                                        │  │
│  │  8.5M ●                                                          │  │
│  │       Мар     Май     Июл     Сен     Ноя                       │  │
│  │       2024                                                       │  │
│  │                                                                  │  │
│  │  ─────────────────────────────────────────────────────────────  │  │
│  │  📊 Средний рост по ЖК: +6.5%                                   │  │
│  │  📊 Средний рост по району: +7.2%                               │  │
│  │  💡 Цена растёт быстрее среднего — высокий спрос               │  │
│  │                                                                  │  │
│  └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  ВАРИАНТЫ ТРЕНДОВ:                                                     │
│  ─────────────────────────────────────────────────────────────────────  │
│  ▲ Рост (зелёный)   — цена выросла за последние 30 дней               │
│  ▼ Снижение (красн) — цена снизилась за последние 30 дней             │
│  ─ Стабильно (серый) — цена не менялась 30+ дней                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 4.14.3 Уведомления об изменении цены

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    СИСТЕМА УВЕДОМЛЕНИЙ О ЦЕНАХ                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  СЦЕНАРИЙ 1: Объект в подборке — цена изменилась                       │
│  ─────────────────────────────────────────────────────────────────────  │
│  Триггер: UPDATE offers SET price = new_price WHERE id IN (selection)  │
│                                                                         │
│  Действия:                                                             │
│  1. Обновляем selection_items.price_changed = true                    │
│  2. Если снижение > 3%:                                               │
│     → Push агенту: "🔥 Цена снизилась на X%! ЖК Y, 2-комн"           │
│     → Email агенту (если включены уведомления)                        │
│  3. Если рост > 5%:                                                   │
│     → Push агенту: "📈 Цена выросла на X%. Стоит поторопиться?"       │
│                                                                         │
│  СЦЕНАРИЙ 2: Агент подписан на ЖК/застройщика                         │
│  ─────────────────────────────────────────────────────────────────────  │
│  (v1.2 — расширенный функционал)                                      │
│                                                                         │
│  Агент подписывается на конкретный ЖК или застройщика                 │
│  При изменении цен — получает дайджест:                               │
│  "В ЖК X изменились цены: 15 квартир подорожали, 3 подешевели"        │
│                                                                         │
│  СЦЕНАРИЙ 3: Клиент смотрит подборку — цена изменилась                │
│  ─────────────────────────────────────────────────────────────────────  │
│  В подборке показываем:                                               │
│  • Бейдж на объекте: "Цена снизилась ▼3%"                            │
│  • Или: "Цена выросла ▲5% с момента добавления"                      │
│  • Зачёркнутая старая цена + новая                                    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 4.14.4 API для истории цен

```
GET /api/offers/{id}/price-history

Response:
{
  "offer_id": 12345,
  "current_price": 9200000,
  "initial": {
    "price": 8500000,
    "date": "2024-03-15",
    "days_ago": 260
  },
  "change": {
    "absolute": 700000,
    "percent": 8.24,
    "trend": "up",
    "changes_count": 4
  },
  "comparison": {
    "complex_avg_change": 6.5,
    "district_avg_change": 7.2,
    "vs_complex": "+1.74%",
    "insight": "above_average"
  },
  "history": [
    {"date": "2024-03-15", "price": 8500000, "change": null},
    {"date": "2024-05-01", "price": 8700000, "change": "+2.35%"},
    {"date": "2024-07-15", "price": 9000000, "change": "+3.45%"},
    {"date": "2024-09-20", "price": 9100000, "change": "+1.11%"},
    {"date": "2024-11-01", "price": 9200000, "change": "+1.10%"}
  ]
}
```

### 4.15 Финансирование на карточке объекта

Блок финансирования — критически важный раздел карточки квартиры, который помогает агенту и клиенту сразу понять стоимость владения объектом с учётом различных способов оплаты.

#### 4.15.1 Структура блока финансирования

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    СПОСОБЫ ПОКУПКИ                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─── 100% оплата ───────────────────────────────────────────────────┐ │
│  │                                                                    │ │
│  │  Стоимость:              9 200 000 ₽                              │ │
│  │  ─────────────────────────────────────────────────────────────    │ │
│  │  Цена за м²:             229 500 ₽/м²                             │ │
│  │                                                                    │ │
│  │  💡 Скидка при 100% оплате: -150 000 ₽ (1.6%)                    │ │
│  │     Итого со скидкой:    9 050 000 ₽                              │ │
│  │                                                                    │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  ┌─── Ипотека ────────────────────────────────────────────────────────┐ │
│  │                                                                    │ │
│  │  ⚡ Лучшее предложение (Сбербанк):                                 │ │
│  │  ─────────────────────────────────────────────────────────────    │ │
│  │  Ставка:                 6.5% годовых (субсидированная)           │ │
│  │  Первый взнос:           20% = 1 840 000 ₽                        │ │
│  │  Срок:                   30 лет                                   │ │
│  │  Ежемесячный платёж:     ~46 500 ₽                                │ │
│  │  Переплата за весь срок: 9 500 000 ₽                              │ │
│  │                                                                    │ │
│  │  [Все ипотечные программы (7)] ───────────────────────────► ▼     │ │
│  │                                                                    │ │
│  │  ┌───────────────────────────────────────────────────────────┐    │ │
│  │  │  Программа              Ставка    Взнос   Платёж         │    │ │
│  │  │  ───────────────────────────────────────────────────────  │    │ │
│  │  │  🏦 Сбербанк субсид.    6.5%      20%     46 500 ₽       │    │ │
│  │  │  🏦 ВТБ базовая         10.9%     15%     68 200 ₽       │    │ │
│  │  │  🏦 Альфа семейная      5.3%      20%     40 800 ₽ *     │    │ │
│  │  │  🏦 Газпромбанк         11.2%     20%     70 100 ₽       │    │ │
│  │  │  🏦 ДомРФ IT-ипотека    5.0%      20%     39 500 ₽ **    │    │ │
│  │  │  ───────────────────────────────────────────────────────  │    │ │
│  │  │  * Требуется 2+ детей                                     │    │ │
│  │  │  ** Требуется подтверждение статуса IT-специалиста        │    │ │
│  │  └───────────────────────────────────────────────────────────┘    │ │
│  │                                                                    │ │
│  │  [🧮 Ипотечный калькулятор]                                       │ │
│  │                                                                    │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  ┌─── Рассрочка от застройщика ────────────────────────────────────┐   │
│  │                                                                    │ │
│  │  ✅ Доступна рассрочка                                            │ │
│  │  ─────────────────────────────────────────────────────────────    │ │
│  │  Первый взнос:           30% = 2 760 000 ₽                        │ │
│  │  Срок:                   До сдачи дома (Q2 2026)                  │ │
│  │  Ежемесячный платёж:     ~358 000 ₽                               │ │
│  │                                                                    │ │
│  │  ⚠️ Условия:                                                      │ │
│  │  • Беспроцентная рассрочка до сдачи                               │ │
│  │  • После сдачи — 12% годовых на остаток                           │ │
│  │  • Возможен переход на ипотеку                                    │ │
│  │                                                                    │ │
│  │  [📋 Условия рассрочки (PDF)]                                     │ │
│  │                                                                    │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  ┌─── Trade-in ─────────────────────────────────────────────────────┐   │
│  │                                                                    │ │
│  │  ✅ Trade-in доступен                                             │ │
│  │  ─────────────────────────────────────────────────────────────    │ │
│  │  Партнёр программы:      "Петербургская Недвижимость"             │ │
│  │  Срок оценки:            1-2 рабочих дня                          │ │
│  │  Фиксация цены:          На 90 дней                               │ │
│  │                                                                    │ │
│  │  [📞 Узнать условия Trade-in]                                     │ │
│  │                                                                    │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 4.15.2 Ипотечный калькулятор (встроенный)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    🧮 ИПОТЕЧНЫЙ КАЛЬКУЛЯТОР                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Стоимость квартиры:    [9 200 000] ₽              (зафиксировано)     │
│                                                                         │
│  Первоначальный взнос:  [20] %   =   [1 840 000] ₽                     │
│                         ◄━━━━━━━━━━●━━━━━━━━►                          │
│                         10%                 90%                         │
│                                                                         │
│  Срок кредита:          [25] лет                                       │
│                         ◄━━━━━━━━●━━━━━━━━━━━━━━►                      │
│                         1 год                  30 лет                   │
│                                                                         │
│  Процентная ставка:     [8.5] % годовых                                │
│                         ◄━━━━━●━━━━━━━━━━━━━━━━━►                      │
│                         4%                     25%                      │
│                                                                         │
│  ─────────────────────────────────────────────────────────────────      │
│                                                                         │
│  РЕЗУЛЬТАТ РАСЧЁТА:                                                     │
│  ═══════════════════════════════════════════════════════════════════    │
│                                                                         │
│  Сумма кредита:                    7 360 000 ₽                         │
│  Ежемесячный платёж:               58 945 ₽                            │
│  Общая сумма выплат:               17 683 500 ₽                        │
│  Переплата:                        10 323 500 ₽ (140%)                 │
│                                                                         │
│  ─────────────────────────────────────────────────────────────────      │
│                                                                         │
│  График платежей (первые 12 месяцев):                                  │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  №   Платёж     Основной долг   Проценты    Остаток            │   │
│  │  ─────────────────────────────────────────────────────────────  │   │
│  │  1   58 945 ₽   6 778 ₽         52 167 ₽    7 353 222 ₽        │   │
│  │  2   58 945 ₽   6 826 ₽         52 119 ₽    7 346 396 ₽        │   │
│  │  3   58 945 ₽   6 874 ₽         52 071 ₽    7 339 522 ₽        │   │
│  │  ...                                                            │   │
│  │  12  58 945 ₽   7 425 ₽         51 520 ₽    7 276 543 ₽        │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  [📊 Полный график]  [📥 Скачать PDF]  [✉️ Отправить клиенту]          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**Формула аннуитетного платежа:**

```
P = S × (i × (1 + i)^n) / ((1 + i)^n - 1)

Где:
P — ежемесячный платёж
S — сумма кредита
i — месячная процентная ставка (годовая / 12)
n — количество месяцев
```

#### 4.15.3 Ипотечные программы (данные)

Источники данных об ипотечных программах:

| Источник           | Описание                                 | Частота обновления |
| ------------------ | ---------------------------------------- | ------------------ |
| API банков         | Прямая интеграция (Сбербанк, ВТБ, Альфа) | Реалтайм           |
| Парсинг сайтов     | Для банков без API                       | 1 раз в день       |
| Ручной ввод        | Специальные программы застройщиков       | По запросу         |
| Данные застройщика | Субсидированные ставки, партнёры         | Из XML/вручную     |

**Структура данных ипотечной программы:**

```typescript
interface MortgageProgram {
  id: string;
  bankId: string;
  bankName: string;
  programName: string;

  // Условия
  interestRate: number; // Базовая ставка (%)
  subsidizedRate?: number; // Субсидированная ставка (%)
  subsidyEndDate?: Date; // Дата окончания субсидии

  minDownPayment: number; // Мин. первый взнос (%)
  maxDownPayment: number; // Макс. первый взнос (%)
  minLoanTerm: number; // Мин. срок (месяцы)
  maxLoanTerm: number; // Макс. срок (месяцы)
  minLoanAmount: number; // Мин. сумма кредита
  maxLoanAmount: number; // Макс. сумма кредита

  // Требования
  requirements: {
    minAge: number; // Мин. возраст заёмщика
    maxAge: number; // Макс. возраст на момент погашения
    minWorkExperience: number; // Мин. стаж (месяцы)
    citizenshipRequired: boolean; // Требуется гражданство РФ
    incomeConfirmation: 'справка' | '2НДФЛ' | 'по форме банка' | 'без подтверждения';

    // Специальные программы
    familyMortgage: boolean; // Семейная ипотека (дети)
    itMortgage: boolean; // IT-ипотека
    militaryMortgage: boolean; // Военная ипотека
    farEastMortgage: boolean; // Дальневосточная ипотека
    villageMortgage: boolean; // Сельская ипотека
  };

  // Применимость
  applicableToApartments: boolean; // Применима к апартаментам
  applicableToNew: boolean; // Применима к новостройкам
  applicableToSecondary: boolean; // Применима к вторичке

  // Аккредитация
  accreditedComplexIds: string[]; // Список ЖК (если не все)
  allComplexesAccredited: boolean; // Все ЖК застройщика аккредитованы

  // Мета
  documentUrl?: string; // Ссылка на условия
  lastUpdated: Date;
  isActive: boolean;
}
```

#### 4.15.4 Рассрочка от застройщика

**Типы рассрочек:**

| Тип                 | Описание              | Процент | Срок      |
| ------------------- | --------------------- | ------- | --------- |
| **Беспроцентная**   | 0% до сдачи дома      | 0%      | До ввода  |
| **Субсидированная** | Сниженный процент     | 3-6%    | 12-36 мес |
| **Стандартная**     | Рыночный процент      | 10-15%  | 6-24 мес  |
| **Trade-in**        | Зачёт старой квартиры | 0%      | 3-6 мес   |

**Структура данных рассрочки:**

```typescript
interface InstallmentPlan {
  id: string;
  developerId: string;
  complexId?: string; // Если для конкретного ЖК

  planType: 'interest_free' | 'subsidized' | 'standard' | 'trade_in';
  name: string;

  // Условия
  minDownPayment: number; // Мин. первый взнос (%)
  interestRate: number; // Процент (0 для беспроцентной)
  maxDuration: number; // Макс. срок (месяцы)
  durationReference: 'fixed' | 'until_completion'; // Фикс. срок или до сдачи

  // Ограничения
  minPropertyPrice?: number; // Мин. стоимость объекта
  maxPropertyPrice?: number; // Макс. стоимость объекта
  applicableRooms?: number[]; // Применимо к N-комнатным

  // Переход на ипотеку
  mortgageTransitionAllowed: boolean;
  mortgageTransitionTerms?: string;

  // После сдачи
  postCompletionRate?: number; // Процент после сдачи (если есть)
  postCompletionMaxTerm?: number; // Срок после сдачи

  // Документы
  documentUrl?: string;

  // Мета
  startDate?: Date;
  endDate?: Date;
  isActive: boolean;
}
```

#### 4.15.5 Акции и специальные предложения

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    🎁 АКТУАЛЬНЫЕ АКЦИИ                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─── Скидка на квартиры с отделкой ────────────────────────────────┐  │
│  │  🏷️ -5% при 100% оплате                                          │  │
│  │  Действует до: 31.12.2025                                         │  │
│  │  Условия: Только квартиры с чистовой отделкой                     │  │
│  │  [Подробнее]                                                      │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  ┌─── Ипотека 0.01% ─────────────────────────────────────────────────┐  │
│  │  ⚡ Субсидия на первые 2 года                                     │  │
│  │  Банк-партнёр: Сбербанк                                           │  │
│  │  Условия: Первый взнос от 30%                                     │  │
│  │  [Подробнее]                                                      │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  ┌─── Кухня в подарок ───────────────────────────────────────────────┐  │
│  │  🎁 Кухонный гарнитур при покупке 2+ комнат                      │  │
│  │  Стоимость подарка: до 200 000 ₽                                  │  │
│  │  Условия: Бронирование до 15.12.2025                              │  │
│  │  [Подробнее]                                                      │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**Структура данных акции:**

```typescript
interface Promotion {
  id: string;
  developerId: string;
  complexIds?: string[]; // ЖК (если не все)

  type: 'discount' | 'gift' | 'mortgage_subsidy' | 'installment' | 'cashback';
  title: string;
  description: string;

  // Размер выгоды
  discountPercent?: number; // Скидка в %
  discountAmount?: number; // Скидка в рублях
  giftDescription?: string; // Описание подарка
  giftValue?: number; // Стоимость подарка

  // Условия применения
  conditions: {
    paymentTypes?: ('full' | 'mortgage' | 'installment')[];
    minRooms?: number;
    maxRooms?: number;
    minPrice?: number;
    maxPrice?: number;
    renovationTypes?: string[];
    bookingRequired?: boolean;
  };

  // Сроки
  startDate: Date;
  endDate: Date;

  // Отображение
  priority: number; // Порядок отображения
  badgeColor?: string; // Цвет бейджа
  iconType?: string; // Иконка

  // Мета
  documentUrl?: string;
  isActive: boolean;
}
```

#### 4.15.6 Связь с фильтрами и поиском

Блок финансирования тесно связан с системой фильтрации:

```
┌─────────────────────────────────────────────────────────────────────────┐
│              ВЗАИМОСВЯЗЬ ФИЛЬТРОВ И ФИНАНСИРОВАНИЯ                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ФИЛЬТР                          ВЛИЯНИЕ НА КАРТОЧКУ                    │
│  ────────────────────────────    ───────────────────────────────────    │
│                                                                         │
│  🏦 Банк-партнёр = "Сбербанк"   → Сбербанк первым в списке ипотек      │
│                                 → Подсвечен как "Выбранный банк"       │
│                                                                         │
│  👨‍👩‍👧‍👦 Семейная ипотека = Да      → Показаны только семейные программы │
│                                 → Расчёт по ставке семейной ипотеки    │
│                                                                         │
│  💻 IT-ипотека = Да             → Показаны только IT-программы         │
│                                 → Ставка 5% в калькуляторе             │
│                                                                         │
│  📊 Ежемесячный платёж = X ₽    → Показан диапазон ставок для платежа  │
│                                 → Подходящие программы сверху          │
│                                                                         │
│  💵 Рассрочка = Да              → Блок рассрочки развёрнут             │
│                                 → Только объекты с рассрочкой          │
│                                                                         │
│  🎁 Акции = Да                  → Блок акций первым                    │
│                                 → Бейджи акций на превью               │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 4.15.7 API для финансирования

```typescript
// GET /api/v1/offers/{offerId}/financing
// Получить все варианты финансирования для объекта

interface OfferFinancingResponse {
  offerId: string;
  price: number;
  pricePerSqm: number;

  // 100% оплата
  fullPayment: {
    price: number;
    discount?: {
      amount: number;
      percent: number;
      endDate?: Date;
    };
  };

  // Ипотека
  mortgage: {
    bestOffer: MortgageProgramCalculation;
    programs: MortgageProgramCalculation[];
    calculatorDefaults: {
      downPayment: number;
      term: number;
      rate: number;
    };
  };

  // Рассрочка
  installment?: {
    available: boolean;
    plans: InstallmentPlanCalculation[];
  };

  // Trade-in
  tradeIn?: {
    available: boolean;
    partnerName?: string;
    fixationDays?: number;
  };

  // Акции
  promotions: Promotion[];
}

interface MortgageProgramCalculation {
  program: MortgageProgram;
  calculation: {
    loanAmount: number;
    downPayment: number;
    monthlyPayment: number;
    totalPayment: number;
    overpayment: number;
  };
  requirements: {
    satisfied: boolean;
    missingRequirements: string[];
  };
}

// POST /api/v1/calculator/mortgage
// Рассчитать ипотеку с произвольными параметрами

interface MortgageCalculatorRequest {
  price: number;
  downPayment: number; // В рублях или процентах
  downPaymentType: 'amount' | 'percent';
  term: number; // Месяцы
  rate: number; // Годовая ставка (%)
}

interface MortgageCalculatorResponse {
  loanAmount: number;
  monthlyPayment: number;
  totalPayment: number;
  overpayment: number;
  overpaymentPercent: number;
  schedule: PaymentScheduleItem[];
}

interface PaymentScheduleItem {
  month: number;
  payment: number;
  principal: number;
  interest: number;
  remainingBalance: number;
}
```

---

### 4.16 PDF-генерация и экспорт

Профессиональные агенты нуждаются в возможности формировать презентационные материалы для клиентов — красивые PDF-документы с выбранными объектами, которые можно отправить по email или распечатать.

#### 4.16.1 Типы экспортируемых документов

| Тип документа                | Описание                               | Формат           | Приоритет |
| ---------------------------- | -------------------------------------- | ---------------- | --------- |
| **Карточка объекта**         | Детальная информация по одной квартире | PDF A4           | MVP       |
| **Подборка**                 | Список объектов с ключевой информацией | PDF A4           | MVP       |
| **Сравнение**                | Табличное сравнение 2-4 объектов       | PDF A4 landscape | v1.1      |
| **Презентация ЖК**           | Информация о жилом комплексе           | PDF A4           | v1.1      |
| **Коммерческое предложение** | Брендированный документ агентства      | PDF A4           | v1.2      |
| **Excel-выгрузка**           | Табличные данные для анализа           | XLSX             | v1.1      |

#### 4.16.2 Карточка объекта (PDF)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         ШАБЛОН PDF (A4)                                 │
│                      КАРТОЧКА КВАРТИРЫ                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                        HOUSLER                                  │   │
│  │                   Первичная недвижимость СПб                    │   │
│  │─────────────────────────────────────────────────────────────────│   │
│  │                                                                  │   │
│  │  ЖК "Новатория"                              ID: #NVT-12345    │   │
│  │  ═══════════════════════════════════════════════════════════════│   │
│  │                                                                  │   │
│  │  ┌────────────────────────┐  ┌──────────────────────────────┐  │   │
│  │  │                        │  │                               │  │   │
│  │  │     ПЛАНИРОВКА        │  │   ОСНОВНЫЕ ХАРАКТЕРИСТИКИ    │  │   │
│  │  │     (изображение)      │  │                               │  │   │
│  │  │                        │  │   Тип:        2-комн. евро   │  │   │
│  │  │                        │  │   Площадь:    52.3 м²        │  │   │
│  │  │                        │  │   Жилая:      28.7 м²        │  │   │
│  │  │                        │  │   Кухня-гост: 18.2 м²        │  │   │
│  │  │                        │  │   Этаж:       12 из 25       │  │   │
│  │  │                        │  │   Отделка:    Под ключ       │  │   │
│  │  │                        │  │   Срок сдачи: Q2 2026        │  │   │
│  │  │                        │  │                               │  │   │
│  │  └────────────────────────┘  └──────────────────────────────┘  │   │
│  │                                                                  │   │
│  │  ЦЕНА                                                           │   │
│  │  ─────────────────────────────────────────────────────────────  │   │
│  │  Стоимость:          9 200 000 ₽                               │   │
│  │  Цена за м²:         175 910 ₽/м²                              │   │
│  │                                                                  │   │
│  │  Ипотека от:         46 500 ₽/мес (Сбербанк, 6.5%)            │   │
│  │                                                                  │   │
│  │  РАСПОЛОЖЕНИЕ                                                   │   │
│  │  ─────────────────────────────────────────────────────────────  │   │
│  │  Адрес:              Невский р-н, ул. Коллонтай, д.6          │   │
│  │  Метро:              Проспект Большевиков (10 мин пешком)      │   │
│  │                                                                  │   │
│  │  ┌────────────────────────────────────────────────────────┐    │   │
│  │  │                    КАРТА                               │    │   │
│  │  │               (мини-карта с меткой)                     │    │   │
│  │  └────────────────────────────────────────────────────────┘    │   │
│  │                                                                  │   │
│  │  О ЖИЛОМ КОМПЛЕКСЕ                                              │   │
│  │  ─────────────────────────────────────────────────────────────  │   │
│  │  Застройщик:         Setl City                                 │   │
│  │  Тип дома:           Кирпично-монолитный                       │   │
│  │  Этажность:          25 этажей                                 │   │
│  │  Парковка:           Подземная, наземная                       │   │
│  │  Благоустройство:    Детская площадка, сквер, велодорожки     │   │
│  │                                                                  │   │
│  │─────────────────────────────────────────────────────────────────│   │
│  │                                                                  │   │
│  │  Ваш агент:          Иванова Мария                             │   │
│  │  Телефон:            +7 (999) 123-45-67                        │   │
│  │  Email:              maria@agency.ru                            │   │
│  │                                                                  │   │
│  │  Дата формирования:  30.11.2025                                │   │
│  │  Актуальность:       Цена актуальна на момент генерации       │   │
│  │                                                                  │   │
│  │                          [QR-код на карточку]                   │   │
│  │                                                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 4.16.3 Подборка объектов (PDF)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     ШАБЛОН PDF (A4) — ПОДБОРКА                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                        HOUSLER                                  │   │
│  │                                                                  │   │
│  │  ПОДБОРКА ДЛЯ: Петров Сергей                                   │   │
│  │  Составлена:   30.11.2025                                      │   │
│  │  Объектов:     5                                                │   │
│  │                                                                  │   │
│  │  Критерии поиска:                                               │   │
│  │  • 2-комнатные квартиры                                        │   │
│  │  • Бюджет: 8-12 млн ₽                                          │   │
│  │  • Район: Невский, Московский                                  │   │
│  │  • Сдача: до Q2 2026                                           │   │
│  │                                                                  │   │
│  │═══════════════════════════════════════════════════════════════  │   │
│  │                                                                  │   │
│  │  1. ЖК "Новатория"                                   ⭐ ТОП    │   │
│  │  ───────────────────────────────────────────────────────────    │   │
│  │  ┌─────────────┐  2-комн. евро | 52.3 м² | этаж 12/25         │   │
│  │  │ [План]      │  Отделка: под ключ | Сдача: Q2 2026          │   │
│  │  │             │  Невский р-н | м. Пр. Большевиков (10 мин)   │   │
│  │  │             │  ─────────────────────────────────────────    │   │
│  │  └─────────────┘  💰 9 200 000 ₽   (175 910 ₽/м²)             │   │
│  │                   📅 Ипотека от 46 500 ₽/мес                   │   │
│  │                                                                  │   │
│  │  2. ЖК "OKLA"                                                   │   │
│  │  ───────────────────────────────────────────────────────────    │   │
│  │  ┌─────────────┐  2-комн. | 58.1 м² | этаж 8/20               │   │
│  │  │ [План]      │  Отделка: чистовая | Сдача: Сдан             │   │
│  │  │             │  Московский р-н | м. Московская (15 мин)     │   │
│  │  │             │  ─────────────────────────────────────────    │   │
│  │  └─────────────┘  💰 10 500 000 ₽   (180 723 ₽/м²)            │   │
│  │                   📅 Ипотека от 52 300 ₽/мес                   │   │
│  │                                                                  │   │
│  │  [... ещё 3 объекта ...]                                        │   │
│  │                                                                  │   │
│  │═══════════════════════════════════════════════════════════════  │   │
│  │                                                                  │   │
│  │  СВОДКА ПО ПОДБОРКЕ                                             │   │
│  │  ─────────────────────────────────────────────────────────────  │   │
│  │  Диапазон цен:      8 700 000 — 11 200 000 ₽                   │   │
│  │  Средняя цена:      9 850 000 ₽                                │   │
│  │  Средняя цена/м²:   178 500 ₽                                  │   │
│  │  Средняя площадь:   55.2 м²                                    │   │
│  │                                                                  │   │
│  │─────────────────────────────────────────────────────────────────│   │
│  │  Ваш агент: Иванова Мария | +7 (999) 123-45-67                 │   │
│  │                    [QR-код на подборку онлайн]                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 4.16.4 Сравнение объектов (PDF)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    ШАБЛОН PDF (A4 LANDSCAPE) — СРАВНЕНИЕ                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │  СРАВНЕНИЕ ОБЪЕКТОВ                                  HOUSLER            │  │
│  │══════════════════════════════════════════════════════════════════════════│  │
│  │                                                                          │  │
│  │  ПАРАМЕТР          │ ЖК "Новатория"    │ ЖК "OKLA"        │ ЖК "Pixel" │  │
│  │  ──────────────────┼───────────────────┼──────────────────┼─────────────│  │
│  │                    │                   │                  │             │  │
│  │  [Планировка]      │ [изображение]     │ [изображение]    │ [изобр.]   │  │
│  │                    │                   │                  │             │  │
│  │  ──────────────────┼───────────────────┼──────────────────┼─────────────│  │
│  │  Тип               │ 2-комн. евро      │ 2-комн.          │ 2-комн.    │  │
│  │  Площадь общая     │ 52.3 м²           │ 58.1 м²  ✓       │ 49.8 м²    │  │
│  │  Площадь жилая     │ 28.7 м²           │ 32.4 м²  ✓       │ 26.1 м²    │  │
│  │  Площадь кухни     │ 18.2 м² (кух-гост)│ 12.5 м²          │ 10.8 м²    │  │
│  │  ──────────────────┼───────────────────┼──────────────────┼─────────────│  │
│  │  Этаж              │ 12 / 25           │ 8 / 20           │ 15 / 22    │  │
│  │  Отделка           │ Под ключ  ✓       │ Чистовая         │ Без отделки│  │
│  │  Сдача             │ Q2 2026           │ Сдан  ✓          │ Q4 2026    │  │
│  │  ──────────────────┼───────────────────┼──────────────────┼─────────────│  │
│  │  Район             │ Невский           │ Московский       │ Приморский │  │
│  │  Метро             │ Пр. Большевиков   │ Московская       │ Комендантск│  │
│  │  До метро          │ 10 мин ✓          │ 15 мин           │ 12 мин     │  │
│  │  ──────────────────┼───────────────────┼──────────────────┼─────────────│  │
│  │  ЦЕНА              │ 9 200 000 ₽  ✓    │ 10 500 000 ₽     │ 8 700 000 ₽│  │
│  │  Цена за м²        │ 175 910 ₽/м² ✓    │ 180 723 ₽/м²     │ 174 699 ₽  │  │
│  │  Ипотека от        │ 46 500 ₽/мес      │ 52 300 ₽/мес     │ 43 500 ₽ ✓ │  │
│  │  ──────────────────┼───────────────────┼──────────────────┼─────────────│  │
│  │  Тип дома          │ Кирп.-монолит     │ Монолит          │ Панель     │  │
│  │  Застройщик        │ Setl City         │ Группа ЛСР       │ Л1         │  │
│  │══════════════════════════════════════════════════════════════════════════│  │
│  │                                                                          │  │
│  │  ✓ — лучший показатель в категории                                      │  │
│  │                                                                          │  │
│  │──────────────────────────────────────────────────────────────────────────│  │
│  │  Агент: Иванова Мария | +7 (999) 123-45-67 | 30.11.2025                 │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 4.16.5 Технические требования к PDF-генерации

**Используемые библиотеки:**

| Библиотека              | Назначение                   | Особенности                     |
| ----------------------- | ---------------------------- | ------------------------------- |
| **Puppeteer**           | Рендеринг HTML в PDF         | Высокое качество, CSS поддержка |
| **@react-pdf/renderer** | Генерация PDF в React        | Программная генерация           |
| **PDFKit**              | Low-level PDF генерация      | Максимальный контроль           |
| **html-pdf-node**       | Простая HTML→PDF конвертация | Быстрый старт                   |

**Рекомендуемый стек:**

```typescript
// Серверная генерация (Node.js)
// Используем Puppeteer для точного рендеринга

import puppeteer from 'puppeteer';

interface PDFGenerationOptions {
  format: 'A4' | 'A4-landscape';
  template: 'property-card' | 'selection' | 'comparison' | 'complex';
  data: any;
  branding?: {
    agencyLogo?: string;
    agencyName?: string;
    agentName?: string;
    agentPhone?: string;
    agentEmail?: string;
  };
  options?: {
    includeQR: boolean;
    includeMap: boolean;
    includeMortgage: boolean;
  };
}

async function generatePDF(options: PDFGenerationOptions): Promise<Buffer> {
  const browser = await puppeteer.launch({ headless: true });
  const page = await browser.newPage();

  // Рендерим React-компонент в HTML
  const html = await renderTemplate(options.template, options.data, options.branding);

  await page.setContent(html, { waitUntil: 'networkidle0' });

  const pdf = await page.pdf({
    format: options.format === 'A4-landscape' ? 'A4' : 'A4',
    landscape: options.format === 'A4-landscape',
    printBackground: true,
    margin: { top: '10mm', bottom: '10mm', left: '10mm', right: '10mm' },
  });

  await browser.close();
  return pdf;
}
```

**Шрифты и стили:**

- Шрифт: Inter / Roboto (поддержка кириллицы)
- Цвета: Согласно брендбуку Housler
- Логотип: SVG для качества при печати

**Оптимизация изображений:**

- Планировки: 800x800 px, качество 85%
- Фото: 600x400 px, качество 80%
- Карты: Статичное изображение Yandex Static Maps API
- QR-коды: SVG генерация

#### 4.16.6 Excel-экспорт

```typescript
interface ExcelExportOptions {
  type: 'selection' | 'search-results' | 'analytics';
  columns: ExcelColumn[];
  data: any[];
  filename: string;
}

interface ExcelColumn {
  key: string;
  header: string;
  width: number;
  format?: 'text' | 'number' | 'currency' | 'date' | 'percent';
}

// Стандартные колонки для выгрузки квартир
const OFFER_COLUMNS: ExcelColumn[] = [
  { key: 'id', header: 'ID', width: 12, format: 'text' },
  { key: 'complexName', header: 'ЖК', width: 25, format: 'text' },
  { key: 'address', header: 'Адрес', width: 40, format: 'text' },
  { key: 'district', header: 'Район', width: 18, format: 'text' },
  { key: 'metro', header: 'Метро', width: 20, format: 'text' },
  { key: 'metroTime', header: 'До метро (мин)', width: 15, format: 'number' },
  { key: 'rooms', header: 'Комнат', width: 10, format: 'text' },
  { key: 'area', header: 'Площадь (м²)', width: 14, format: 'number' },
  { key: 'livingArea', header: 'Жилая (м²)', width: 12, format: 'number' },
  { key: 'kitchenArea', header: 'Кухня (м²)', width: 12, format: 'number' },
  { key: 'floor', header: 'Этаж', width: 10, format: 'text' },
  { key: 'renovation', header: 'Отделка', width: 25, format: 'text' },
  { key: 'completionDate', header: 'Сдача', width: 12, format: 'text' },
  { key: 'price', header: 'Цена (₽)', width: 14, format: 'currency' },
  { key: 'pricePerSqm', header: 'Цена/м²', width: 12, format: 'currency' },
  { key: 'developer', header: 'Застройщик', width: 20, format: 'text' },
  { key: 'dealType', header: 'Тип сделки', width: 15, format: 'text' },
  { key: 'hasEscrow', header: 'Эскроу', width: 10, format: 'text' },
  { key: 'link', header: 'Ссылка', width: 50, format: 'text' },
];
```

#### 4.16.7 API для экспорта

```typescript
// POST /api/v1/export/pdf/property
// Генерация PDF карточки объекта

interface PropertyPDFRequest {
  offerId: string;
  branding?: BrandingOptions;
  options?: {
    includeQR?: boolean;
    includeMap?: boolean;
    includeMortgage?: boolean;
    includeHistory?: boolean;
  };
}

// POST /api/v1/export/pdf/selection
// Генерация PDF подборки

interface SelectionPDFRequest {
  selectionId: string;
  clientName?: string;
  branding?: BrandingOptions;
  options?: {
    includeQR?: boolean;
    includeSummary?: boolean;
    maxObjectsPerPage?: number; // 2-3
  };
}

// POST /api/v1/export/pdf/comparison
// Генерация PDF сравнения

interface ComparisonPDFRequest {
  offerIds: string[]; // 2-4 объекта
  branding?: BrandingOptions;
  highlightBest?: boolean; // Подсветка лучших значений
}

// POST /api/v1/export/excel/offers
// Выгрузка в Excel

interface ExcelExportRequest {
  filters: SearchFilters; // Те же фильтры что и поиск
  columns?: string[]; // Выбранные колонки (или все)
  limit?: number; // Макс. строк (по умолчанию 1000)
}

// Общий ответ для PDF
interface PDFExportResponse {
  url: string; // Временная ссылка на скачивание
  expiresAt: Date; // Срок жизни ссылки (24 часа)
  filename: string;
  sizeBytes: number;
}

// Общий ответ для Excel
interface ExcelExportResponse {
  url: string;
  expiresAt: Date;
  filename: string;
  sizeBytes: number;
  rowCount: number;
}
```

---

### 4.17 Расширенный поиск и счётчик результатов

Умная строка поиска и динамический счётчик результатов — ключевые элементы UX, которые делают систему интуитивной и информативной.

#### 4.17.1 Архитектура строки поиска

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    УМНАЯ СТРОКА ПОИСКА                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │  🔍 │ Невский район, ЖК Новатория, 2-комн...              │ ✕   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                           │                                             │
│                           ▼                                             │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                    │ │
│  │  МЕТРО                                                            │ │
│  │  ──────────────────────────────────────────────────────────────   │ │
│  │  🚇 Невский проспект           Синяя линия                       │ │
│  │  🚇 Площадь Невского           Зелёная линия                     │ │
│  │                                                                    │ │
│  │  РАЙОНЫ                                                           │ │
│  │  ──────────────────────────────────────────────────────────────   │ │
│  │  📍 Невский район              СПб, 940 объектов                 │ │
│  │                                                                    │ │
│  │  ЖИЛЫЕ КОМПЛЕКСЫ                                                  │ │
│  │  ──────────────────────────────────────────────────────────────   │ │
│  │  🏢 ЖК "Невская Ратуша"        Невский р-н, Setl City            │ │
│  │  🏢 ЖК "Невские паруса"        Невский р-н, ЛСР                  │ │
│  │                                                                    │ │
│  │  УЛИЦЫ                                                            │ │
│  │  ──────────────────────────────────────────────────────────────   │ │
│  │  📍 Невский проспект           Центральный район                 │ │
│  │                                                                    │ │
│  │  ЗАСТРОЙЩИКИ                                                      │ │
│  │  ──────────────────────────────────────────────────────────────   │ │
│  │  🏗️ "Невский Дом"             5 ЖК, 230 объектов                 │ │
│  │                                                                    │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 4.17.2 Категории поисковых подсказок

| Категория       | Иконка | Источник данных      | Приоритет показа |
| --------------- | ------ | -------------------- | ---------------- |
| **Метро**       | 🚇     | Справочник метро     | 1 (высший)       |
| **Районы**      | 📍     | Справочник районов   | 2                |
| **ЖК**          | 🏢     | Таблица complexes    | 3                |
| **Улицы**       | 📍     | ФИАС/Яндекс Геокодер | 4                |
| **Застройщики** | 🏗️     | Таблица developers   | 5                |
| **Банки**       | 🏦     | Справочник банков    | 6                |

#### 4.17.3 Алгоритм подсказок

```typescript
interface SearchSuggestion {
  id: string;
  category: 'metro' | 'district' | 'complex' | 'street' | 'developer' | 'bank';
  name: string;
  displayName: string; // С подсветкой совпадения
  subtitle?: string; // Доп. инфо
  objectCount?: number; // Кол-во объектов
  icon: string;
  priority: number;
}

async function getSuggestions(query: string): Promise<SearchSuggestion[]> {
  const normalizedQuery = query.toLowerCase().trim();

  if (normalizedQuery.length < 2) {
    return [];
  }

  // Параллельный поиск по всем категориям
  const [metro, districts, complexes, streets, developers, banks] = await Promise.all([
    searchMetro(normalizedQuery),
    searchDistricts(normalizedQuery),
    searchComplexes(normalizedQuery),
    searchStreets(normalizedQuery),
    searchDevelopers(normalizedQuery),
    searchBanks(normalizedQuery),
  ]);

  // Объединяем и сортируем по релевантности
  const suggestions = [
    ...metro.map((s) => ({ ...s, priority: 1 })),
    ...districts.map((s) => ({ ...s, priority: 2 })),
    ...complexes.map((s) => ({ ...s, priority: 3 })),
    ...streets.map((s) => ({ ...s, priority: 4 })),
    ...developers.map((s) => ({ ...s, priority: 5 })),
    ...banks.map((s) => ({ ...s, priority: 6 })),
  ];

  // Сортируем: точное совпадение в начале → по приоритету → по кол-ву объектов
  return suggestions
    .sort((a, b) => {
      // Точное совпадение в начале — высший приоритет
      const aExact = a.name.toLowerCase().startsWith(normalizedQuery);
      const bExact = b.name.toLowerCase().startsWith(normalizedQuery);
      if (aExact !== bExact) return aExact ? -1 : 1;

      // По приоритету категории
      if (a.priority !== b.priority) return a.priority - b.priority;

      // По количеству объектов
      return (b.objectCount || 0) - (a.objectCount || 0);
    })
    .slice(0, 10); // Максимум 10 подсказок
}
```

#### 4.17.4 PostgreSQL-оптимизация поиска

```sql
-- Индекс для быстрого поиска по названию (триграммы)
CREATE EXTENSION IF NOT EXISTS pg_trgm;

-- Индекс для ЖК
CREATE INDEX idx_complexes_name_trgm ON complexes
  USING gin (name gin_trgm_ops);

-- Индекс для застройщиков
CREATE INDEX idx_developers_name_trgm ON developers
  USING gin (name gin_trgm_ops);

-- Функция поиска с ранжированием
CREATE OR REPLACE FUNCTION search_complexes(search_query TEXT)
RETURNS TABLE (
  id UUID,
  name VARCHAR,
  district_name VARCHAR,
  developer_name VARCHAR,
  offer_count BIGINT,
  similarity REAL
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    c.id,
    c.name,
    d.name AS district_name,
    dev.name AS developer_name,
    COUNT(o.id) AS offer_count,
    similarity(c.name, search_query) AS similarity
  FROM complexes c
  LEFT JOIN districts d ON c.district_id = d.id
  LEFT JOIN developers dev ON c.developer_id = dev.id
  LEFT JOIN offers o ON o.complex_id = c.id AND o.is_active = true
  WHERE
    c.name % search_query  -- Триграммное сходство
    OR c.name ILIKE search_query || '%'  -- Начинается с
  GROUP BY c.id, c.name, d.name, dev.name
  ORDER BY
    c.name ILIKE search_query || '%' DESC,  -- Точное совпадение сначала
    similarity(c.name, search_query) DESC
  LIMIT 5;
END;
$$ LANGUAGE plpgsql;
```

#### 4.17.5 Счётчик результатов

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    КНОПКА-СЧЁТЧИК РЕЗУЛЬТАТОВ                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                    │ │
│  │    ОБЫЧНОЕ СОСТОЯНИЕ                                              │ │
│  │    ─────────────────────────────────────────────────────────────  │ │
│  │                                                                    │ │
│  │    ┌─────────────────────────────────────────────────────────┐   │ │
│  │    │  🔍  12 458 квартир в 287 ЖК                      ▶    │   │ │
│  │    └─────────────────────────────────────────────────────────┘   │ │
│  │                                                                    │ │
│  │    СОСТОЯНИЕ ЗАГРУЗКИ                                             │ │
│  │    ─────────────────────────────────────────────────────────────  │ │
│  │                                                                    │ │
│  │    ┌─────────────────────────────────────────────────────────┐   │ │
│  │    │  ⏳  Подсчёт результатов...                             │   │ │
│  │    └─────────────────────────────────────────────────────────┘   │ │
│  │                                                                    │ │
│  │    СОСТОЯНИЕ "НЕТ РЕЗУЛЬТАТОВ"                                    │ │
│  │    ─────────────────────────────────────────────────────────────  │ │
│  │                                                                    │ │
│  │    ┌─────────────────────────────────────────────────────────┐   │ │
│  │    │  ⚠️  0 квартир — попробуйте изменить фильтры           │   │ │
│  │    └─────────────────────────────────────────────────────────┘   │ │
│  │                                                                    │ │
│  │    СОСТОЯНИЕ "МАЛО РЕЗУЛЬТАТОВ"                                   │ │
│  │    ─────────────────────────────────────────────────────────────  │ │
│  │                                                                    │ │
│  │    ┌─────────────────────────────────────────────────────────┐   │ │
│  │    │  ℹ️  3 квартиры в 2 ЖК — расширьте критерии?     ▶    │   │ │
│  │    └─────────────────────────────────────────────────────────┘   │ │
│  │                                                                    │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  ПОВЕДЕНИЕ:                                                             │
│  ─────────────────────────────────────────────────────────────────────  │
│  • Обновляется при каждом изменении фильтров (debounce 300ms)          │
│  • Клик → переход к результатам поиска                                 │
│  • При hover — показывает breakdown (квартиры/паркинги/коммерция)      │
│  • Анимация при обновлении (fade in/out числа)                         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 4.17.6 Оптимизация подсчёта результатов

Подсчёт результатов при каждом изменении фильтров должен быть очень быстрым (<100ms), иначе UX страдает.

**Стратегии оптимизации:**

```typescript
// 1. КЭШИРОВАНИЕ ПОПУЛЯРНЫХ ЗАПРОСОВ

interface CountCache {
  key: string;           // Хэш от фильтров
  count: number;
  complexCount: number;
  timestamp: Date;
  ttl: number;           // Время жизни в секундах
}

// Redis-ключ: "search:count:{hash}"
// TTL: 60 секунд для частых запросов

// 2. ПРЕДВАРИТЕЛЬНЫЙ ПОДСЧЁТ

// Материализованное представление с подсчётами по популярным измерениям
CREATE MATERIALIZED VIEW offer_counts AS
SELECT
  district_id,
  rooms,
  renovation_type,
  CASE
    WHEN price < 5000000 THEN 'budget'
    WHEN price < 10000000 THEN 'comfort'
    WHEN price < 20000000 THEN 'business'
    ELSE 'premium'
  END AS price_segment,
  is_apartment,
  deal_type,
  COUNT(*) as offer_count,
  COUNT(DISTINCT complex_id) as complex_count
FROM offers
WHERE is_active = true
GROUP BY
  district_id, rooms, renovation_type,
  price_segment, is_apartment, deal_type;

-- Обновление каждые 5 минут
REFRESH MATERIALIZED VIEW CONCURRENTLY offer_counts;

// 3. ПРИМЕРНЫЙ ПОДСЧЁТ ДЛЯ СЛОЖНЫХ ЗАПРОСОВ

// Используем EXPLAIN для оценки количества строк
async function estimateCount(filters: SearchFilters): Promise<number> {
  const query = buildSearchQuery(filters);
  const explainResult = await db.query(`EXPLAIN (FORMAT JSON) ${query}`);
  const plan = explainResult.rows[0]['QUERY PLAN'][0]['Plan'];
  return Math.round(plan['Plan Rows']);
}

// 4. ИНКРЕМЕНТАЛЬНОЕ УТОЧНЕНИЕ

// Показываем сначала примерное число, потом уточняем
interface CountResponse {
  count: number;
  complexCount: number;
  isEstimate: boolean;  // true = примерно, false = точно
}

async function getSearchCount(filters: SearchFilters): Promise<CountResponse> {
  // Пробуем из кэша
  const cached = await getCachedCount(filters);
  if (cached) return { ...cached, isEstimate: false };

  // Для простых запросов — точный подсчёт
  if (isSimpleQuery(filters)) {
    const exact = await getExactCount(filters);
    await cacheCount(filters, exact);
    return { ...exact, isEstimate: false };
  }

  // Для сложных — сначала примерный
  const estimate = await estimateCount(filters);

  // Запускаем точный подсчёт в фоне
  queueExactCount(filters);

  return {
    count: estimate,
    complexCount: Math.round(estimate / 20), // Примерно
    isEstimate: true
  };
}
```

#### 4.17.7 API для поиска

```typescript
// GET /api/v1/search/suggestions?q={query}
// Подсказки для автодополнения

interface SuggestionsResponse {
  suggestions: SearchSuggestion[];
  query: string;
  processingTime: number; // мс
}

// GET /api/v1/search/count
// Подсчёт результатов по фильтрам

interface CountRequest {
  filters: SearchFilters;
}

interface CountResponse {
  total: number;
  complexCount: number;
  isEstimate: boolean;
  breakdown?: {
    byRooms: Record<string, number>;
    byDistrict: Record<string, number>;
    byPriceRange: Record<string, number>;
  };
  processingTime: number;
}

// GET /api/v1/search/offers
// Поиск объектов

interface SearchRequest {
  filters: SearchFilters;
  sort: SortOption;
  pagination: {
    page: number;
    perPage: number;
  };
  include?: ('complex' | 'developer' | 'images' | 'mortgage')[];
}

interface SearchResponse {
  offers: OfferSummary[];
  total: number;
  complexCount: number;
  page: number;
  perPage: number;
  totalPages: number;
  processingTime: number;
}
```

#### 4.17.8 Frontend-компоненты

```typescript
// components/search/SearchBar.tsx

interface SearchBarProps {
  onSearch: (query: string, suggestion?: SearchSuggestion) => void;
  placeholder?: string;
}

const SearchBar: React.FC<SearchBarProps> = ({ onSearch, placeholder }) => {
  const [query, setQuery] = useState('');
  const [suggestions, setSuggestions] = useState<SearchSuggestion[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  const [selectedIndex, setSelectedIndex] = useState(-1);

  // Debounced fetch suggestions
  const debouncedFetch = useMemo(
    () => debounce(async (q: string) => {
      if (q.length < 2) {
        setSuggestions([]);
        return;
      }
      setIsLoading(true);
      const result = await searchService.getSuggestions(q);
      setSuggestions(result.suggestions);
      setIsLoading(false);
    }, 200),
    []
  );

  // Keyboard navigation
  const handleKeyDown = (e: KeyboardEvent) => {
    switch (e.key) {
      case 'ArrowDown':
        setSelectedIndex(i => Math.min(i + 1, suggestions.length - 1));
        break;
      case 'ArrowUp':
        setSelectedIndex(i => Math.max(i - 1, -1));
        break;
      case 'Enter':
        if (selectedIndex >= 0) {
          onSearch(query, suggestions[selectedIndex]);
        } else {
          onSearch(query);
        }
        break;
      case 'Escape':
        setSuggestions([]);
        break;
    }
  };

  return (
    <div className="search-bar">
      <input
        value={query}
        onChange={e => {
          setQuery(e.target.value);
          debouncedFetch(e.target.value);
        }}
        onKeyDown={handleKeyDown}
        placeholder={placeholder || 'Район, метро, ЖК, застройщик...'}
      />
      {isLoading && <Spinner />}
      {suggestions.length > 0 && (
        <SuggestionsList
          suggestions={suggestions}
          selectedIndex={selectedIndex}
          onSelect={(s) => onSearch(query, s)}
        />
      )}
    </div>
  );
};

// components/search/ResultsCounter.tsx

interface ResultsCounterProps {
  filters: SearchFilters;
  onClick: () => void;
}

const ResultsCounter: React.FC<ResultsCounterProps> = ({ filters, onClick }) => {
  const [count, setCount] = useState<CountResponse | null>(null);
  const [isLoading, setIsLoading] = useState(false);

  useEffect(() => {
    const fetchCount = async () => {
      setIsLoading(true);
      const result = await searchService.getCount(filters);
      setCount(result);
      setIsLoading(false);
    };

    const debounced = debounce(fetchCount, 300);
    debounced();

    return () => debounced.cancel();
  }, [filters]);

  if (isLoading) {
    return (
      <button className="results-counter loading" disabled>
        <Spinner size="small" />
        Подсчёт результатов...
      </button>
    );
  }

  if (!count || count.total === 0) {
    return (
      <button className="results-counter empty" disabled>
        ⚠️ 0 квартир — попробуйте изменить фильтры
      </button>
    );
  }

  return (
    <button className="results-counter" onClick={onClick}>
      🔍 {formatNumber(count.total)} квартир в {count.complexCount} ЖК
      {count.isEstimate && <span className="estimate">≈</span>}
      <ChevronRight />
    </button>
  );
};
```

---

### 4.18 Обновлённая приоритизация функций

После детального анализа конкурентов и бизнес-требований, roadmap был существенно расширен и уточнён.

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ROADMAP ПО ФАЗАМ (v2.0)                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ══════════════════════════════════════════════════════════════════    │
│  MVP (6-8 недель) — КРИТИЧНО ДЛЯ ЗАПУСКА                               │
│  ══════════════════════════════════════════════════════════════════    │
│                                                                         │
│  ПОИСК И ФИЛЬТРАЦИЯ:                                                   │
│  ────────────────────────────────────────────────────────────────────  │
│  ✅ Умная строка поиска с автодополнением                              │
│     (метро, район, ЖК, застройщик, улица, банк)                        │
│  ✅ Кнопка-счётчик результатов с динамическим обновлением              │
│  ✅ 15 основных фильтров (включая юридические):                        │
│     • Комнатность (с евро-форматами: С, 1, 1Е, 2, 2Е, 3, 3Е, 4+)       │
│     • Цена / Цена за м²                                                │
│     • Площадь (общая, жилая, кухня)                                    │
│     • Этаж (не первый / не последний)                                  │
│     • Район / Метро / Время до метро                                   │
│     • Срок сдачи / Состояние (сдан / строится)                         │
│     • Тип сделки (ДДУ / Уступка юр. / Уступка физ.)                   │
│     • Эскроу (обязательно для безопасности)                            │
│     • Апартаменты (включать / исключать)                               │
│     • Прописка (СПб / Ленобласть)                                      │
│  ✅ Фильтр по банку-партнёру (ипотечная аккредитация)                  │
│                                                                         │
│  КАРТОЧКА ОБЪЕКТА:                                                     │
│  ────────────────────────────────────────────────────────────────────  │
│  ✅ Планировка квартиры (из фида)                                      │
│  ✅ Галерея фото/рендеров дома                                         │
│  ✅ Основные характеристики + юридическая информация:                   │
│     • Тип сделки, наличие эскроу, тип (квартира/апартаменты)          │
│     • Регион прописки, застройщик, продавец                            │
│  ✅ Блок финансирования:                                               │
│     • 100% оплата (со скидкой если есть)                               │
│     • Лучшее ипотечное предложение (авто-расчёт)                       │
│     • Ипотечный калькулятор (аннуитет)                                 │
│     • Рассрочка (если доступна)                                        │
│     • Trade-in (если доступен)                                         │
│  ✅ Информация о ЖК (застройщик, тип дома, инфраструктура)             │
│  ✅ Карта с меткой                                                      │
│                                                                         │
│  ПОДБОРКИ И КЛИЕНТЫ:                                                   │
│  ────────────────────────────────────────────────────────────────────  │
│  ✅ Создание подборок агентом                                          │
│  ✅ Доступ клиента по ссылке                                           │
│  ✅ Добавление клиентом объектов в подборку                            │
│  ✅ Бронирование → уведомление оператору                               │
│                                                                         │
│  ЭКСПОРТ (БАЗОВЫЙ):                                                    │
│  ────────────────────────────────────────────────────────────────────  │
│  ✅ PDF карточки объекта (с QR-кодом)                                  │
│  ✅ PDF подборки (список объектов + сводка)                            │
│                                                                         │
│  КАБИНЕТЫ:                                                             │
│  ────────────────────────────────────────────────────────────────────  │
│  ✅ Агент: подборки, клиенты, брони, избранное                         │
│  ✅ Клиент: подборка агента, добавленные варианты                      │
│  ✅ Оператор: входящие заявки, управление                              │
│                                                                         │
│  ══════════════════════════════════════════════════════════════════    │
│  v1.1 (4-6 недель после MVP) — РАСШИРЕНИЕ ФУНКЦИОНАЛА                  │
│  ══════════════════════════════════════════════════════════════════    │
│                                                                         │
│  РАСШИРЕННЫЙ ПОИСК:                                                    │
│  ────────────────────────────────────────────────────────────────────  │
│  ⭐ Полный набор фильтров (50+ параметров):                            │
│     • Отделка (черновая / подготовка / чистовая / под ключ)            │
│     • Тип дома (панель / монолит / кирпич-монолит)                     │
│     • Балкон, лоджия, терраса                                          │
│     • Санузел (раздельный / совмещённый)                               │
│     • Высота потолков                                                  │
│     • Вид из окна (двор / улица / парк / вода)                         │
│     • Ипотечные программы (семейная, IT, военная)                      │
│     • Рассрочка / Trade-in / Акции                                     │
│     • Ежемесячный платёж (обратный расчёт)                             │
│  ⭐ AI-ассистент поиска (NLP-запросы)                                  │
│  ⭐ Геофильтры (рисование на карте)                                    │
│                                                                         │
│  КАРТОЧКА ОБЪЕКТА (РАСШИРЕНИЕ):                                        │
│  ────────────────────────────────────────────────────────────────────  │
│  ⭐ Поэтажный план                                                      │
│  ⭐ Галерея отделки (варианты от застройщика)                          │
│  ⭐ График динамики цены (история изменений)                           │
│  ⭐ Полный список ипотечных программ с расчётами                       │
│  ⭐ Документы застройщика (проектная декларация, ДДУ)                  │
│  ⭐ Документы банков (регламенты, анкеты)                              │
│                                                                         │
│  ЖК И ЗАСТРОЙЩИКИ:                                                     │
│  ────────────────────────────────────────────────────────────────────  │
│  ⭐ Страница ЖК (описание, фото, инфраструктура, генплан)              │
│  ⭐ Интерактивная шахматка ЖК                                          │
│  ⭐ Каталог планировок ЖК                                               │
│  ⭐ Страница застройщика (портфолио, надёжность)                       │
│                                                                         │
│  CRM-ФУНКЦИИ:                                                          │
│  ────────────────────────────────────────────────────────────────────  │
│  ⭐ CRM-воронка (Просмотры → Фиксации → Брони → Сделки → Срывы)        │
│  ⭐ Фиксация цены у застройщика (запрос через систему)                 │
│  ⭐ Тарифная карта (комиссии застройщиков)                             │
│  ⭐ Детальная аналитика по клиентам                                    │
│  ⭐ Push/Email уведомления:                                            │
│     • Изменение цены в избранном                                       │
│     • Снятие объекта с продажи                                         │
│     • Активность клиента в подборке                                    │
│                                                                         │
│  ЭКСПОРТ (РАСШИРЕНИЕ):                                                 │
│  ────────────────────────────────────────────────────────────────────  │
│  ⭐ PDF сравнения объектов (2-4 шт., landscape)                        │
│  ⭐ PDF презентации ЖК                                                  │
│  ⭐ Excel-выгрузка результатов поиска                                  │
│  ⭐ Брендирование PDF (логотип агентства)                              │
│                                                                         │
│  ══════════════════════════════════════════════════════════════════    │
│  v1.2 (4-6 недель после v1.1) — ПРОФЕССИОНАЛЬНЫЕ ИНСТРУМЕНТЫ           │
│  ══════════════════════════════════════════════════════════════════    │
│                                                                         │
│  АНАЛИТИКА И РЕКОМЕНДАЦИИ:                                             │
│  ────────────────────────────────────────────────────────────────────  │
│  ⭐ Умные рекомендации (похожие объекты, "вам может понравиться")      │
│  ⭐ Анализ предпочтений клиентов (ML)                                  │
│  ⭐ Рыночная аналитика (средние цены по районам/ЖК)                    │
│  ⭐ Прогноз изменения цен (простая модель)                             │
│                                                                         │
│  ИНТЕРАКТИВ:                                                           │
│  ────────────────────────────────────────────────────────────────────  │
│  ⭐ Интерактивный выбор на поэтажном плане                             │
│  ⭐ Сравнение до 4 объектов с выделением лучших параметров             │
│  ⭐ Калькулятор стоимости владения (ипотека + коммуналка)              │
│                                                                         │
│  ЛИЧНЫЕ КАБИНЕТЫ (РАСШИРЕНИЕ):                                         │
│  ────────────────────────────────────────────────────────────────────  │
│  ⭐ ЛК застройщика (загрузка документов, управление акциями)           │
│  ⭐ Рейтинг агентств (по количеству сделок)                            │
│  ⭐ Коммерческое предложение (брендированный PDF)                      │
│                                                                         │
│  ══════════════════════════════════════════════════════════════════    │
│  v2.0 (после v1.2) — ИННОВАЦИИ И МАСШТАБИРОВАНИЕ                       │
│  ══════════════════════════════════════════════════════════════════    │
│                                                                         │
│  🚀 3D-визуализация из 2D планировок (AI)                              │
│  🚀 Виртуальные туры по квартирам                                      │
│  🚀 Мобильное приложение (iOS/Android)                                 │
│  🚀 AI-генерация описаний объектов                                     │
│  🚀 Расширение на Москву и другие регионы                              │
│  🚀 Открытый API для партнёров                                         │
│  🚀 Паркинги и кладовки (отдельная категория)                          │
│  🚀 Коммерческая недвижимость                                          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### Ключевые изменения относительно предыдущей версии:

| Что добавлено                                                   | Фаза    | Обоснование                                      |
| --------------------------------------------------------------- | ------- | ------------------------------------------------ |
| Юридические фильтры (тип сделки, эскроу, апартаменты, прописка) | **MVP** | Критично для агентов — защита клиентов от рисков |
| Евро-форматы комнатности (1Е, 2Е, 3Е)                           | **MVP** | 30%+ рынка — евро-планировки                     |
| Кнопка-счётчик результатов                                      | **MVP** | Ключевой UX-элемент для навигации                |
| Блок финансирования на карточке                                 | **MVP** | Без этого агент не может работать                |
| PDF карточки и подборки                                         | **MVP** | Базовая потребность агентов                      |
| Фильтр по банку-партнёру                                        | **MVP** | Ключевой для подбора под клиента                 |
| График динамики цен                                             | v1.1    | Важно, но можно отложить                         |
| Полный список ипотечных программ                                | v1.1    | MVP достаточно "лучшее предложение"              |
| PDF сравнения                                                   | v1.1    | Можно сравнивать онлайн в MVP                    |

---

## 5. Нефункциональные требования

### 5.1 Производительность

| Метрика                        | Требование MVP | Требование Prod |
| ------------------------------ | -------------- | --------------- |
| Время ответа API (p50)         | < 200ms        | < 100ms         |
| Время ответа API (p95)         | < 500ms        | < 300ms         |
| Время загрузки страницы (LCP)  | < 3s           | < 2s            |
| Время до интерактивности (TTI) | < 5s           | < 3s            |
| Импорт фида (12K объектов)     | < 10 минут     | < 5 минут       |
| Одновременные пользователи     | 100            | 1,000           |
| Запросов в секунду (RPS)       | 50             | 500             |

### 5.2 Масштабируемость

```
Архитектура должна поддерживать:

┌─────────────────────────────────────────────────────────────────┐
│                    МАСШТАБИРОВАНИЕ                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Горизонтальное масштабирование:                               │
│  ├── API серверы: 1 → N (stateless)                            │
│  ├── Фоновые воркеры: 1 → N (очереди)                          │
│  └── Read replicas БД: 1 → N                                   │
│                                                                 │
│  Multi-region готовность:                                       │
│  ├── Разделение данных по регионам (region_id)                 │
│  ├── Отдельные схемы/базы по регионам                          │
│  └── Единая система авторизации                                │
│                                                                 │
│  Объём данных:                                                  │
│  ├── До 100K объявлений                                        │
│  ├── До 100K пользователей                                     │
│  └── До 1M изображений                                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.3 Доступность

| Метрика                        | Требование                    |
| ------------------------------ | ----------------------------- |
| Uptime                         | 99.5% (22 часа простоя/месяц) |
| RTO (Recovery Time Objective)  | < 4 часа                      |
| RPO (Recovery Point Objective) | < 1 час                       |
| Резервное копирование БД       | Ежедневно + WAL архивация     |

### 5.4 Совместимость

#### Браузеры

| Браузер        | Версия          | Поддержка            |
| -------------- | --------------- | -------------------- |
| Chrome         | last 2 versions | ✅ Полная            |
| Firefox        | last 2 versions | ✅ Полная            |
| Safari         | last 2 versions | ✅ Полная            |
| Edge           | last 2 versions | ✅ Полная            |
| IE 11          | -               | ❌ Не поддерживается |
| Mobile Safari  | iOS 14+         | ✅ Полная            |
| Chrome Android | last 2 versions | ✅ Полная            |

#### Устройства

| Устройство | Разрешение | Поддержка     |
| ---------- | ---------- | ------------- |
| Desktop    | 1920x1080+ | ✅ Полная     |
| Laptop     | 1366x768+  | ✅ Полная     |
| Tablet     | 768x1024+  | ✅ Адаптивная |
| Mobile     | 375x667+   | ✅ Адаптивная |

---

## 6. Архитектура системы

### 6.1 Высокоуровневая архитектура

```
┌─────────────────────────────────────────────────────────────────────┐
│                         ПОЛЬЗОВАТЕЛИ                                │
│     Браузеры (Desktop/Mobile)          API Клиенты (CRM/боты)      │
└──────────────────────────┬──────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      NGINX / CDN                                    │
│   ┌──────────────────────────────────────────────────────────────┐ │
│   │  Load Balancer │ SSL Termination │ Static Files │ Caching   │ │
│   └──────────────────────────────────────────────────────────────┘ │
└──────────────────────────┬──────────────────────────────────────────┘
                           │
           ┌───────────────┼───────────────┐
           ▼               ▼               ▼
┌────────────────┐ ┌────────────────┐ ┌────────────────┐
│   FRONTEND     │ │    BACKEND     │ │   WORKERS      │
│   ──────────   │ │    ───────     │ │   ───────      │
│   Next.js      │ │   Express.js   │ │   Bull/Redis   │
│   React        │ │   REST API     │ │   ────────     │
│   SSR/SSG      │ │   ────────     │ │   • XML Parser │
│                │ │   /api/v1/*    │ │   • Email      │
│                │ │                │ │   • Analytics  │
└────────────────┘ └───────┬────────┘ └───────┬────────┘
                           │                   │
                           ▼                   ▼
              ┌────────────────────────────────────────┐
              │              DATA LAYER                │
              │  ┌──────────────┐  ┌──────────────┐   │
              │  │  PostgreSQL  │  │    Redis     │   │
              │  │  + PostGIS   │  │   (Cache +   │   │
              │  │              │  │    Queue)    │   │
              │  └──────────────┘  └──────────────┘   │
              └────────────────────────────────────────┘
                           │
                           ▼
              ┌────────────────────────────────────────┐
              │           EXTERNAL SERVICES            │
              │  ┌──────────┐ ┌──────────┐ ┌────────┐ │
              │  │  Yandex  │ │  Email   │ │ S3/CDN │ │
              │  │   Maps   │ │ (SMTP)   │ │(images)│ │
              │  └──────────┘ └──────────┘ └────────┘ │
              └────────────────────────────────────────┘
```

### 6.2 Компоненты системы

#### 6.2.1 Frontend (Next.js)

```typescript
// Структура проекта
frontend/
├── src/
│   ├── app/                    # Next.js App Router
│   │   ├── (main)/            # Основной layout
│   │   │   ├── page.tsx       # Главная (поиск)
│   │   │   ├── offers/
│   │   │   │   ├── page.tsx   # Результаты поиска
│   │   │   │   └── [id]/
│   │   │   │       └── page.tsx  # Карточка объекта
│   │   │   ├── complexes/
│   │   │   │   ├── page.tsx   # Список ЖК
│   │   │   │   └── [id]/
│   │   │   │       └── page.tsx  # Страница ЖК
│   │   │   ├── compare/       # Сравнение
│   │   │   ├── favorites/     # Избранное
│   │   │   └── account/       # Личный кабинет
│   │   ├── (auth)/            # Auth layout
│   │   │   ├── login/
│   │   │   └── register/
│   │   └── api/               # API routes (Next.js)
│   │
│   ├── components/
│   │   ├── ui/                # UI компоненты (Button, Input, etc.)
│   │   ├── features/          # Feature компоненты
│   │   │   ├── search/        # Поиск и фильтры
│   │   │   ├── offers/        # Карточки объектов
│   │   │   ├── map/           # Карта
│   │   │   └── compare/       # Сравнение
│   │   └── layout/            # Header, Footer, etc.
│   │
│   ├── hooks/                 # React hooks
│   ├── services/              # API client
│   ├── stores/                # Zustand stores
│   ├── types/                 # TypeScript типы
│   └── utils/                 # Утилиты
│
├── public/                    # Статические файлы
└── tests/                     # Тесты
```

#### 6.2.2 Backend (Node.js/Express)

```typescript
// Структура проекта
backend/
├── src/
│   ├── api/
│   │   ├── controllers/       # HTTP контроллеры
│   │   ├── routes/            # Роуты
│   │   ├── middleware/        # Middleware
│   │   ├── validators/        # Валидация запросов
│   │   └── dto/               # Data Transfer Objects
│   │
│   ├── services/              # Бизнес-логика
│   │   ├── offers.service.ts
│   │   ├── complexes.service.ts
│   │   ├── search.service.ts
│   │   ├── auth.service.ts
│   │   ├── leads.service.ts
│   │   └── analytics.service.ts
│   │
│   ├── models/                # Database models
│   ├── repositories/          # Data access layer
│   │
│   ├── jobs/                  # Background jobs
│   │   ├── import-feed.job.ts
│   │   ├── send-email.job.ts
│   │   └── update-stats.job.ts
│   │
│   ├── parsers/               # XML парсеры
│   │   ├── xml-feed.parser.ts
│   │   ├── validators/
│   │   └── normalizers/
│   │
│   ├── config/                # Конфигурация
│   ├── utils/                 # Утилиты
│   └── types/                 # TypeScript типы
│
├── migrations/                # Database migrations
├── seeds/                     # Seed data
└── tests/                     # Тесты
```

### 6.3 Паттерны и принципы

```
┌─────────────────────────────────────────────────────────────────┐
│                  АРХИТЕКТУРНЫЕ ПРИНЦИПЫ                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. SEPARATION OF CONCERNS                                      │
│     ├── Controllers: HTTP обработка                             │
│     ├── Services: Бизнес-логика                                 │
│     ├── Repositories: Доступ к данным                           │
│     └── Models: Структуры данных                                │
│                                                                 │
│  2. DEPENDENCY INJECTION                                        │
│     └── Все сервисы инжектируются через конструктор             │
│                                                                 │
│  3. STATELESS API                                               │
│     ├── Нет серверного состояния                                │
│     └── JWT для аутентификации                                  │
│                                                                 │
│  4. CQRS-LITE                                                   │
│     ├── Query: Оптимизированные запросы на чтение               │
│     └── Command: Транзакционные операции записи                 │
│                                                                 │
│  5. CACHE-ASIDE                                                 │
│     ├── Проверка кэша перед БД                                  │
│     └── Инвалидация при записи                                  │
│                                                                 │
│  6. CIRCUIT BREAKER (для внешних сервисов)                      │
│     └── Graceful degradation при недоступности                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7. Модель данных

### 7.1 ER-диаграмма (основные сущности)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           DATA MODEL                                    │
└─────────────────────────────────────────────────────────────────────────┘

┌──────────────┐       ┌──────────────┐       ┌──────────────┐
│  developers  │◄──────│   complexes  │───────►│  districts   │
│  ──────────  │  1:N  │  ──────────  │  N:1  │  ──────────  │
│  id          │       │  id          │       │  id          │
│  name        │       │  name        │       │  name        │
│  inn         │       │  developer_id│       │  region      │
│  website     │       │  district_id │       └──────────────┘
└──────────────┘       │  address     │
                       │  coordinates │       ┌──────────────┐
                       │  ...         │───────►│metro_stations│
                       └──────┬───────┘  N:1  │  ──────────  │
                              │               │  id          │
                              │ 1:N           │  name        │
                              ▼               │  line        │
                       ┌──────────────┐       │  coordinates │
                       │   buildings  │       └──────────────┘
                       │  ──────────  │
                       │  id          │
                       │  complex_id  │
                       │  name        │
                       │  building_type│
                       │  building_state│
                       │  floors_total │
                       │  built_year   │
                       └──────┬───────┘
                              │
                              │ 1:N
                              ▼
                       ┌──────────────┐       ┌──────────────┐
                       │    offers    │───────►│   images     │
                       │  ──────────  │  1:N  │  ──────────  │
                       │  id          │       │  id          │
                       │  complex_id  │       │  offer_id    │
                       │  building_id │       │  tag         │
                       │  rooms       │       │  url         │
                       │  area_total  │       └──────────────┘
                       │  price       │
                       │  floor       │       ┌──────────────┐
                       │  coordinates │───────►│ sales_agents │
                       │  ...         │  N:1  │  ──────────  │
                       └──────────────┘       │  id          │
                              │               │  phone       │
                              │               │  email       │
              ┌───────────────┼───────────────┐  organization│
              ▼               ▼               ▼  └──────────────┘
       ┌──────────────┐┌──────────────┐┌──────────────┐
       │  favorites   ││price_history ││    leads     │
       │  ──────────  ││ ────────────││  ──────────  │
       │  user_id     ││  offer_id   ││  offer_id    │
       │  offer_id    ││  price_old  ││  user_name   │
       │  notes       ││  price_new  ││  phone       │
       │  tags        ││  changed_at ││  email       │
       └──────────────┘└──────────────┘│  status     │
              ▲                         └──────────────┘
              │
       ┌──────────────┐
       │    users     │
       │  ──────────  │
       │  id          │
       │  email       │
       │  password    │
       │  role        │
       │  company     │
       └──────────────┘
```

### 7.2 Ключевые индексы для производительности

```sql
-- Поиск объявлений (основной use case)
CREATE INDEX idx_offers_search ON offers(
    is_active, rooms, district_id
) WHERE is_active = true;

-- Ценовой фильтр
CREATE INDEX idx_offers_price ON offers(price)
WHERE is_active = true;

-- Площадь
CREATE INDEX idx_offers_area ON offers(area_total)
WHERE is_active = true;

-- Геопоиск
CREATE INDEX idx_offers_geo ON offers
USING GIST(coordinates)
WHERE is_active = true;

-- Полнотекстовый поиск
CREATE INDEX idx_offers_fts ON offers
USING GIN(to_tsvector('russian', description));

-- Поиск по ЖК
CREATE INDEX idx_complexes_name_trgm ON complexes
USING GIN(name gin_trgm_ops);
```

---

## 8. API спецификация

### 8.1 Общие принципы

```yaml
# OpenAPI 3.0 спецификация

openapi: 3.0.0
info:
  title: Housler Pervichka API
  version: 1.0.0
  description: API агрегатора первичной недвижимости СПб

servers:
  - url: https://api.housler.ru/v1
    description: Production
  - url: https://api-staging.housler.ru/v1
    description: Staging

security:
  - bearerAuth: [] # JWT токен (опционально для публичных эндпоинтов)
```

### 8.2 Формат ответов

```typescript
// Успешный ответ
interface ApiResponse<T> {
  success: true;
  data: T;
  meta?: {
    pagination?: {
      total: number;
      page: number;
      per_page: number;
      total_pages: number;
    };
    cached?: boolean;
    generated_at?: string;
  };
}

// Ошибка
interface ApiError {
  success: false;
  error: {
    code: string; // VALIDATION_ERROR, NOT_FOUND, etc.
    message: string; // Человекочитаемое сообщение
    details?: object; // Детали ошибки
    request_id?: string; // ID запроса для отладки
  };
}
```

### 8.3 Основные эндпоинты

```yaml
# Публичные эндпоинты (без авторизации)
/offers:
  get:
    summary: Поиск объявлений
    parameters:
      - rooms[]         # Количество комнат
      - price_min/max   # Диапазон цены
      - area_min/max    # Диапазон площади
      - district[]      # Районы
      - metro[]         # Станции метро
      - building_state  # Состояние строительства
      - sort            # Сортировка
      - page, per_page  # Пагинация

/offers/{id}:
  get:
    summary: Детали объявления

/complexes:
  get:
    summary: Список ЖК

/complexes/{id}:
  get:
    summary: Детали ЖК

/filters:
  get:
    summary: Доступные значения фильтров

# Подборки (для клиентов по ссылке)
/selections/{code}:
  get:
    summary: Получить подборку по коду (публичный доступ)

/selections/{code}/offers:
  post:
    summary: Добавить объект в подборку (клиент)
  delete:
    summary: Удалить объект из подборки

/selections/{code}/comments:
  post:
    summary: Добавить комментарий к объекту

# Требует авторизации АГЕНТА
/agent/selections:
  get:
    summary: Список подборок агента
  post:
    summary: Создать подборку для клиента

/agent/selections/{id}:
  get:
    summary: Детали подборки
  put:
    summary: Обновить подборку
  delete:
    summary: Удалить подборку

/agent/bookings:
  get:
    summary: Список бронирований агента
  post:
    summary: Создать бронирование

/agent/bookings/{id}:
  get:
    summary: Детали бронирования

# Требует авторизации КЛИЕНТА (опционально)
/client/selections:
  get:
    summary: Все подборки клиента (от разных агентов)

/client/my-finds:
  get:
    summary: "Мои находки" — объекты, добавленные клиентом
  post:
    summary: Добавить в "Мои находки"

# Админ (оператор)
/admin/bookings:
  get:
    summary: Все бронирования

/admin/bookings/{id}:
  put:
    summary: Обновить статус бронирования

/admin/agents:
  get:
    summary: Список агентов

# Аналитика (авторизация + подписка)
/analytics/market-overview:
  get:
    summary: Обзор рынка

/analytics/districts/{name}:
  get:
    summary: Статистика по району
```

### 8.4 Rate Limiting

| Тип пользователя | Лимит         | Период   |
| ---------------- | ------------- | -------- |
| Анонимный        | 60 запросов   | 1 минута |
| Авторизованный   | 120 запросов  | 1 минута |
| Premium          | 600 запросов  | 1 минута |
| API (B2B)        | 6000 запросов | 1 минута |

---

## 9. Пользовательский интерфейс

### 9.1 Карта экранов

```
┌─────────────────────────────────────────────────────────────────┐
│                      SITE MAP                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ПУБЛИЧНЫЕ СТРАНИЦЫ                                            │
│  ─────────────────────                                          │
│  Главная (Поиск)                                               │
│  ├── Результаты поиска                                         │
│  │   └── Карточка объекта                                      │
│  │       ├── Галерея (модал)                                   │
│  │       └── [+ В подборку] (выбор подборки)                   │
│  │                                                              │
│  ├── Карта объектов                                            │
│  │                                                              │
│  ├── Список ЖК                                                 │
│  │   └── Страница ЖК                                           │
│  │       └── Квартиры в ЖК (фильтр)                            │
│  │                                                              │
│  └── Сравнение (временное, без сохранения)                     │
│                                                                 │
│  ПОДБОРКА ПО ССЫЛКЕ (публичный доступ)                         │
│  ─────────────────────────────────────                          │
│  /s/{код_подборки}                                              │
│  ├── Просмотр объектов подборки                                │
│  ├── [+ Добавить объект] → Поиск                               │
│  ├── [✓/✗] Отметки клиента                                     │
│  ├── Чат/комментарии к объектам                                │
│  └── [Войти для сохранения]                                    │
│                                                                 │
│  КАБИНЕТ АГЕНТА (auth: role=agent)                             │
│  ─────────────────────────────────                              │
│  /agent                                                         │
│  ├── Дашборд (статистика)                                      │
│  │   ├── Активные подборки                                     │
│  │   ├── Ожидающие бронирования                                │
│  │   └── Последняя активность клиентов                         │
│  │                                                              │
│  ├── Мои подборки                                              │
│  │   ├── Создать подборку                                      │
│  │   ├── Список подборок                                       │
│  │   │   └── Детали подборки                                   │
│  │   │       ├── Объекты в подборке                            │
│  │   │       ├── Комментарии клиента                           │
│  │   │       ├── [Забронировать объект]                        │
│  │   │       └── Поделиться ссылкой                            │
│  │   └── Архив подборок                                        │
│  │                                                              │
│  ├── Мои бронирования                                          │
│  │   ├── Новые (черновики)                                     │
│  │   ├── Отправленные                                          │
│  │   ├── Подтверждённые                                        │
│  │   └── Завершённые/Отклонённые                               │
│  │                                                              │
│  ├── Мои клиенты                                               │
│  │   └── История взаимодействий                                │
│  │                                                              │
│  └── Настройки профиля                                         │
│      ├── Данные агента                                         │
│      └── Подписка/тариф                                        │
│                                                                 │
│  КАБИНЕТ КЛИЕНТА (auth: role=client, опционально)              │
│  ────────────────────────────────────────────────               │
│  /client                                                        │
│  ├── Мои подборки (от всех агентов)                            │
│  │   └── Подборка от Агента X                                  │
│  │       ├── Объекты                                           │
│  │       └── [Связаться с агентом]                             │
│  │                                                              │
│  ├── Мои находки (самостоятельный поиск)                       │
│  │   └── [Добавить в подборку агента]                          │
│  │                                                              │
│  └── Настройки                                                 │
│      └── Email/телефон для связи                               │
│                                                                 │
│  ПАНЕЛЬ ОПЕРАТОРА (auth: role=operator)                        │
│  ──────────────────────────────────────                         │
│  /admin                                                         │
│  ├── Дашборд                                                   │
│  │   ├── Новые бронирования                                    │
│  │   ├── Статистика по агентам                                 │
│  │   └── Аналитика                                             │
│  │                                                              │
│  ├── Бронирования                                              │
│  │   ├── Входящие (на обработку)                               │
│  │   ├── В работе                                              │
│  │   ├── Отправлено застройщику                                │
│  │   └── Архив                                                 │
│  │                                                              │
│  ├── Агенты                                                    │
│  │   ├── Список агентов                                        │
│  │   ├── Заявки на регистрацию                                 │
│  │   └── Статистика по агентам                                 │
│  │                                                              │
│  ├── Фиды и объекты                                            │
│  │   ├── Источники фидов                                       │
│  │   ├── Статус импорта                                        │
│  │   └── Модерация объектов                                    │
│  │                                                              │
│  └── Настройки системы                                         │
│                                                                 │
│  AUTH                                                           │
│  ────                                                           │
│  ├── /login (вход)                                             │
│  ├── /register (регистрация агента)                            │
│  ├── /register/client (регистрация клиента, опц.)              │
│  └── /forgot-password                                          │
│                                                                 │
│  ПРОЧЕЕ                                                         │
│  ──────                                                         │
│  ├── О проекте                                                 │
│  ├── Для агентов (лендинг)                                     │
│  ├── Политика конфиденциальности                               │
│  └── Условия использования                                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 9.2 Wireframes ключевых экранов

#### 9.2.1 Главная страница (Desktop)

```
┌─────────────────────────────────────────────────────────────────────────┐
│  LOGO                  ЖК   Карта   Сравнение      [Войти] [Регистрация]│
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │   Найдите квартиру в новостройках Санкт-Петербурга                │ │
│  │                                                                    │ │
│  │   [Студия] [1]  [2]  [3]  [4+]     Цена от [______] до [______]   │ │
│  │                                                                    │ │
│  │   Район  [Выбрать ▼]     Метро [Выбрать ▼]     [🔍 Найти]         │ │
│  │                                                                    │ │
│  │   [Расширенные фильтры ▼]                                         │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  Найдено 12,020 квартир          Сортировка: [По цене ▼]  [⊞] [≡]    │
│  ─────────────────────────────────────────────────────────────────────│
│                                                                         │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐        │
│  │   [  ФОТО  ]    │  │   [  ФОТО  ]    │  │   [  ФОТО  ]    │        │
│  │   ──────────    │  │   ──────────    │  │   ──────────    │        │
│  │   20.3 млн ₽    │  │   15.1 млн ₽    │  │   8.5 млн ₽     │        │
│  │   306K ₽/м²     │  │   285K ₽/м²     │  │   242K ₽/м²     │        │
│  │                 │  │                 │  │                 │        │
│  │   2-комн, 66 м² │  │   1-комн, 53 м² │  │   Студия, 35 м² │        │
│  │   10/11 этаж    │  │   5/25 этаж     │  │   3/17 этаж     │        │
│  │   ЖК "NEXT"     │  │   ЖК "Новатория"│  │   ЖК "OKLA"     │        │
│  │   🚇 13 мин     │  │   🚇 8 мин      │  │   🚇 15 мин     │        │
│  │                 │  │                 │  │                 │        │
│  │   [+📋] [⚖️]    │  │   [+📋] [⚖️]    │  │   [+📋] [⚖️]    │        │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘        │
│                                                                         │
│  [1] [2] [3] ... [601] →                                               │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 9.2.2 Карточка объекта (Desktop)

```
┌─────────────────────────────────────────────────────────────────────────┐
│  LOGO                  ЖК   Карта   Сравнение      [Личный кабинет ▼]  │
├─────────────────────────────────────────────────────────────────────────┤
│  ← Назад к результатам                                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌────────────────────────────────────┐  ┌───────────────────────────┐ │
│  │                                    │  │  20 336 957 ₽             │ │
│  │                                    │  │  306 823 ₽/м²             │ │
│  │         [  ГЛАВНОЕ ФОТО  ]         │  │                           │ │
│  │                                    │  │  ┌───────────────────────┐│ │
│  │                                    │  │  │ [📞 Позвонить]        ││ │
│  │                                    │  │  │ +7 (981) 719-64-94    ││ │
│  │                                    │  │  └───────────────────────┘│ │
│  ├────────────────────────────────────┤  │                           │ │
│  │ [план] [фото] [этаж] [схема ЖК]   │  │  ┌───────────────────────┐│ │
│  └────────────────────────────────────┘  │  │ [📝 Записаться]       ││ │
│                                          │  │   на просмотр          ││ │
│  Характеристики                          │  └───────────────────────┘│ │
│  ─────────────────────                   │                           │ │
│  Комнат:         2                       │  Застройщик: Еврострой    │ │
│  Общая площадь:  66.3 м²                 │  Агентство: spb-invest    │ │
│  Жилая площадь:  38.58 м²                │                           │ │
│  Кухня:          12.33 м²                │  [+📋 В подборку]         │ │
│  Этаж:           10 из 11                │  [⚖️ Сравнить]             │ │
│  Отделка:        Под ключ                │  [↗️ Поделиться]           │ │
│  Балкон:         Нет                     │  [📄 Скачать PDF]         │ │
│  Санузел:        Совмещенный             │                           │ │
│                                          └───────────────────────────┘ │
│  О доме                                                                │
│  ──────                                                                │
│  ЖК:             NEXT (→ перейти)                                      │
│  Тип дома:       Монолитный                                            │
│  Корпус:         1                                                     │
│  Состояние:      Сдан (2020, Q3)                                       │
│  Лифт:           Есть                                                  │
│  Парковка:       Есть                                                  │
│                                                                         │
│  Расположение                                                          │
│  ───────────                                                           │
│  📍 Средний В.О. пр., д. 87/3/1, Василеостровский район                │
│  🚇 Горный Институт — 13 мин пешком                                    │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                    │ │
│  │                        [ ЯНДЕКС КАРТА ]                           │ │
│  │                                                                    │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  Описание                                                              │
│  ─────────                                                             │
│  Апартамент: 2 к 66,30 кв.м., 10 этаж в комплексе NEXT...             │
│  [Читать полностью ▼]                                                  │
│                                                                         │
│  Похожие объекты                                                       │
│  ───────────────                                                       │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐                      │
│  │ КАРТОЧКА │ │ КАРТОЧКА │ │ КАРТОЧКА │ │ КАРТОЧКА │                      │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 9.3 UI Kit (основные компоненты)

```
┌─────────────────────────────────────────────────────────────────┐
│                         UI KIT                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ЦВЕТОВАЯ ПАЛИТРА                                              │
│  ─────────────────                                             │
│  Primary:    #2563EB (синий)                                   │
│  Secondary:  #0891B2 (бирюзовый)                               │
│  Success:    #16A34A (зелёный)                                 │
│  Warning:    #D97706 (оранжевый)                               │
│  Error:      #DC2626 (красный)                                 │
│  Neutral:    #6B7280 (серый)                                   │
│  Background: #F9FAFB (светло-серый)                            │
│                                                                 │
│  ТИПОГРАФИКА                                                   │
│  ───────────                                                   │
│  Font:       Inter / SF Pro                                    │
│  H1:         32px / Bold                                       │
│  H2:         24px / SemiBold                                   │
│  H3:         20px / SemiBold                                   │
│  Body:       16px / Regular                                    │
│  Small:      14px / Regular                                    │
│  Caption:    12px / Regular                                    │
│                                                                 │
│  КОМПОНЕНТЫ                                                    │
│  ──────────                                                    │
│  • Button (primary, secondary, outline, ghost)                 │
│  • Input (text, number, select, multiselect)                   │
│  • Checkbox, Radio, Toggle                                     │
│  • Card, Modal, Drawer                                         │
│  • Tabs, Pagination                                            │
│  • Toast, Alert                                                │
│  • Skeleton (loading states)                                   │
│  • Empty state                                                 │
│                                                                 │
│  БРЕЙКПОИНТЫ                                                   │
│  ───────────                                                   │
│  Mobile:     < 640px                                           │
│  Tablet:     640px - 1024px                                    │
│  Desktop:    > 1024px                                          │
│  Wide:       > 1280px                                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 9.4 Wireframe: Страница подборки по ссылке

```
┌─────────────────────────────────────────────────────────────────────────┐
│  LOGO   Housler                                    [Войти] или [Клиент] │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Подборка от Ивана Петрова                      Создана: 28.11.2025    │
│  ───────────────────────────────────────────────────────────────────── │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  [🔍 Добавить объект в подборку]  — поиск по всей базе         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  Объекты в подборке (5)                         [⚖️ Сравнить все]      │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │  [ФОТО]  │  2-комн, 66 м², 10/11 эт     │  20.3 млн ₽            │ │
│  │          │  ЖК "NEXT", Василеостровский │  306K ₽/м²             │ │
│  │          │  🚇 Горный Институт, 13 мин  │                        │ │
│  │          │                               │  [✓ Нравится] [✗ Нет] │ │
│  │          │  💬 "Хороший вид, но далеко"  │  [💬 Комментарий]      │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │  [ФОТО]  │  1-комн, 45 м², 5/25 эт      │  12.5 млн ₽  ✓ ВЫБРАН │ │
│  │          │  ЖК "Новатория", Невский     │  278K ₽/м²             │ │
│  │          │  🚇 Проспект Большевиков     │                        │ │
│  │          │                               │  [✓ Нравится] [✗ Нет] │ │
│  │          │  💬 Агент: "Рекомендую!"      │  [💬 Комментарий]      │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │  [ФОТО]  │  Студия, 28 м², 3/17 эт      │  6.2 млн ₽   ✗ ОТКЛОН │ │
│  │          │  ЖК "OKLA", Приморский       │  221K ₽/м²             │ │
│  │          │  🚇 Комендантский проспект   │                        │ │
│  │          │                               │  [✓ Нравится] [✗ Нет] │ │
│  │          │  💬 "Слишком маленькая"       │  [💬 Комментарий]      │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  ─────────────────────────────────────────────────────────────────────  │
│  📞 Связаться с агентом: Иван Петров                                   │
│  Телефон: +7 (981) 123-45-67  |  Telegram: @ivan_realtor               │
│                                                                         │
│  [Войти чтобы сохранить свои отметки]                                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 9.5 Wireframe: Кабинет агента — Подборки

```
┌─────────────────────────────────────────────────────────────────────────┐
│  LOGO   Housler          [Поиск]  [ЖК]  [Карта]     👤 Иван Петров ▼   │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐                                                        │
│  │ 📊 Дашборд  │   МОИ ПОДБОРКИ                      [+ Новая подборка] │
│  ├─────────────┤   ─────────────────────────────────────────────────── │
│  │ 📋 Подборки │                                                        │
│  │   ← текущий │   Активные (8)    Архив (23)                          │
│  ├─────────────┤   ──────────────────────────────────────────────────── │
│  │ 📝 Брониро- │                                                        │
│  │    вания    │   ┌─────────────────────────────────────────────────┐ │
│  ├─────────────┤   │  Подборка для Марии С.                          │ │
│  │ 👥 Клиенты  │   │  ─────────────────────────────────────────────   │ │
│  ├─────────────┤   │  📧 maria@mail.ru  📱 +7 (911) 222-33-44         │ │
│  │ ⚙️ Настройки│   │  Объектов: 7  |  Отмечено ✓: 3  |  Отклонено: 2 │ │
│  └─────────────┘   │  Последняя активность: сегодня, 14:30            │ │
│                    │                                                   │ │
│                    │  [🔗 Ссылка] [📋 Открыть] [📝 Забронировать]      │ │
│                    └─────────────────────────────────────────────────┘ │
│                                                                         │
│                    ┌─────────────────────────────────────────────────┐ │
│                    │  Подборка для Алексея К.                  🔴 NEW │ │
│                    │  ─────────────────────────────────────────────   │ │
│                    │  📧 alex@gmail.com  📱 +7 (921) 333-44-55        │ │
│                    │  Объектов: 12  |  Клиент добавил: +3             │ │
│                    │  Последняя активность: сегодня, 09:15            │ │
│                    │                                                   │ │
│                    │  [🔗 Ссылка] [📋 Открыть] [📝 Забронировать]      │ │
│                    └─────────────────────────────────────────────────┘ │
│                                                                         │
│                    ┌─────────────────────────────────────────────────┐ │
│                    │  Подборка для Елены В.                   ⏳ ЖДЁТ │ │
│                    │  ─────────────────────────────────────────────   │ │
│                    │  📧 elena@yandex.ru                              │ │
│                    │  Объектов: 4  |  Нет активности 3 дня            │ │
│                    │                                                   │ │
│                    │  [🔗 Ссылка] [📋 Открыть] [📧 Напомнить]          │ │
│                    └─────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 9.6 Wireframe: Форма бронирования

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         БРОНИРОВАНИЕ ОБЪЕКТА                           │
│                              (модальное окно)                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Объект                                                                 │
│  ───────────────────────────────────────────────────────────────────── │
│  ┌─────────┐  2-комн, 66 м², 10/11 эт                                  │
│  │ [ФОТО]  │  ЖК "NEXT", Средний В.О. пр., д. 87/3/1                   │
│  │         │  20 336 957 ₽                                             │
│  └─────────┘  ID: SPB-2024-123456                                      │
│                                                                         │
│  Данные клиента                                                        │
│  ───────────────────────────────────────────────────────────────────── │
│  ФИО *              [Смирнова Мария Ивановна________________]          │
│  Телефон *          [+7 (911) 222-33-44_______________________]        │
│  Email              [maria@mail.ru____________________________]        │
│  Паспорт            [______ ____________] серия / номер               │
│  Дата рождения      [__.__.____]                                       │
│                                                                         │
│  Дополнительно                                                         │
│  ───────────────────────────────────────────────────────────────────── │
│  Способ оплаты      (•) Ипотека  ( ) 100% оплата  ( ) Рассрочка       │
│  Предв. одобрение   [x] Есть одобрение ипотеки                        │
│  Банк               [Сбербанк________________▼]                        │
│                                                                         │
│  Комментарий        [________________________________________]         │
│  для оператора      [________________________________________]         │
│                     [________________________________________]         │
│                                                                         │
│  ───────────────────────────────────────────────────────────────────── │
│  [x] Клиент согласен на обработку персональных данных                  │
│                                                                         │
│           [Отмена]                    [📝 Отправить бронь]             │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 9.7 Wireframe: Панель оператора — Бронирования

```
┌─────────────────────────────────────────────────────────────────────────┐
│  LOGO   Housler ADMIN                                  👤 Оператор ▼   │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐                                                        │
│  │ 📊 Дашборд  │   БРОНИРОВАНИЯ                                        │
│  ├─────────────┤   ─────────────────────────────────────────────────── │
│  │ 📝 Брониро- │                                                        │
│  │    вания ←  │   Новые (5)   В работе (3)   Застройщику (12)   Архив │
│  ├─────────────┤   ──────────────────────────────────────────────────── │
│  │ 👥 Агенты   │                                                        │
│  ├─────────────┤   ┌─────────────────────────────────────────────────┐ │
│  │ 📦 Фиды     │   │  🔴 #B-2024-0891          сегодня, 15:42        │ │
│  ├─────────────┤   │  ─────────────────────────────────────────────   │ │
│  │ ⚙️ Настройки│   │  Объект: 2-комн, ЖК "NEXT", 20.3 млн ₽          │ │
│  └─────────────┘   │  Клиент: Смирнова М.И., +7 911 222-33-44        │ │
│                    │  Агент: Петров Иван (ООО "Недвижимость СПб")     │ │
│                    │  Оплата: Ипотека (одобрение Сбербанк)            │ │
│                    │                                                   │ │
│                    │  [👁️ Подробнее] [✓ Взять в работу]               │ │
│                    └─────────────────────────────────────────────────┘ │
│                                                                         │
│                    ┌─────────────────────────────────────────────────┐ │
│                    │  🟡 #B-2024-0890          сегодня, 11:20        │ │
│                    │  ─────────────────────────────────────────────   │ │
│                    │  Объект: 1-комн, ЖК "Новатория", 12.5 млн ₽     │ │
│                    │  Клиент: Козлов А.А., +7 921 333-44-55          │ │
│                    │  Агент: Сидорова Анна                            │ │
│                    │  Оплата: 100%                                     │ │
│                    │                                                   │ │
│                    │  [👁️ Подробнее] [✓ Взять в работу]               │ │
│                    └─────────────────────────────────────────────────┘ │
│                                                                         │
│  ─────────────────────────────────────────────────────────────────────  │
│  📈 За сегодня: 5 новых | За неделю: 23 | Конверсия: 68%              │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 10. Безопасность

### 10.1 Аутентификация и авторизация

```
┌─────────────────────────────────────────────────────────────────┐
│                    AUTH FLOW                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  РЕГИСТРАЦИЯ                                                   │
│  ───────────                                                   │
│  1. Email + пароль (min 8 символов, буквы + цифры)            │
│  2. Подтверждение email (ссылка)                               │
│  3. Опционально: телефон + SMS код                             │
│                                                                 │
│  ВХОД                                                          │
│  ────                                                          │
│  1. Email + пароль                                             │
│  2. JWT токен (access: 15 мин, refresh: 7 дней)               │
│  3. Хранение: httpOnly cookie (refresh) + memory (access)     │
│                                                                 │
│  OAuth (Фаза 2)                                                │
│  ─────                                                         │
│  • Google                                                       │
│  • Яндекс                                                       │
│                                                                 │
│  РОЛИ                                                          │
│  ────                                                          │
│  • guest:      Просмотр объектов, поиск, доступ по ссылке     │
│  • client:     + Сохранение находок, просмотр своих подборок  │
│  • agent:      + Создание подборок, бронирование, клиенты     │
│  • agent_pro:  + Расширенная аналитика, экспорт, API доступ   │
│  • operator:   Полный доступ, управление бронированиями       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 10.2 Защита данных

| Угроза         | Защита                               |
| -------------- | ------------------------------------ |
| SQL Injection  | Параметризованные запросы, ORM       |
| XSS            | Экранирование вывода, CSP headers    |
| CSRF           | CSRF токены, SameSite cookies        |
| Brute Force    | Rate limiting, капча после 5 попыток |
| Утечка паролей | bcrypt (cost=12), HTTPS only         |
| Утечка PII     | Шифрование телефонов в БД (AES-256)  |

### 10.3 Compliance

```
GDPR / ФЗ-152:
├── Политика конфиденциальности (обязательно)
├── Согласие на обработку ПД (чекбокс)
├── Право на удаление данных
├── Право на выгрузку данных (export)
└── Логирование согласий
```

---

## 11. Интеграции

### 11.1 Яндекс Карты

```typescript
// MVP: Базовая интеграция
interface YandexMapsIntegration {
  // Отображение карты
  showMap(center: Coordinates, zoom: number): void;

  // Добавление маркера
  addMarker(coords: Coordinates, popup: string): void;

  // Кластеризация
  clusterMarkers(markers: Marker[]): void;

  // Геокодирование (адрес → координаты)
  geocode(address: string): Promise<Coordinates>;

  // Обратное геокодирование
  reverseGeocode(coords: Coordinates): Promise<Address>;
}

// Лимиты API
// Бесплатно: 25,000 запросов/день
// Коммерческий: от 45,000 ₽/год
```

### 11.2 Email (SMTP)

```typescript
// MVP: Transactional emails
interface EmailService {
  // Подтверждение регистрации
  sendVerification(email: string, token: string): Promise<void>;

  // Восстановление пароля
  sendPasswordReset(email: string, token: string): Promise<void>;

  // Уведомление о новом лиде (застройщику)
  sendLeadNotification(lead: Lead): Promise<void>;

  // Уведомление о новых объектах (пользователю)
  sendNewOffersDigest(user: User, offers: Offer[]): Promise<void>;
}

// Провайдеры: SendGrid, Mailgun, AWS SES
// Лимиты: ~100 писем/день бесплатно (SendGrid)
```

### 11.3 Будущие интеграции (Фаза 2+)

| Интеграция        | Назначение                    | Приоритет |
| ----------------- | ----------------------------- | --------- |
| Telegram Bot API  | Уведомления, поиск через бота | Фаза 2    |
| amoCRM / Bitrix24 | Интеграция для агентств       | Фаза 2    |
| ДомКлик / банки   | Ипотечный калькулятор         | Фаза 3    |
| ЦИАН API          | Расширение базы данных        | Фаза 3    |
| Яндекс Метрика    | Аналитика поведения           | MVP       |
| Sentry            | Мониторинг ошибок             | MVP       |

---

## 12. Мониторинг и аналитика

### 12.1 Технический мониторинг

```
┌─────────────────────────────────────────────────────────────────┐
│                    MONITORING STACK                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ИНФРАСТРУКТУРА                                                │
│  ──────────────                                                │
│  • Uptime:          Uptime Robot / Better Stack (free tier)    │
│  • Метрики:         Prometheus + Grafana (self-hosted)         │
│  • Логи:            Loki / CloudWatch (в зависимости от хоста) │
│  • Ошибки:          Sentry (free tier: 5K events/month)        │
│                                                                 │
│  АЛЕРТЫ                                                        │
│  ──────                                                        │
│  • API latency > 500ms (p95)                                   │
│  • Error rate > 1%                                             │
│  • Disk usage > 80%                                            │
│  • DB connections > 80%                                        │
│  • Import failed                                               │
│  • Uptime < 99%                                                │
│                                                                 │
│  ДАШБОРДЫ                                                      │
│  ────────                                                      │
│  • API: RPS, latency, errors по эндпоинтам                    │
│  • DB: queries/sec, slow queries, connections                  │
│  • Import: success rate, duration, records                     │
│  • Cache: hit rate, memory usage                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 12.2 Продуктовая аналитика

```
┌─────────────────────────────────────────────────────────────────┐
│                  PRODUCT ANALYTICS                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ИНСТРУМЕНТЫ                                                   │
│  ───────────                                                   │
│  • Яндекс Метрика (бесплатно, соответствует ФЗ-152)           │
│  • Внутренняя аналитика (таблица events)                       │
│                                                                 │
│  КЛЮЧЕВЫЕ МЕТРИКИ                                              │
│  ───────────────                                               │
│                                                                 │
│  Вовлечённость:                                                │
│  • DAU / MAU                                                   │
│  • Среднее время сессии                                        │
│  • Глубина просмотра (объектов за сессию)                     │
│  • Bounce rate                                                 │
│                                                                 │
│  Конверсии:                                                    │
│  • Поиск → Просмотр карточки                                  │
│  • Карточка → Добавление в избранное                          │
│  • Карточка → Заявка (лид)                                    │
│  • Посетитель → Регистрация                                   │
│  • Регистрация → Активный пользователь                        │
│                                                                 │
│  Лидогенерация:                                                │
│  • Количество лидов / день                                     │
│  • Конверсия посетитель → лид                                 │
│  • Стоимость лида (если есть реклама)                         │
│  • Качество лидов (feedback от застройщиков)                  │
│                                                                 │
│  Поиск:                                                        │
│  • Популярные фильтры                                          │
│  • Zero results rate                                           │
│  • Средняя позиция клика                                       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 12.3 Логирование

```typescript
// Структура лога
interface LogEntry {
  timestamp: string;        // ISO 8601
  level: 'debug' | 'info' | 'warn' | 'error';
  service: string;          // api, worker, parser
  action: string;           // search, view_offer, submit_lead
  user_id?: string;
  request_id: string;       // UUID для трассировки
  duration_ms?: number;
  metadata: object;         // Дополнительные данные
}

// Примеры
{
  "timestamp": "2025-11-29T10:30:00Z",
  "level": "info",
  "service": "api",
  "action": "search",
  "user_id": "u_123",
  "request_id": "req_abc123",
  "duration_ms": 145,
  "metadata": {
    "filters": {"rooms": [2], "district": "Василеостровский"},
    "results_count": 489
  }
}
```

---

## 13. Стратегия обновления данных

### 13.1 Источники и частота

```
┌─────────────────────────────────────────────────────────────────┐
│                 DATA UPDATE STRATEGY                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  XML FEED (Основной источник)                                  │
│  ────────────────────────────                                  │
│  URL:         Yandex Realty Feed (конфигурируемый)             │
│  Размер:      ~70 MB                                           │
│  Частота:     Каждые 4 часа (0:00, 4:00, 8:00, 12:00, 16:00, 20:00)│
│  Timeout:     10 минут                                         │
│                                                                 │
│  ЛОГИКА ОБНОВЛЕНИЯ                                             │
│  ─────────────────                                             │
│                                                                 │
│  1. Скачивание фида                                            │
│     ├── Проверка ETag / Last-Modified                          │
│     └── Если не изменился → skip                               │
│                                                                 │
│  2. Парсинг и валидация                                        │
│     ├── Streaming XML parser                                   │
│     ├── Валидация каждого offer (Zod schema)                  │
│     └── Логирование ошибок (не прерывать импорт)              │
│                                                                 │
│  3. Upsert логика                                              │
│     ├── По internal-id (уникальный ключ)                      │
│     ├── Сравнение last-update-date                            │
│     │   └── Если newer → update, иначе skip                   │
│     ├── Отслеживание изменения цены → price_history           │
│     └── Мягкое удаление (is_active = false) если нет в фиде   │
│                                                                 │
│  4. Пост-обработка                                             │
│     ├── Обновление статистики ЖК (min/max/avg)                │
│     ├── Обновление materialized views                          │
│     └── Инвалидация кэша                                       │
│                                                                 │
│  5. Отчёт                                                      │
│     ├── feed_import_logs: статус, количество, ошибки          │
│     └── Алерт если error_rate > 5%                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 13.2 Обработка конфликтов и ошибок

```typescript
// Стратегии разрешения конфликтов
enum ConflictResolution {
  LAST_WRITE_WINS,    // Последняя запись побеждает (по last-update-date)
  MERGE_FIELDS,       // Слияние непустых полей
  MANUAL_REVIEW,      // Флаг для ручной проверки
}

// Обработка ошибок
interface ImportErrorHandling {
  // Ошибки уровня записи (один offer)
  recordError: {
    action: 'log_and_continue';  // Не прерывать импорт
    log_level: 'warn';
    save_to: 'import_errors' table;
  };

  // Ошибки уровня фида (весь файл)
  feedError: {
    action: 'abort_and_alert';
    retry: {
      attempts: 3;
      delay: '5m';
    };
    alert: 'email + slack';
  };
}
```

### 13.3 Кэширование

```
┌─────────────────────────────────────────────────────────────────┐
│                    CACHE STRATEGY                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  REDIS CACHE                                                   │
│  ───────────                                                   │
│                                                                 │
│  Фильтры (справочники):                                        │
│  Key:     filters:districts, filters:metro, etc.              │
│  TTL:     24 часа                                              │
│  Инвалидация: После импорта                                   │
│                                                                 │
│  Результаты поиска:                                            │
│  Key:     search:{hash(filters)}                              │
│  TTL:     15 минут                                             │
│  Инвалидация: После импорта                                   │
│                                                                 │
│  Детали объекта:                                               │
│  Key:     offer:{id}                                          │
│  TTL:     1 час                                                │
│  Инвалидация: При обновлении записи                           │
│                                                                 │
│  Статистика ЖК:                                                │
│  Key:     complex:{id}:stats                                  │
│  TTL:     1 час                                                │
│  Инвалидация: После импорта                                   │
│                                                                 │
│  HTTP CACHE (CDN/Browser)                                      │
│  ────────────────────────                                      │
│  Static assets:     max-age=31536000 (1 год), immutable       │
│  API responses:     no-cache, must-revalidate                 │
│  Images (external): proxy through CDN, cache 7 days           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 14. Критерии приёмки

### 14.1 MVP Checklist

```
┌─────────────────────────────────────────────────────────────────┐
│                    MVP ACCEPTANCE CRITERIA                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ФУНКЦИОНАЛЬНЫЕ                                                │
│  ─────────────                                                 │
│  ☐ Импорт XML фида работает без ошибок                        │
│  ☐ Поиск по основным фильтрам (комнаты, цена, район)          │
│  ☐ Результаты отображаются в виде карточек                    │
│  ☐ Пагинация работает корректно                               │
│  ☐ Сортировка (цена, площадь, дата)                           │
│  ☐ Карточка объекта со всеми данными                          │
│  ☐ Галерея изображений (план, фото, этаж)                     │
│  ☐ Карта на странице объекта                                  │
│  ☐ Страница ЖК со списком квартир                             │
│  ☐ Регистрация и вход (email/пароль)                          │
│  ☐ Избранное (добавление/удаление)                            │
│  ☐ Сравнение объектов (до 5)                                  │
│  ☐ Форма заявки на просмотр                                   │
│  ☐ Карта со всеми объектами + кластеризация                   │
│  ☐ Адаптивный дизайн (mobile + desktop)                       │
│                                                                 │
│  ТЕХНИЧЕСКИЕ                                                   │
│  ──────────                                                    │
│  ☐ Время ответа API < 500ms (p95)                             │
│  ☐ Время загрузки страницы < 3s                               │
│  ☐ Импорт фида < 10 минут                                     │
│  ☐ 100% данных импортируется без ошибок                       │
│  ☐ Docker окружение запускается одной командой                │
│  ☐ API документация (Swagger)                                 │
│  ☐ Базовые тесты (unit + integration)                         │
│  ☐ Логирование всех ключевых операций                         │
│  ☐ HTTPS                                                       │
│  ☐ Rate limiting                                               │
│                                                                 │
│  БИЗНЕС                                                        │
│  ──────                                                        │
│  ☐ Форма заявки отправляет email застройщику                  │
│  ☐ Заявки сохраняются в БД                                    │
│  ☐ Политика конфиденциальности                                │
│  ☐ Согласие на обработку ПД                                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 14.2 Метрики качества

| Метрика                    | Порог           | Способ измерения |
| -------------------------- | --------------- | ---------------- |
| Тесты проходят             | 100%            | CI/CD pipeline   |
| Покрытие тестами (backend) | > 60%           | Jest coverage    |
| Lighthouse Performance     | > 70            | Lighthouse CI    |
| Lighthouse Accessibility   | > 80            | Lighthouse CI    |
| TypeScript strict mode     | 0 ошибок        | tsc --noEmit     |
| ESLint                     | 0 ошибок        | eslint           |
| Уязвимости (npm audit)     | 0 critical/high | npm audit        |

### 14.3 Тестовые сценарии

```gherkin
# E2E тесты (Playwright)

Сценарий: Поиск 2-комнатной квартиры
  Дано: Пользователь на главной странице
  Когда: Выбирает "2 комнаты"
  И: Устанавливает цену до 15 млн
  И: Нажимает "Найти"
  Тогда: Отображаются только 2-комнатные квартиры до 15 млн
  И: Количество результатов > 0

Сценарий: Добавление в избранное
  Дано: Авторизованный пользователь на карточке объекта
  Когда: Нажимает "В избранное"
  Тогда: Объект добавляется в избранное
  И: Счётчик избранного увеличивается

Сценарий: Отправка заявки
  Дано: Пользователь на карточке объекта
  Когда: Нажимает "Записаться на просмотр"
  И: Заполняет форму (имя, телефон)
  И: Соглашается с обработкой ПД
  И: Отправляет форму
  Тогда: Отображается сообщение об успехе
  И: Заявка сохраняется в БД
```

---

## 15. Риски и митигация

### 15.1 Технические риски

| Риск                       | Вероятность | Влияние     | Митигация                                          |
| -------------------------- | ----------- | ----------- | -------------------------------------------------- |
| Изменение формата XML фида | Средняя     | Высокое     | Версионирование парсера, алерты на ошибки парсинга |
| Недоступность фида         | Низкая      | Высокое     | Fallback на последний успешный импорт, кэш         |
| Некорректные данные в фиде | Высокая     | Среднее     | Валидация, логирование, ручная модерация           |
| Перегрузка БД              | Низкая      | Высокое     | Индексы, connection pooling, read replicas         |
| Утечка данных              | Низкая      | Критическое | Шифрование, auditing, pen-testing                  |

### 15.2 Бизнес-риски

| Риск                        | Вероятность | Влияние | Митигация                           |
| --------------------------- | ----------- | ------- | ----------------------------------- |
| Низкий трафик               | Средняя     | Высокое | SEO, контент-маркетинг, партнёрства |
| Конкуренция (ЦИАН/Авито)    | Высокая     | Среднее | Фокус на B2B нишу, уникальные фичи  |
| Отказ застройщиков от лидов | Средняя     | Высокое | Гарантия качества, CPA модель       |
| Зависимость от одного фида  | Высокая     | Высокое | Добавление других источников        |

### 15.3 Контингенси-план

```
Сценарий: Фид недоступен > 24 часов
Действия:
1. Алерт команде
2. Показ disclaimer "Данные от [дата]"
3. Контакт с поставщиком фида
4. Ручной сбор критичных обновлений

Сценарий: БД повреждена
Действия:
1. Восстановление из бэкапа (< 1 час)
2. Replay WAL логов
3. Полный реимпорт фида
4. Проверка целостности данных

Сценарий: Массовые ошибки импорта (> 10%)
Действия:
1. Остановка импорта
2. Анализ ошибок
3. Фикс парсера
4. Ручной запуск импорта
5. Верификация данных
```

---

## 16. Глоссарий

| Термин       | Определение                                  |
| ------------ | -------------------------------------------- |
| **Первичка** | Первичный рынок недвижимости (новостройки)   |
| **ЖК**       | Жилой комплекс                               |
| **Offer**    | Объявление о продаже квартиры                |
| **Complex**  | Жилой комплекс (группа корпусов)             |
| **Building** | Корпус (здание в составе ЖК)                 |
| **Фид**      | XML-файл с данными об объектах               |
| **Лид**      | Заявка от потенциального покупателя          |
| **Шахматка** | Визуальная схема квартир по этажам и секциям |
| **B2B**      | Business-to-Business (для бизнеса)           |
| **MVP**      | Minimum Viable Product                       |
| **SSR**      | Server-Side Rendering                        |
| **PostGIS**  | Расширение PostgreSQL для геоданных          |
| **JWT**      | JSON Web Token                               |

---

## Приложения

### A. Ссылки на документы

- [database_schema.sql](./database_schema.sql) — Схема базы данных
- [API_examples.md](./API_examples.md) — Примеры API запросов
- [MVP_ROADMAP.md](./MVP_ROADMAP.md) — Детальный план разработки MVP

### B. История изменений

| Версия | Дата       | Автор  | Изменения                                                                                                      |
| ------ | ---------- | ------ | -------------------------------------------------------------------------------------------------------------- |
| 1.0    | 2025-11-29 | -      | Первоначальная версия                                                                                          |
| 2.0    | 2025-11-29 | Claude | Расширенная версия с бизнес-контекстом, персонами, User Stories, UI спецификацией, безопасностью, мониторингом |

---

**Дата создания:** 2025-11-29
**Последнее обновление:** 2025-11-29
**Статус:** Draft — требует ревью заказчика
