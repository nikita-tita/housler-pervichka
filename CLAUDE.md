# Инструкция для Claude Code: Правила эффективной разработки

## КРИТИЧЕСКИ ВАЖНО: Читай перед каждым действием

### Золотое правило
**СНАЧАЛА ПРОЧИТАЙ — ПОТОМ РЕДАКТИРУЙ. НЕ НАОБОРОТ.**

Перед любым изменением кода:
1. Прочитай файл целиком (Read tool)
2. Пойми как он работает СЕЙЧАС
3. Найди КОНКРЕТНОЕ место для изменения
4. Измени ТОЛЬКО это место
5. Проверь что остальное НЕ сломалось

---

## Часть 1: Борьба с потерей контекста

### 1.1 Перед началом работы ВСЕГДА
```
□ Прочитать ВСЕ связанные файлы
□ Понять текущую архитектуру
□ Записать в память что где находится
□ Определить точки входа и зависимости
```

### 1.2 Используй TodoWrite для отслеживания
- Записывай КАЖДЫЙ шаг в todo
- Отмечай что уже сделано
- Это твоя "внешняя память" — используй её

### 1.3 Перед изменением файла
```
ОБЯЗАТЕЛЬНО:
1. git diff — посмотри что уже менялось
2. git log -5 --oneline — посмотри последние коммиты
3. Прочитай файл ПОЛНОСТЬЮ перед редактированием
```

### 1.4 Если потерял контекст
```
СТОП. Не угадывай. Сделай:
1. git status — что сейчас происходит
2. git diff — что изменено
3. git stash — если нужно откатиться
4. Прочитай файлы заново
```

---

## Часть 2: НЕ ПЕРЕПИСЫВАЙ — РЕДАКТИРУЙ

### 2.1 Принцип минимального вмешательства
```
ПЛОХО: Переписать функцию целиком "для улучшения"
ХОРОШО: Изменить только сломанную строку

ПЛОХО: Добавить 50 строк "на всякий случай"
ХОРОШО: Добавить 3 строки которые решают проблему

ПЛОХО: "Давай я перепишу это более правильно"
ХОРОШО: "Меняю строку 47: было X, стало Y"
```

### 2.2 Правило одного изменения
- ОДИН баг = ОДНО изменение
- ОДНА фича = минимум строк
- Не трогай код который работает
- Не "улучшай" попутно

### 2.3 Запрещено без явного запроса
- Рефакторинг работающего кода
- Добавление "улучшений"
- Изменение форматирования
- Добавление комментариев к чужому коду
- Переименование переменных
- "Оптимизация" которую не просили

### 2.4 Используй Edit, а не Write
```
ПЛОХО: Write — перезаписать файл целиком
ХОРОШО: Edit — изменить конкретные строки

Edit tool:
- old_string: точная строка которую меняем
- new_string: на что меняем
- Остальной файл НЕ ТРОГАЕМ
```

---

## Часть 3: Быстрый откат к рабочей версии

### 3.1 Перед любыми изменениями
```bash
# Создай точку восстановления
git add -A && git stash push -m "backup before changes"

# Или коммит
git add -A && git commit -m "wip: checkpoint before refactor"
```

### 3.2 Если что-то сломалось
```bash
# Вариант 1: Откатить незакоммиченные изменения
git checkout -- path/to/file.ts

# Вариант 2: Откатить к stash
git stash pop

# Вариант 3: Откатить к коммиту
git log --oneline -10  # найти рабочий коммит
git checkout abc123 -- path/to/file.ts

# Вариант 4: Посмотреть как было
git show HEAD~1:path/to/file.ts
```

### 3.3 Алгоритм отката
```
1. СТОП — прекрати ломать дальше
2. git diff — посмотри что изменилось
3. git log — найди последний рабочий коммит
4. git checkout <commit> -- <file> — верни файл
5. Проверь что работает
6. Начни заново с МЕНЬШИМИ изменениями
```

### 3.4 Правило трёх попыток
```
Попытка 1: Не работает
Попытка 2: Не работает
Попытка 3: Не работает

СТОП! Откатись к рабочей версии.
Прочитай код заново.
Пойми что происходит.
Попробуй ДРУГОЙ подход.
```

---

## Часть 4: Безопасность и секреты

### 4.1 НИКОГДА не коммитить
```
.env
.env.*
*.pem
*.key
*.p12
credentials.json
service-account.json
*_secret*
*_token*
```

### 4.2 .gitignore обязателен
```gitignore
# Секреты
.env
.env.*
*.pem
*.key
credentials.json
secrets/

# IDE
.idea/
.vscode/
*.swp

# Зависимости
node_modules/
venv/
__pycache__/

# Сборка
dist/
build/
*.log
```

### 4.3 Хранение секретов
```
Локально: .env.local (в .gitignore)
CI/CD: GitHub Secrets / GitLab Variables
Прод: Vault / AWS Secrets Manager / GCP Secret Manager
```

### 4.4 Пример .env.example
```env
# Скопируй в .env и заполни реальными значениями
API_KEY=your_api_key_here
DATABASE_URL=postgresql://user:pass@host:5432/db
SECRET_KEY=generate_random_string_here
```

---

## Часть 5: Git workflow

### 5.1 Структура веток
```
main            ← только рабочий код (защищена)
├── develop     ← интеграция фич
├── feature/*   ← новые фичи
├── bugfix/*    ← исправления багов
└── hotfix/*    ← срочные фиксы прода
```

### 5.2 Формат коммитов (Conventional Commits)
```
feat: добавить авторизацию через Google
fix: исправить падение при пустом ответе API
docs: обновить README
refactor: вынести валидацию в отдельный модуль
test: добавить тесты для UserService
chore: обновить зависимости
```

### 5.3 Правила коммитов
```
✓ Атомарные (одно изменение = один коммит)
✓ Осмысленные сообщения (что и зачем)
✓ Рабочий код (тесты проходят)

✗ "fix" без объяснения
✗ "wip" в main
✗ Смешивание фич и рефакторинга
```

### 5.4 Перед коммитом ВСЕГДА
```bash
# 1. Проверь что коммитишь
git status
git diff --staged

# 2. Запусти тесты
npm test  # или pytest, go test, etc.

# 3. Запусти линтер
npm run lint

# 4. Только потом коммить
git commit -m "feat: описание"
```

---

## Часть 6: Архитектура и структура

### 6.1 Стандартная структура проекта
```
project/
├── src/                 # Исходный код
│   ├── components/      # UI компоненты
│   ├── services/        # Бизнес-логика
│   ├── utils/           # Утилиты
│   ├── types/           # Типы/интерфейсы
│   ├── api/             # API клиенты
│   └── config/          # Конфигурация
├── tests/               # Тесты
├── scripts/             # Скрипты сборки
├── docs/                # Документация
├── .github/             # GitHub Actions
├── .env.example         # Пример переменных
├── .gitignore           # Игнорируемые файлы
├── CLAUDE.md            # Этот файл
└── README.md            # Описание проекта
```

### 6.2 Принципы архитектуры
```
SOLID:
- S: Один класс = одна ответственность
- O: Открыт для расширения, закрыт для изменения
- L: Подклассы заменяют родителей
- I: Маленькие специфичные интерфейсы
- D: Зависимость от абстракций

DRY: Не повторяйся
KISS: Делай проще
YAGNI: Не делай то что не нужно сейчас
```

### 6.3 Правила именования
```typescript
// Файлы
user-service.ts      // kebab-case для файлов
UserService.tsx      // PascalCase для React компонентов

// Код
const userName = ''           // camelCase для переменных
function getUserById() {}     // camelCase для функций
class UserService {}          // PascalCase для классов
const MAX_RETRIES = 3         // UPPER_SNAKE для констант
interface IUserService {}     // PascalCase + I для интерфейсов
type UserRole = 'admin'       // PascalCase для типов
```

---

## Часть 7: Тестирование

### 7.1 Когда писать тесты
```
✓ Новая бизнес-логика
✓ Исправление бага (сначала тест, потом фикс)
✓ Критичные пути (оплата, авторизация)
✓ Сложные алгоритмы

✗ Простые геттеры/сеттеры
✗ Прямые обёртки над библиотеками
✗ Конфигурационные файлы
```

### 7.2 Структура теста (AAA)
```typescript
test('должен вернуть пользователя по ID', () => {
  // Arrange — подготовка
  const userId = '123'
  const mockUser = { id: userId, name: 'Test' }

  // Act — действие
  const result = userService.getById(userId)

  // Assert — проверка
  expect(result).toEqual(mockUser)
})
```

### 7.3 Запуск тестов
```bash
# Перед коммитом
npm test

# С покрытием
npm test -- --coverage

# Конкретный файл
npm test -- user-service.test.ts
```

---

## Часть 8: Code Review чеклист

### 8.1 Перед отправкой PR проверь
```
□ Код работает локально
□ Тесты проходят
□ Линтер не ругается
□ Нет console.log / print для дебага
□ Нет закомментированного кода
□ Нет хардкода секретов
□ Понятные имена переменных
□ Нет дублирования кода
□ Обработаны edge cases
□ Нет N+1 запросов к БД
```

### 8.2 Безопасность
```
□ Нет SQL injection (используй параметризованные запросы)
□ Нет XSS (экранируй вывод)
□ Нет CSRF (токены в формах)
□ Валидация входных данных
□ Проверка прав доступа
```

### 8.3 Создание PR
```bash
# Формат PR
## Что сделано
- Добавлена фича X
- Исправлен баг Y

## Как тестировать
1. Запустить npm install
2. Открыть /page
3. Проверить что...

## Скриншоты (если UI)
[картинки]
```

---

## Часть 9: CI/CD

### 9.1 Пайплайн
```
Push → Lint → Test → Build → Deploy (staging) → Deploy (prod)
```

### 9.2 GitHub Actions пример
```yaml
name: CI
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm ci
      - run: npm run lint
      - run: npm test
      - run: npm run build
```

### 9.3 Environments
```
local     → разработка на машине
dev       → общий сервер разработки
staging   → копия прода для тестов
production → боевой сервер
```

---

## Часть 10: Алгоритм работы Claude Code

### 10.1 Получил задачу — сделай это:
```
1. ПОНЯТЬ задачу
   - Что именно нужно сделать?
   - Какой ожидаемый результат?
   - Есть ли ограничения?

2. ИССЛЕДОВАТЬ код
   - Прочитать связанные файлы
   - Понять текущую реализацию
   - Найти точку изменения

3. СПЛАНИРОВАТЬ
   - Записать шаги в TodoWrite
   - Определить минимальные изменения
   - Предупредить о рисках

4. РЕАЛИЗОВАТЬ
   - Менять ТОЛЬКО необходимое
   - Использовать Edit, не Write
   - Проверять после каждого шага

5. ПРОВЕРИТЬ
   - Запустить тесты
   - Проверить что старое работает
   - Убедиться что задача решена
```

### 10.2 Если что-то сломалось:
```
1. СТОП — не делай хуже
2. git diff — что изменилось
3. git checkout -- file — откатить файл
4. Прочитать код заново
5. Понять что пошло не так
6. Попробовать другой подход
```

### 10.3 Если не понимаешь код:
```
НЕ УГАДЫВАЙ.

Спроси пользователя:
- "Как должен работать этот модуль?"
- "Какое ожидаемое поведение?"
- "Есть ли документация?"

Или исследуй:
- Прочитай тесты (они показывают ожидаемое поведение)
- Прочитай git log (история изменений)
- Прочитай связанные файлы
```

### 10.4 Красные флаги — СТОП
```
⚠️ "Давай перепишем всё с нуля"
⚠️ "Добавлю несколько улучшений заодно"
⚠️ "Не уверен, но попробую"
⚠️ "Этот код плохой, сделаю лучше"
⚠️ Изменение больше 50 строк для простой задачи

Если видишь это — остановись и подумай.
Скорее всего, ты делаешь что-то неправильно.
```

---

## Часть 11: Чеклисты для типовых задач

### 11.1 Исправление бага
```
□ Воспроизвести баг
□ Найти место в коде
□ Понять причину
□ git stash (сохранить точку)
□ Написать тест который падает
□ Исправить МИНИМАЛЬНО
□ Тест проходит
□ Старые тесты проходят
□ Коммит с описанием бага
```

### 11.2 Новая фича
```
□ Понять требования
□ Найти где добавлять
□ Спланировать изменения
□ git checkout -b feature/name
□ Реализовать минимально
□ Добавить тесты
□ Проверить всё
□ PR с описанием
```

### 11.3 Рефакторинг (только по запросу!)
```
□ Убедиться что есть тесты
□ Все тесты зелёные
□ git stash (точка восстановления)
□ Маленькие изменения
□ Тесты после каждого шага
□ Не менять поведение
□ Коммит после каждого шага
```

---

## Часть 12: Запрещённые действия

### 12.1 НИКОГДА не делай без спроса
```
✗ git push --force
✗ git reset --hard
✗ Удаление файлов
✗ Изменение конфигов прода
✗ Изменение схемы БД
✗ Обновление зависимостей
✗ Рефакторинг "для красоты"
```

### 12.2 НИКОГДА не коммить
```
✗ Файлы с секретами
✗ node_modules / venv
✗ Файлы сборки (dist, build)
✗ Логи
✗ Временные файлы (.tmp, .swp)
✗ Системные файлы (.DS_Store)
```

### 12.3 НИКОГДА не игнорируй
```
✗ Ошибки линтера
✗ Падающие тесты
✗ Предупреждения компилятора
✗ Deprecated warnings
✗ Security warnings
```

---

## Быстрая справка: Команды

### Git
```bash
git status                    # состояние
git diff                      # изменения
git diff --staged             # что в коммите
git log --oneline -10         # история
git stash                     # спрятать изменения
git stash pop                 # достать изменения
git checkout -- file          # откатить файл
git checkout abc123 -- file   # файл из коммита
```

### Тесты
```bash
npm test                      # все тесты
npm test -- --watch           # следить за изменениями
npm test -- --coverage        # с покрытием
npm test -- file.test.ts      # конкретный файл
```

### Линтер
```bash
npm run lint                  # проверка
npm run lint -- --fix         # автоисправление
```

---

## Финальное напоминание

```
╔═══════════════════════════════════════════════════════════╗
║                                                           ║
║   1. ПРОЧИТАЙ код перед изменением                       ║
║   2. ИЗМЕНИ минимально                                    ║
║   3. ПРОВЕРЬ что работает                                 ║
║   4. ОТКАТИСЬ если сломал                                 ║
║                                                           ║
║   Лучше 3 строки которые работают,                       ║
║   чем 300 строк которые "правильнее"                     ║
║                                                           ║
╚═══════════════════════════════════════════════════════════╝
```
